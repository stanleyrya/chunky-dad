<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Calendar Test Lab - Chunky Dad</title>
    <style>
        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #a855f7;
            --border: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header .tagline {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .city-selector {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .city-selector h3 {
            margin-bottom: 15px;
            color: var(--accent-blue);
        }

        .city-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .city-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            text-align: center;
        }

        .city-btn:hover {
            background: var(--accent-blue);
            color: white;
            transform: translateY(-2px);
        }

        .city-btn.active {
            background: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
        }

        .city-btn.loading {
            background: var(--accent-yellow);
            color: var(--bg-primary);
            animation: pulse 2s infinite;
        }

        .city-btn.error {
            background: var(--accent-red);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .actions {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .actions h3 {
            margin-bottom: 15px;
            color: var(--accent-purple);
        }

        .action-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 12px 18px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
            font-size: 14px;
        }

        .action-btn:hover {
            background: var(--accent-purple);
            color: white;
            transform: translateY(-2px);
        }

        .action-btn.danger {
            border-color: var(--accent-red);
        }

        .action-btn.danger:hover {
            background: var(--accent-red);
        }

        .stats-banner {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 30px;
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-blue);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .panel {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .panel-header {
            background: var(--bg-secondary);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
        }

        .panel-content {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .raw-calendar {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-family: 'SF Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .event-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }

        .event-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .event-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--accent-green);
        }

        .event-type {
            background: var(--accent-blue);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .event-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            background: var(--bg-primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .detail-label {
            color: var(--text-secondary);
            font-weight: bold;
        }

        .detail-value {
            color: var(--text-primary);
            margin-left: 8px;
        }

        .raw-data {
            background: var(--bg-primary);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--border);
            font-family: 'SF Mono', monospace;
            font-size: 11px;
            line-height: 1.3;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .toggle-btn {
            background: var(--bg-primary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: var(--accent-blue);
            color: white;
        }

        .logs-panel {
            grid-column: 1 / -1;
            margin-top: 30px;
        }

        .log-container {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-family: 'SF Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px 8px;
            border-radius: 3px;
            border-left: 3px solid transparent;
        }

        .log-debug { 
            color: var(--text-secondary); 
            border-left-color: var(--text-secondary);
        }
        .log-info { 
            color: var(--accent-blue); 
            border-left-color: var(--accent-blue);
        }
        .log-warn { 
            color: var(--accent-yellow); 
            border-left-color: var(--accent-yellow);
        }
        .log-error { 
            color: var(--accent-red); 
            border-left-color: var(--accent-red);
        }

        .no-data {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px;
            font-style: italic;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-secondary);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .city-info {
            background: var(--bg-primary);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .calendar-meta {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .meta-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .meta-label {
            color: var(--text-secondary);
        }

        .meta-value {
            color: var(--text-primary);
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Calendar Test Lab</h1>
            <div class="tagline">Ridiculously useful calendar parsing debugger for all Chunky Dad cities</div>
        </div>

        <div class="control-panel">
            <div class="city-selector">
                <h3>🌍 Select City to Test</h3>
                <div class="city-grid" id="cityGrid">
                    <!-- Cities will be populated here -->
                </div>
            </div>

            <div class="actions">
                <h3>⚡ Actions</h3>
                <button class="action-btn" onclick="compareAllCities()">🔄 Compare All Cities</button>
                <button class="action-btn" onclick="exportResults()">💾 Export Results</button>
                <button class="action-btn" onclick="clearAll()">🧹 Clear All</button>
                <button class="action-btn danger" onclick="clearLogs()">🗑️ Clear Logs</button>
            </div>
        </div>

        <div class="stats-banner" id="statsBanner">
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated here -->
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <div class="panel-header">
                    📄 Raw Calendar Data
                    <span id="rawDataInfo" class="detail-value"></span>
                </div>
                <div class="panel-content">
                    <div class="city-info" id="cityInfo">
                        <div class="no-data">Select a city to view raw calendar data</div>
                    </div>
                    <div class="calendar-meta" id="calendarMeta" style="display: none;">
                        <!-- Calendar metadata will be shown here -->
                    </div>
                    <div class="raw-calendar" id="rawCalendar">
                        <div class="no-data">No calendar data loaded</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    🎯 Parsed Events
                    <span id="parsedDataInfo" class="detail-value"></span>
                </div>
                <div class="panel-content">
                    <div id="parsedEvents">
                        <div class="no-data">No events parsed yet</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel logs-panel">
            <div class="panel-header">
                📊 Debug Logs
                <span id="logInfo" class="detail-value"></span>
            </div>
            <div class="panel-content">
                <div class="log-container" id="logContainer">
                    <div class="log-entry log-info">🚀 Calendar Test Lab initialized. Ready to debug!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/logger.js"></script>
    <script src="js/city-config.js"></script>
    <script src="js/calendar-core.js"></script>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    <script src="js/navigation.js"></script>
    <script src="js/page-effects.js"></script>
    <script src="js/forms.js"></script>
    <script src="js/dynamic-calendar-loader.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        // Global state
        let currentCity = null;
        let currentCalendarData = null;
        let currentParsedEvents = [];
        let allCityResults = new Map();
        let logEntries = [];

        // Override logger to capture all logs
        const originalLog = logger.log;
        logger.log = function(level, component, message, data) {
            originalLog.call(this, level, component, message, data);
            
            const logEntry = {
                timestamp: new Date().toISOString(),
                level,
                component,
                message,
                data
            };
            
            logEntries.push(logEntry);
            displayLogEntry(logEntry);
            updateLogInfo();
        };

        function displayLogEntry(entry) {
            const logContainer = document.getElementById('logContainer');
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry log-${entry.level.toLowerCase()}`;
            
            let logText = `[${entry.timestamp.split('T')[1].split('.')[0]}] ${entry.component}: ${entry.message}`;
            if (entry.data && typeof entry.data === 'object') {
                logText += `\n${JSON.stringify(entry.data, null, 2)}`;
            }
            
            logDiv.textContent = logText;
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateLogInfo() {
            const logInfo = document.getElementById('logInfo');
            logInfo.textContent = `(${logEntries.length} entries)`;
        }

        // Initialize cities
        function initializeCities() {
            const cityGrid = document.getElementById('cityGrid');
            const cities = getAvailableCities();
            
            cities.forEach(city => {
                const btn = document.createElement('button');
                btn.className = 'city-btn';
                btn.innerHTML = `${city.emoji}<br>${city.name}`;
                btn.onclick = () => selectCity(city.key);
                btn.id = `city-${city.key}`;
                cityGrid.appendChild(btn);
            });
            
            logger.componentInit('TEST', 'Initialized city selector', { cityCount: cities.length });
        }

        async function selectCity(cityKey) {
            const cityConfig = getCityConfig(cityKey);
            if (!cityConfig) {
                logger.componentError('TEST', 'City config not found', { cityKey });
                return;
            }

            // Update UI
            document.querySelectorAll('.city-btn').forEach(btn => btn.classList.remove('active', 'loading', 'error'));
            const cityBtn = document.getElementById(`city-${cityKey}`);
            cityBtn.classList.add('loading');

            currentCity = cityKey;
            logger.userInteraction('TEST', `Selected city: ${cityConfig.name}`, { cityKey, calendarId: cityConfig.calendarId });

            // Update city info
            updateCityInfo(cityConfig);

            try {
                // Load calendar data
                const calendarCore = new CalendarCore();
                const icalData = await loadCalendarData(cityConfig.calendarId);
                currentCalendarData = icalData;
                
                // Parse events
                const events = calendarCore.parseICalData(icalData);
                currentParsedEvents = events;
                
                // Store results
                allCityResults.set(cityKey, {
                    config: cityConfig,
                    rawData: icalData,
                    events: events,
                    timestamp: new Date().toISOString()
                });

                // Update UI
                displayRawCalendar(icalData);
                displayParsedEvents(events);
                updateStats();
                
                cityBtn.classList.remove('loading');
                cityBtn.classList.add('active');
                
                logger.componentLoad('TEST', `Successfully loaded ${cityConfig.name}`, {
                    rawDataSize: icalData.length,
                    eventCount: events.length
                });

            } catch (error) {
                cityBtn.classList.remove('loading');
                cityBtn.classList.add('error');
                logger.componentError('TEST', `Failed to load ${cityConfig.name}`, error);
            }
        }

        function updateCityInfo(cityConfig) {
            const cityInfo = document.getElementById('cityInfo');
            cityInfo.innerHTML = `
                <div class="meta-item">
                    <span class="meta-label">City:</span>
                    <span class="meta-value">${cityConfig.emoji} ${cityConfig.name}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Tagline:</span>
                    <span class="meta-value">${cityConfig.tagline}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Calendar ID:</span>
                    <span class="meta-value">${cityConfig.calendarId}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Coordinates:</span>
                    <span class="meta-value">${cityConfig.coordinates.lat}, ${cityConfig.coordinates.lng}</span>
                </div>
            `;
        }

        async function loadCalendarData(calendarId) {
            logger.time('TEST', 'Calendar data loading');
            
            const icalUrl = `https://calendar.google.com/calendar/ical/${calendarId}/public/basic.ics`;
            
            try {
                const response = await fetch(icalUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const icalData = await response.text();
                logger.timeEnd('TEST', 'Calendar data loading');
                
                return icalData;
            } catch (error) {
                logger.timeEnd('TEST', 'Calendar data loading');
                throw error;
            }
        }

        function displayRawCalendar(icalData) {
            const rawCalendar = document.getElementById('rawCalendar');
            const rawDataInfo = document.getElementById('rawDataInfo');
            
            // Show metadata
            const calendarMeta = document.getElementById('calendarMeta');
            const metadata = extractCalendarMetadata(icalData);
            calendarMeta.innerHTML = `
                <div class="meta-item">
                    <span class="meta-label">Calendar Name:</span>
                    <span class="meta-value">${metadata.name || 'Unknown'}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Timezone:</span>
                    <span class="meta-value">${metadata.timezone || 'Unknown'}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Version:</span>
                    <span class="meta-value">${metadata.version || 'Unknown'}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">File Size:</span>
                    <span class="meta-value">${formatFileSize(icalData.length)}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Line Count:</span>
                    <span class="meta-value">${icalData.split('\n').length}</span>
                </div>
            `;
            calendarMeta.style.display = 'block';
            
            // Display full raw data
            rawCalendar.textContent = icalData;
            rawDataInfo.textContent = `(${formatFileSize(icalData.length)})`;
            
            logger.info('TEST', 'Raw calendar data displayed', {
                size: icalData.length,
                lines: icalData.split('\n').length
            });
        }

        function extractCalendarMetadata(icalData) {
            const metadata = {};
            
            const nameMatch = icalData.match(/X-WR-CALNAME:(.+)/);
            if (nameMatch) metadata.name = nameMatch[1].trim();
            
            const timezoneMatch = icalData.match(/X-WR-TIMEZONE:(.+)/);
            if (timezoneMatch) metadata.timezone = timezoneMatch[1].trim();
            
            const versionMatch = icalData.match(/VERSION:(.+)/);
            if (versionMatch) metadata.version = versionMatch[1].trim();
            
            return metadata;
        }

        function displayParsedEvents(events) {
            const parsedEvents = document.getElementById('parsedEvents');
            const parsedDataInfo = document.getElementById('parsedDataInfo');
            
            if (events.length === 0) {
                parsedEvents.innerHTML = '<div class="no-data">No events found in calendar</div>';
                parsedDataInfo.textContent = '(0 events)';
                return;
            }
            
            parsedDataInfo.textContent = `(${events.length} events)`;
            
            parsedEvents.innerHTML = events.map((event, index) => {
                const rawEvent = extractRawEventData(currentCalendarData, event.name);
                
                return `
                    <div class="event-card">
                        <div class="event-header">
                            <div class="event-title">${event.name}</div>
                            <div class="event-type">${event.eventType || 'routine'}</div>
                        </div>
                        
                        <div class="event-details">
                            <div class="detail-item">
                                <span class="detail-label">Day:</span>
                                <span class="detail-value">${event.day}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Time:</span>
                                <span class="detail-value">${event.time}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Venue:</span>
                                <span class="detail-value">${event.bar || 'TBD'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Cover:</span>
                                <span class="detail-value">${event.cover || 'TBD'}</span>
                            </div>
                            ${event.coordinates ? `
                                <div class="detail-item">
                                    <span class="detail-label">Coordinates:</span>
                                    <span class="detail-value">${event.coordinates.lat}, ${event.coordinates.lng}</span>
                                </div>
                            ` : ''}
                            ${event.tea ? `
                                <div class="detail-item">
                                    <span class="detail-label">Tea:</span>
                                    <span class="detail-value">${event.tea}</span>
                                </div>
                            ` : ''}
                            ${event.links ? `
                                <div class="detail-item">
                                    <span class="detail-label">Links:</span>
                                    <span class="detail-value">${event.links.length} found</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <button class="toggle-btn" onclick="toggleRawData(${index})">
                            👁️ Toggle Raw Data
                        </button>
                        
                        <div class="raw-data" id="rawData-${index}" style="display: none;">
${rawEvent}
                        </div>
                    </div>
                `;
            }).join('');
            
            logger.info('TEST', 'Parsed events displayed', { eventCount: events.length });
        }

        function extractRawEventData(icalData, eventName) {
            const lines = icalData.split('\n');
            let inEvent = false;
            let eventLines = [];
            let currentSummary = '';
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                
                // Handle line continuation
                while (i + 1 < lines.length && (lines[i + 1].startsWith(' ') || lines[i + 1].startsWith('\t'))) {
                    i++;
                    line += lines[i].substring(1);
                }
                
                line = line.replace(/\r$/, '');
                
                if (line === 'BEGIN:VEVENT') {
                    inEvent = true;
                    eventLines = [line];
                    currentSummary = '';
                } else if (line === 'END:VEVENT') {
                    eventLines.push(line);
                    if (currentSummary === eventName) {
                        return eventLines.join('\n');
                    }
                    inEvent = false;
                    eventLines = [];
                } else if (inEvent) {
                    eventLines.push(line);
                    if (line.startsWith('SUMMARY:')) {
                        currentSummary = line.substring(8).replace(/\\,/g, ',').replace(/\\;/g, ';');
                    }
                }
            }
            
            return 'Raw event data not found';
        }

        function toggleRawData(index) {
            const rawData = document.getElementById(`rawData-${index}`);
            rawData.style.display = rawData.style.display === 'none' ? 'block' : 'none';
        }

        function updateStats() {
            const statsBanner = document.getElementById('statsBanner');
            const statsGrid = document.getElementById('statsGrid');
            
            if (allCityResults.size === 0) {
                statsBanner.style.display = 'none';
                return;
            }
            
            let totalEvents = 0;
            let totalRecurring = 0;
            let totalCities = allCityResults.size;
            let totalCalendarSize = 0;
            
            allCityResults.forEach(result => {
                totalEvents += result.events.length;
                totalRecurring += result.events.filter(e => e.recurring).length;
                totalCalendarSize += result.rawData.length;
            });
            
            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${totalCities}</div>
                    <div class="stat-label">Cities Loaded</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${totalEvents}</div>
                    <div class="stat-label">Total Events</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${totalRecurring}</div>
                    <div class="stat-label">Recurring Events</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${formatFileSize(totalCalendarSize)}</div>
                    <div class="stat-label">Data Processed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${logEntries.length}</div>
                    <div class="stat-label">Log Entries</div>
                </div>
            `;
            
            statsBanner.style.display = 'block';
        }

        async function compareAllCities() {
            logger.info('TEST', 'Starting comparison of all cities');
            
            const cities = getAvailableCities();
            const results = [];
            
            for (const city of cities) {
                try {
                    await selectCity(city.key);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Brief delay
                    results.push({
                        city: city.name,
                        key: city.key,
                        success: true,
                        events: currentParsedEvents.length
                    });
                } catch (error) {
                    results.push({
                        city: city.name,
                        key: city.key,
                        success: false,
                        error: error.message
                    });
                }
            }
            
            logger.info('TEST', 'City comparison completed', { results });
            
            // Show comparison results
            alert(`City Comparison Results:\n\n${results.map(r => 
                `${r.city}: ${r.success ? `✅ ${r.events} events` : `❌ ${r.error}`}`
            ).join('\n')}`);
        }

        function exportResults() {
            const exportData = {
                timestamp: new Date().toISOString(),
                currentCity: currentCity,
                allResults: Array.from(allCityResults.entries()).map(([key, result]) => ({
                    city: key,
                    config: result.config,
                    eventCount: result.events.length,
                    events: result.events,
                    rawDataSize: result.rawData.length,
                    timestamp: result.timestamp
                })),
                logs: logEntries,
                totalStats: {
                    citiesLoaded: allCityResults.size,
                    totalEvents: Array.from(allCityResults.values()).reduce((sum, r) => sum + r.events.length, 0),
                    totalLogEntries: logEntries.length
                }
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `calendar-test-results-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            logger.info('TEST', 'Results exported', { filename: link.download });
        }

        function clearAll() {
            currentCity = null;
            currentCalendarData = null;
            currentParsedEvents = [];
            allCityResults.clear();
            
            document.querySelectorAll('.city-btn').forEach(btn => {
                btn.classList.remove('active', 'loading', 'error');
            });
            
            document.getElementById('cityInfo').innerHTML = '<div class="no-data">Select a city to view raw calendar data</div>';
            document.getElementById('calendarMeta').style.display = 'none';
            document.getElementById('rawCalendar').innerHTML = '<div class="no-data">No calendar data loaded</div>';
            document.getElementById('parsedEvents').innerHTML = '<div class="no-data">No events parsed yet</div>';
            document.getElementById('rawDataInfo').textContent = '';
            document.getElementById('parsedDataInfo').textContent = '';
            document.getElementById('statsBanner').style.display = 'none';
            
            logger.info('TEST', 'All data cleared');
        }

        function clearLogs() {
            logEntries = [];
            document.getElementById('logContainer').innerHTML = '<div class="log-entry log-info">🧹 Logs cleared</div>';
            updateLogInfo();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            logger.componentInit('TEST', 'Calendar Test Lab initialized');
            initializeCities();
        });
    </script>
</body>
</html>