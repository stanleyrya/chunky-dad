name: Sync Beta Branch to chunky-dad-beta

on:
  push:
    branches:
      - 'beta'
    paths-ignore:
      - '.github/workflows/sync-beta-to-external-repo.yml'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to sync (defaults to beta branch)'
        required: false
        default: 'beta'

jobs:
  sync-to-external-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout source branch (push event)
      if: github.event_name == 'push'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.ref }}
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Determine branch for workflow_dispatch
      if: github.event_name == 'workflow_dispatch'
      id: branch
      run: |
        if [ -n "${{ github.event.inputs.branch }}" ] && [ "${{ github.event.inputs.branch }}" != "" ]; then
          SOURCE_BRANCH="${{ github.event.inputs.branch }}"
        else
          SOURCE_BRANCH="beta"
        fi
        echo "branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
        echo "Source branch: $SOURCE_BRANCH"
    
    - name: Checkout source branch (workflow_dispatch)
      if: github.event_name == 'workflow_dispatch'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ steps.branch.outputs.branch }}
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Get current branch name
      id: current_branch
      run: |
        BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
        echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "Current branch: $BRANCH_NAME"
    
    - name: Configure git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Add external repository remote
      run: |
        git remote add external https://${{ secrets.BETA_REPO_TOKEN }}@github.com/${{ secrets.BETA_REPO_OWNER }}/chunky-dad-beta.git || true
        git remote set-url external https://${{ secrets.BETA_REPO_TOKEN }}@github.com/${{ secrets.BETA_REPO_OWNER }}/chunky-dad-beta.git
    
    - name: Create filtered branch excluding scripts and .github directories
      id: filtered_branch
      run: |
        SOURCE_BRANCH="${{ steps.current_branch.outputs.branch }}"
        FILTERED_BRANCH="${SOURCE_BRANCH}-filtered-$(date +%s)"
        
        # Create a new branch from the source branch
        git checkout -b "$FILTERED_BRANCH"
        
        # Remove scripts/ and .github/ directories from the index (if they exist)
        HAS_CHANGES=false
        
        # Check and remove scripts/ directory
        if git ls-files scripts/ | grep -q .; then
          git rm -r --cached scripts/ 2>/dev/null || true
          HAS_CHANGES=true
        fi
        
        # Check and remove .github/ directory
        if git ls-files .github/ | grep -q .; then
          git rm -r --cached .github/ 2>/dev/null || true
          HAS_CHANGES=true
        fi
        
        # Only commit if there are staged changes
        if [ "$HAS_CHANGES" = true ] && ! git diff --cached --quiet; then
          git commit -m "chore: exclude scripts and .github directories for external sync"
          echo "Removed scripts/ and .github/ directories from filtered branch"
        else
          echo "No changes to commit (directories already excluded or not present)"
        fi
        
        echo "filtered_branch=$FILTERED_BRANCH" >> $GITHUB_OUTPUT
        echo "Created filtered branch: $FILTERED_BRANCH"
    
    - name: Push filtered branch to external repository
      run: |
        SOURCE_BRANCH="${{ steps.current_branch.outputs.branch }}"
        FILTERED_BRANCH="${{ steps.filtered_branch.outputs.filtered_branch }}"
        
        echo "Syncing filtered branch: $FILTERED_BRANCH (excluding scripts/ and .github/)"
        
        # Fetch latest from external repo (for reference, but we'll overwrite)
        git fetch external main || echo "External repo main branch doesn't exist yet, will create it"
        
        # Always force push to overwrite any conflicts (they would be caused by a bug)
        echo "Force pushing filtered $SOURCE_BRANCH to external repository main branch..."
        git push external $FILTERED_BRANCH:main --force
        
        echo "âœ“ Successfully synced $SOURCE_BRANCH (excluding scripts/ and .github/) to chunky-dad-beta repository"
