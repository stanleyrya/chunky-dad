name: Sync Beta Branch to chunky-dad-beta

on:
  push:
    branches:
      - 'beta'
    paths-ignore:
      - '.github/workflows/sync-beta-to-external-repo.yml'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to sync (defaults to beta branch)'
        required: false
        default: 'beta'

jobs:
  sync-to-external-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # only read for the source repo, we use PAT for the target repo
    
    steps:
    - name: Checkout source branch
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.inputs.branch || 'beta' }}
        # ✅ Don't inject GITHUB_TOKEN — this prevents auth confusion
        token: ""
    
    - name: Configure git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global --unset credential.helper || true
        git config --local --unset credential.helper || true

    - name: Add external repository remote
      env:
        BETA_REPO_TOKEN: ${{ secrets.BETA_REPO_TOKEN }}
        BETA_REPO_OWNER: ${{ secrets.BETA_REPO_OWNER }}
      run: |
        git remote remove external 2>/dev/null || true
        git remote add external https://x-access-token:${BETA_REPO_TOKEN}@github.com/${BETA_REPO_OWNER}/chunky-dad-beta.git
        git remote -v

    - name: Create filtered branch excluding scripts and .github directories
      id: filtered_branch
      run: |
        SOURCE_BRANCH=$(git rev-parse --abbrev-ref HEAD)
        FILTERED_BRANCH="${SOURCE_BRANCH}-filtered-$(date +%s)"
        
        git checkout -b "$FILTERED_BRANCH"
        
        HAS_CHANGES=false
        if git ls-files scripts/ | grep -q .; then
          git rm -r --cached scripts/ || true
          HAS_CHANGES=true
        fi
        if git ls-files .github/ | grep -q .; then
          git rm -r --cached .github/ || true
          HAS_CHANGES=true
        fi
        
        if [ "$HAS_CHANGES" = true ] && ! git diff --cached --quiet; then
          git commit -m "chore: exclude scripts and .github directories for external sync"
        else
          echo "No changes to commit."
        fi
        
        echo "filtered_branch=$FILTERED_BRANCH" >> $GITHUB_OUTPUT

    - name: Push filtered branch to external repository
      env:
        BETA_REPO_TOKEN: ${{ secrets.BETA_REPO_TOKEN }}
      run: |
        FILTERED_BRANCH="${{ steps.filtered_branch.outputs.filtered_branch }}"
        echo "Force pushing filtered branch to external repo main..."
        
        git fetch external main || echo "External main doesn't exist yet"
        git push external "$FILTERED_BRANCH:main" --force
        
        echo "✓ Successfully synced to chunky-dad-beta repository"
