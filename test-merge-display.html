<!DOCTYPE html>
<html>
<head>
    <title>Test Merge Display</title>
    <style>
        .diff-view { padding: 10px; border: 1px solid #ccc; margin: 10px 0; }
        .hidden { display: none; }
        button { padding: 5px 10px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Test Merge Display Functions</h1>
    
    <!-- Test event with the problematic key -->
    <div class="event-card">
        <h3>GOLDILOXX</h3>
        <div style="margin-top: 15px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer;"
                 onclick="toggleComparisonSection('goldiloxx|2025-10-26|red eye ny &amp; the cockpit|redeyetickets')">
                <h4 style="margin: 0; font-size: 14px;">
                    <span id="expand-icon-goldiloxx_2025-10-26_red_eye_ny__amp__the_cockpit_redeyetickets" style="display: inline-block; width: 20px; transition: transform 0.2s;">
                        ‚ñ∂
                    </span>
                    üìä Merge Comparison
                    <span style="color: #ff9500; font-size: 12px; margin-left: 8px;">‚Ä¢ Has changes</span>
                </h4>
                <button onclick="event.stopPropagation(); toggleDiffView(this, 'goldiloxx|2025-10-26|red eye ny &amp; the cockpit|redeyetickets');" 
                        style="padding: 4px 10px; font-size: 11px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;"
                        id="diff-toggle-goldiloxx_2025-10-26_red_eye_ny__amp__the_cockpit_redeyetickets">
                    Switch to Line View
                </button>
            </div>
            
            <div id="comparison-content-goldiloxx_2025-10-26_red_eye_ny__amp__the_cockpit_redeyetickets" style="display: none;">
                <div style="margin-bottom: 10px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                        üìä <strong>Scraper:</strong> 22 fields |
                        üìÖ <strong>Calendar:</strong> 12 fields |
                        üîÄ <strong>Merged:</strong> 20 fields
                    </div>
                </div>
                
                <!-- Table view (default) -->
                <div id="table-view-goldiloxx_2025-10-26_red_eye_ny__amp__the_cockpit_redeyetickets" class="diff-view" style="display: block; padding: 10px;">
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #666;">
                            <strong>üìä Field-by-Field Comparison</strong>
                        </div>
                    </div>
                    <p>This is the table view content.</p>
                </div>
                
                <!-- Line view (hidden by default) -->
                <div id="line-view-goldiloxx_2025-10-26_red_eye_ny__amp__the_cockpit_redeyetickets" class="diff-view" style="display: none; padding: 10px;">
                    <div style="margin-bottom: 12px;">
                        <strong style="font-size: 12px; color: #666;">üìù Line-by-Line Diff</strong>
                    </div>
                    <p>This is the line view content.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleDiffView(button, eventKey) {
            console.log('toggleDiffView called with eventKey:', eventKey);
            
            // Convert eventKey to safe ID for DOM lookups - handle both escaped and unescaped keys
            let safeEventKey = eventKey;
            
            // If the key contains escaped characters, unescape them first
            if (eventKey.includes("\\'")) {
                safeEventKey = eventKey.replace(/\\'/g, "'");
            }
            
            // Decode HTML entities before creating safe ID
            safeEventKey = safeEventKey.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&#39;/g, "'");
            
            // Convert to safe DOM ID (same logic as in HTML generation)
            safeEventKey = safeEventKey.replace(/[^a-zA-Z0-9\-_]/g, '_');
            
            console.log('safeEventKey after processing:', safeEventKey);
            
            const tableView = document.getElementById('table-view-' + safeEventKey);
            const lineView = document.getElementById('line-view-' + safeEventKey);
            
            console.log('Found elements - tableView:', !!tableView, 'lineView:', !!lineView);
            
            // Fallback: if elements not found, try to find them by partial ID match
            if (!tableView || !lineView) {
                console.log('Elements not found, trying fallback search...');
                const allElements = document.querySelectorAll('[id*="' + safeEventKey + '"]');
                console.log('Found elements with partial match:', allElements.length);
                allElements.forEach(el => console.log('Element ID:', el.id));
            }
            
            // Check current state - table view is visible if display is not 'none'
            const isTableVisible = tableView && tableView.style.display !== 'none';
            
            if (isTableVisible) {
                // Switch to line view
                if (tableView) tableView.style.display = 'none';
                if (lineView) lineView.style.display = 'block';
                button.textContent = 'Switch to Table View';
            } else {
                // Switch to table view
                if (tableView) tableView.style.display = 'block';
                if (lineView) lineView.style.display = 'none';
                button.textContent = 'Switch to Line View';
            }
        }
        
        function toggleComparisonSection(eventId) {
            console.log('toggleComparisonSection called with eventId:', eventId);
            
            // Convert eventId to safe ID for DOM lookups - handle both escaped and unescaped keys
            let safeEventId = eventId;
            
            // If the key contains escaped characters, unescape them first
            if (eventId.includes("\\'")) {
                safeEventId = eventId.replace(/\\'/g, "'");
            }
            
            // Decode HTML entities before creating safe ID
            safeEventId = safeEventId.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&#39;/g, "'");
            
            // Convert to safe DOM ID (same logic as in HTML generation)
            safeEventId = safeEventId.replace(/[^a-zA-Z0-9\-_]/g, '_');
            
            console.log('safeEventId after processing:', safeEventId);
            
            const content = document.getElementById('comparison-content-' + safeEventId);
            const icon = document.getElementById('expand-icon-' + safeEventId);
            const diffToggle = document.getElementById('diff-toggle-' + safeEventId);
            
            console.log('Found elements - content:', !!content, 'icon:', !!icon, 'diffToggle:', !!diffToggle);
            
            // Fallback: if elements not found, try to find them by partial ID match
            if (!content || !icon) {
                console.log('Elements not found, trying fallback search...');
                const allElements = document.querySelectorAll('[id*="' + safeEventId + '"]');
                console.log('Found elements with partial match:', allElements.length);
                allElements.forEach(el => console.log('Element ID:', el.id));
            }
            
            if (content && content.style.display === 'none') {
                content.style.display = 'block';
                if (icon) icon.textContent = '‚ñº';
                if (diffToggle) diffToggle.style.display = 'block';
            } else {
                if (content) content.style.display = 'none';
                if (icon) icon.textContent = '‚ñ∂';
                if (diffToggle) diffToggle.style.display = 'none';
            }
        }
    </script>
</body>
</html>