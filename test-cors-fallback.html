<!DOCTYPE html>
<html>
<head>
    <title>Test CORS Fallback Timeout</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #f8d7da; }
        .success { background: #d4edda; }
        .warning { background: #fff3cd; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Test CORS Fallback Timeout</h1>
    <p>This test simulates what happens when local data fails and we fall back to CORS with a 25-second timeout.</p>
    <div id="logs"></div>

    <script>
        const logs = document.getElementById('logs');
        
        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<pre>[${new Date().toLocaleTimeString()}] ${message}</pre>`;
            logs.appendChild(div);
            console.log(message);
        }

        async function testCorsTimeout() {
            addLog('üöÄ Testing CORS fallback with 25-second timeout...');
            
            try {
                // Simulate the CORS fallback logic from dynamic-calendar-loader.js
                const icalUrl = 'https://calendar.google.com/calendar/ical/fake-calendar-id-that-will-fail/public/basic.ics';
                
                addLog(`üåê Attempting CORS request to: ${icalUrl}`);
                addLog('‚è±Ô∏è Timeout set to 25 seconds...');
                
                // Create AbortController for timeout - same as in the real code
                const controller = new AbortController();
                const startTime = Date.now();
                
                const timeoutId = setTimeout(() => {
                    const elapsed = Date.now() - startTime;
                    addLog(`‚è∞ Timeout triggered after ${elapsed}ms`, 'warning');
                    controller.abort();
                }, 25000); // 25 second timeout
                
                const response = await fetch(icalUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/calendar,text/plain,*/*'
                    },
                    cache: 'no-cache',
                    signal: controller.signal
                });
                
                // Clear timeout if request completes
                clearTimeout(timeoutId);
                const elapsed = Date.now() - startTime;
                
                if (response.ok) {
                    addLog(`‚úÖ Unexpected success! Response: ${response.status} in ${elapsed}ms`, 'success');
                } else {
                    addLog(`‚ùå Request failed: ${response.status} in ${elapsed}ms`, 'error');
                }
                
            } catch (error) {
                const elapsed = Date.now() - startTime;
                
                if (error.name === 'AbortError') {
                    addLog(`‚úÖ CORS request timed out after ${elapsed}ms (expected behavior)`, 'success');
                    addLog('üéØ The 25-second timeout is working correctly!', 'success');
                } else {
                    addLog(`‚úÖ CORS blocked after ${elapsed}ms: ${error.message} (expected behavior)`, 'success');
                    addLog('üéØ CORS blocking is working as expected!', 'success');
                }
            }
        }
        
        // Run the test
        testCorsTimeout();
    </script>
</body>
</html>