<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bear Event Scraper - Unified Architecture Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .header {
            background: #333;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        select, input, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #007cba;
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px 20px;
            font-weight: bold;
        }
        
        button:hover {
            background: #005a87;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .results {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffe6e6;
            border: 1px solid #ff9999;
            color: #cc0000;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .info-box {
            background: #e6f3ff;
            border: 1px solid #99ccff;
            color: #0066cc;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .architecture-diagram {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .flow-diagram {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        
        .flow-step {
            background: #f0f8ff;
            border: 2px solid #007cba;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            min-width: 150px;
            position: relative;
        }
        
        .flow-step::after {
            content: '‚Üí';
            position: absolute;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #007cba;
        }
        
        .flow-step:last-child::after {
            display: none;
        }
        
        .code-sample {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        @media (max-width: 768px) {
            .flow-diagram {
                flex-direction: column;
            }
            
            .flow-step::after {
                content: '‚Üì';
                right: 50%;
                top: 100%;
                transform: translateX(50%);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üêª Bear Event Scraper - Unified Architecture</h1>
        <p>Demonstrating modular Input ‚Üí Processing ‚Üí Display architecture that works in both Scriptable and web environments</p>
    </div>

    <div class="architecture-diagram">
        <h2>Architecture Overview</h2>
        <div class="flow-diagram">
            <div class="flow-step">
                <h3>Input</h3>
                <p>Fetch data from websites</p>
                <small>Different adapters for Scriptable vs Web</small>
            </div>
            <div class="flow-step">
                <h3>Processing</h3>
                <p>Parse & standardize events</p>
                <small>Same logic in both environments</small>
            </div>
            <div class="flow-step">
                <h3>Display</h3>
                <p>Show results</p>
                <small>Alerts in Scriptable, HTML in web</small>
            </div>
        </div>
        
        <div class="info-box">
            <strong>Key Benefits:</strong>
            <ul>
                <li><strong>Modular:</strong> Each component has a single responsibility</li>
                <li><strong>Testable:</strong> Can test processing logic without hitting real websites</li>
                <li><strong>Dual Environment:</strong> Same core logic works in Scriptable and web browsers</li>
                <li><strong>Extensible:</strong> Easy to add new websites by creating new parsers</li>
                <li><strong>Safe:</strong> Mock mode for testing, dry-run mode for safety</li>
            </ul>
        </div>
    </div>

    <div class="controls">
        <h2>Test Controls</h2>
        
        <div class="control-group">
            <label for="environment">Environment:</label>
            <select id="environment">
                <option value="web">Web (Current)</option>
                <option value="scriptable" disabled>Scriptable (Not Available)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="mockMode">Mode:</label>
            <select id="mockMode">
                <option value="true">Mock Mode (Safe Testing)</option>
                <option value="false">Live Mode (Real Websites)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="displayFormat">Display Format:</label>
            <select id="displayFormat">
                <option value="html">HTML Cards</option>
                <option value="table">Table View</option>
                <option value="json">Raw JSON</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="maxEvents">Max Events:</label>
            <input type="number" id="maxEvents" value="20" min="1" max="100">
        </div>
        
        <button id="runScraper" onclick="runTest()">Run Bear Event Scraper</button>
        <button id="clearResults" onclick="clearResults()">Clear Results</button>
    </div>

    <div id="results" class="results" style="display: none;"></div>

    <!-- Load the core modules -->
    <script src="../scripts/core/input-adapters.js"></script>
    <script src="../scripts/core/event-processor.js"></script>
    <script src="../scripts/core/display-adapters.js"></script>
    <script src="../scripts/bear-event-scraper-unified.js"></script>

    <script>
        let currentResults = null;

        async function runTest() {
            const runButton = document.getElementById('runScraper');
            const resultsDiv = document.getElementById('results');
            
            // Get configuration
            const mockMode = document.getElementById('mockMode').value === 'true';
            const displayFormat = document.getElementById('displayFormat').value;
            const maxEvents = parseInt(document.getElementById('maxEvents').value);
            
            // Disable button and show loading
            runButton.disabled = true;
            runButton.textContent = 'Running...';
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div class="loading">üêª Scraping bear events...</div>';
            
            try {
                console.log('Starting test with config:', { mockMode, displayFormat, maxEvents });
                
                // Create scraper with test configuration
                const scraper = new BearEventScraper({
                    mockMode: mockMode,
                    dryRun: true,
                    maxEvents: maxEvents,
                    displayFormat: displayFormat
                });
                
                // Define test sources
                const testSources = [
                    {
                        name: "Furball NYC",
                        parser: "furball",
                        url: "https://www.furball.nyc",
                        alwaysBear: true,
                        defaultCity: "nyc",
                        defaultVenue: "Various"
                    },
                    {
                        name: "Rockbar NYC",
                        parser: "rockbar", 
                        url: "https://www.rockbarnyc.com/calendar",
                        allowlist: ["rockstrap", "underbear", "bear happy hour"],
                        defaultCity: "nyc",
                        defaultVenue: "Rockbar"
                    },
                    {
                        name: "SF Eagle",
                        parser: "sf-eagle",
                        url: "https://www.sf-eagle.com/events",
                        allowlist: ["bear", "cub", "otter", "leather bears"],
                        defaultCity: "sf",
                        defaultVenue: "SF Eagle"
                    }
                ];
                
                // Run the scraper
                const results = await scraper.scrapeEvents(testSources);
                currentResults = results;
                
                // Display results using the display adapter
                const displayAdapter = DisplayAdapters.createDisplayAdapter();
                const displayResult = await displayAdapter.displayResults(results, {
                    format: displayFormat
                });
                
                // Show results in the page
                if (displayResult.element) {
                    resultsDiv.innerHTML = '';
                    resultsDiv.appendChild(displayResult.element);
                } else if (displayResult.text) {
                    resultsDiv.innerHTML = `<pre style="padding: 20px; white-space: pre-wrap;">${displayResult.text}</pre>`;
                }
                
                console.log('Test completed successfully:', results);
                
            } catch (error) {
                console.error('Test failed:', error);
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>Error</h3>
                        <p><strong>Message:</strong> ${error.message}</p>
                        <p><strong>Stack:</strong></p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            } finally {
                // Re-enable button
                runButton.disabled = false;
                runButton.textContent = 'Run Bear Event Scraper';
            }
        }
        
        function clearResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'none';
            resultsDiv.innerHTML = '';
            currentResults = null;
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Bear Event Scraper Test Page Loaded');
            console.log('Available modules:', {
                InputAdapters: typeof InputAdapters !== 'undefined',
                EventProcessor: typeof EventProcessor !== 'undefined', 
                DisplayAdapters: typeof DisplayAdapters !== 'undefined',
                BearEventScraper: typeof BearEventScraper !== 'undefined'
            });
            
            // Add some sample architecture explanation
            const architectureDiv = document.querySelector('.architecture-diagram');
            
            const codeExample = document.createElement('div');
            codeExample.innerHTML = `
                <h3>Code Structure Example</h3>
                <div class="code-sample">
// 1. Input - Fetch data (different for each environment)
const inputAdapter = createInputAdapter(); // Auto-detects environment
const rawData = await inputAdapter.fetchData(config);

// 2. Processing - Parse events (same logic everywhere)  
const processor = new EventProcessor();
const processedEvents = await processor.processEvents(rawData, parserConfig);

// 3. Display - Show results (different for each environment)
const displayAdapter = createDisplayAdapter(); // Auto-detects environment
await displayAdapter.displayResults(processedEvents, displayConfig);
                </div>
                
                <h3>Environment Detection</h3>
                <div class="code-sample">
// Automatically detects Scriptable vs Web environment
function detectEnvironment() {
    return typeof importModule !== 'undefined' ? 'scriptable' : 'web';
}

// Uses appropriate APIs for each environment
// Scriptable: Request class, Alert, FileManager
// Web: fetch API, DOM manipulation, localStorage
                </div>
            `;
            
            architectureDiv.appendChild(codeExample);
        });
    </script>
</body>
</html>