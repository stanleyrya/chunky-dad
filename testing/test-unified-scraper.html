<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bear Event Scraper - Unified Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .header {
            background: #333;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .controls label {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        
        .controls select, .controls input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
        }
        
        button:hover {
            background: #005a87;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .console-output {
            background: #1e1e1e;
            color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .results-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .html-output-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .html-output-container h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007cba;
            padding-bottom: 10px;
        }
        
        #htmlOutput {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            background: #fafafa;
            min-height: 200px;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #2196f3;
        }
        
        .log-entry {
            margin: 2px 0;
        }
        
        .log-entry.error {
            color: #ff6b6b;
        }
        
        .log-entry.success {
            color: #51cf66;
        }
        
        .log-entry.info {
            color: #64b5f6;
        }
        
        .log-entry.warn {
            color: #ffd93d;
        }
        
        /* Make the generated HTML display nicely */
        #htmlOutput .event-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        #htmlOutput .event-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #htmlOutput .stats-container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üêª Bear Event Scraper - Unified Test</h1>
        <p>Test the bear event scraper with live data and see the generated HTML output</p>
    </div>
    
    <div class="controls">
        <h3>Test Options</h3>
        <label>
            Source:
            <select id="sourceSelect">
                <option value="all">All Sources</option>
                <option value="furball">Furball NYC</option>
                <option value="rockbar">Rockbar NYC</option>
                <option value="bearracuda">Bearracuda</option>
                <option value="megawoof">Megawoof America</option>
                <option value="sf-eagle">SF Eagle</option>
                <option value="eagle-ny">Eagle NY</option>
                <option value="precinct">Precinct DTLA</option>
            </select>
        </label>
        
        <label>
            Days to Look Ahead:
            <input type="number" id="daysInput" value="" placeholder="All future events">
        </label>
        
        <label>
            <input type="checkbox" id="dryRunCheckbox" checked>
            Dry Run Mode (no calendar changes)
        </label>
        
        <br>
        
        <button onclick="runTest()" id="testBtn">Run Scraper Test</button>
        <button onclick="clearConsole()">Clear Console</button>
        <button onclick="testMockData()">Test with Mock Data</button>
    </div>
    
    <div class="console-output" id="console"></div>
    
    <div class="results-container" id="resultsContainer" style="display: none;">
        <h3>üìä Scraping Results</h3>
        <div id="results"></div>
    </div>
    
    <div class="html-output-container">
        <h2>üé® Generated HTML Output</h2>
        <div id="htmlOutput">
            <p style="color: #666; text-align: center;">Run the scraper to see the generated HTML output here...</p>
        </div>
    </div>
    
    <!-- Load the core modules -->
    <script src="../scripts/core/input-adapters.js"></script>
    <script src="../scripts/core/event-processor.js"></script>
    <script src="../scripts/core/display-adapters.js"></script>
    <script src="../scripts/bear-event-scraper-unified.js"></script>
    
    <script>
        // Custom console logging
        const consoleDiv = document.getElementById('console');
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };
        
        function addLogEntry(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            consoleDiv.appendChild(entry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            
            // Also log to real console
            originalConsole[type](message);
        }
        
        // Override console methods
        console.log = (message) => addLogEntry(message, 'info');
        console.error = (message) => addLogEntry(message, 'error');
        console.warn = (message) => addLogEntry(message, 'warn');
        console.info = (message) => addLogEntry(message, 'info');
        
        function clearConsole() {
            consoleDiv.innerHTML = '';
        }
        
        async function loadScraperConfig() {
            try {
                const response = await fetch('../scripts/scraper-input.json');
                if (!response.ok) {
                    throw new Error(`Failed to load config: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Failed to load scraper configuration: ${error.message}`);
                return null;
            }
        }
        
        async function runTest() {
            const testBtn = document.getElementById('testBtn');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsDiv = document.getElementById('results');
            const htmlOutput = document.getElementById('htmlOutput');
            
            testBtn.disabled = true;
            testBtn.textContent = 'Running Test...';
            resultsContainer.style.display = 'none';
            
            clearConsole();
            console.log('üêª Starting Bear Event Scraper Test');
            
            try {
                // Load configuration
                const configData = await loadScraperConfig();
                if (!configData) {
                    throw new Error('Failed to load scraper configuration');
                }
                
                // Get test options
                const sourceSelect = document.getElementById('sourceSelect').value;
                const daysInput = document.getElementById('daysInput').value;
                const dryRun = document.getElementById('dryRunCheckbox').checked;
                
                // Filter sources if specific one selected
                let sources = configData.parsers;
                if (sourceSelect !== 'all') {
                    sources = sources.filter(s => s.parser === sourceSelect);
                }
                
                // Create scraper config
                const config = {
                    dryRun: dryRun,
                    daysToLookAhead: daysInput ? parseInt(daysInput) : undefined
                };
                
                console.log(`Configuration: ${JSON.stringify(config)}`);
                console.log(`Testing ${sources.length} source(s)`);
                
                // Create and run scraper
                const scraper = new BearEventScraper(config);
                await scraper.initialize();
                
                const results = await scraper.scrapeEvents(sources);
                
                // Display results summary
                resultsContainer.style.display = 'block';
                resultsDiv.innerHTML = `
                    <div class="status ${results.success ? 'success' : 'error'}">
                        <strong>${results.success ? '‚úÖ Success' : '‚ùå Failed'}</strong>
                        <br>Total Events: ${results.events.length}
                        <br>Bear Events: ${results.bearEventCount}
                        <br>Sources: ${results.successfulSources}/${results.totalSources} successful
                        <br>Duplicates Removed: ${results.processingStats.duplicatesRemoved}
                        <br>Past Events Filtered: ${results.processingStats.pastEventsFiltered}
                    </div>
                `;
                
                // Display the generated HTML
                console.log('Generating HTML output...');
                const displayAdapter = DisplayAdapters.createDisplayAdapter();
                const displayResult = await displayAdapter.displayResults(results, { format: 'html' });
                
                if (displayResult.element) {
                    htmlOutput.innerHTML = '';
                    htmlOutput.appendChild(displayResult.element);
                    console.log('‚úÖ HTML output generated successfully');
                } else {
                    htmlOutput.innerHTML = '<p style="color: red;">Failed to generate HTML output</p>';
                }
                
            } catch (error) {
                console.error(`Test failed: ${error.message}`);
                resultsContainer.style.display = 'block';
                resultsDiv.innerHTML = `
                    <div class="status error">
                        <strong>‚ùå Test Failed</strong>
                        <br>Error: ${error.message}
                    </div>
                `;
                htmlOutput.innerHTML = '<p style="color: red;">Test failed - no output generated</p>';
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Run Scraper Test';
            }
        }
        
        async function testMockData() {
            const htmlOutput = document.getElementById('htmlOutput');
            
            console.log('üß™ Testing with mock data...');
            
            try {
                // Create mock results
                const mockResults = {
                    success: true,
                    events: [
                        {
                            title: 'Bear Night Out',
                            date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                            venue: 'Rockbar',
                            city: 'nyc',
                            description: 'Monthly bear gathering with drink specials',
                            isBearEvent: true,
                            source: 'Rockbar NYC',
                            url: 'https://example.com/event1'
                        },
                        {
                            title: 'Furball NYC',
                            date: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(),
                            venue: 'Terminal 5',
                            city: 'nyc',
                            description: 'The biggest bear dance party in NYC',
                            isBearEvent: true,
                            source: 'Furball NYC',
                            url: 'https://example.com/event2'
                        },
                        {
                            title: 'Bearracuda SF',
                            date: new Date(Date.now() + 21 * 24 * 60 * 60 * 1000).toISOString(),
                            venue: 'SF Eagle',
                            city: 'sf',
                            description: 'Bear dance party with go-go dancers',
                            isBearEvent: true,
                            source: 'Bearracuda',
                            url: 'https://example.com/event3'
                        }
                    ],
                    totalSources: 3,
                    successfulSources: 3,
                    bearEventCount: 3,
                    processingStats: {
                        totalEventsFound: 5,
                        duplicatesRemoved: 1,
                        pastEventsFiltered: 1,
                        finalEventCount: 3
                    },
                    comprehensiveStats: {
                        totalParsed: 5,
                        validEvents: 3,
                        bearEvents: 3,
                        processingSuccess: 100,
                        bearEventRate: 100
                    },
                    timestamp: new Date().toISOString()
                };
                
                // Generate HTML display
                const displayAdapter = DisplayAdapters.createDisplayAdapter();
                const displayResult = await displayAdapter.displayResults(mockResults, { format: 'html' });
                
                if (displayResult.element) {
                    htmlOutput.innerHTML = '';
                    htmlOutput.appendChild(displayResult.element);
                    console.log('‚úÖ Mock data HTML generated successfully');
                } else {
                    htmlOutput.innerHTML = '<p style="color: red;">Failed to generate HTML from mock data</p>';
                }
                
            } catch (error) {
                console.error(`Mock test failed: ${error.message}`);
                htmlOutput.innerHTML = '<p style="color: red;">Mock test failed</p>';
            }
        }
        
        // Run mock test on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded - Bear Event Scraper Test Ready');
            console.log('Available modules:', {
                InputAdapters: typeof InputAdapters !== 'undefined',
                EventProcessor: typeof EventProcessor !== 'undefined',
                DisplayAdapters: typeof DisplayAdapters !== 'undefined',
                BearEventScraper: typeof BearEventScraper !== 'undefined'
            });
        });
    </script>
</body>
</html>