<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Output Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-result {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .success {
            border-left: 4px solid #4CAF50;
        }
        
        .error {
            border-left: 4px solid #f44336;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üß™ Enhanced Output Test</h1>
    <p>This page tests the enhanced statistics output functionality.</p>
    
    <button onclick="runTest()" id="testBtn">Run Enhanced Output Test</button>
    
    <div id="results"></div>
    
    <!-- Load the core modules -->
    <script src="../scripts/core/input-adapters.js"></script>
    <script src="../scripts/core/event-processor.js"></script>
    <script src="../scripts/core/display-adapters.js"></script>
    <script src="../scripts/bear-event-scraper-unified.js"></script>
    
    <script>
        async function runTest() {
            const resultsDiv = document.getElementById('results');
            const testBtn = document.getElementById('testBtn');
            
            testBtn.disabled = true;
            testBtn.textContent = 'Running Test...';
            
            resultsDiv.innerHTML = '<div class="test-result">üîÑ Testing enhanced output...</div>';
            
            try {
                // Create a mock event processor to test statistics
                const processor = new EventProcessor();
                
                // Test statistics initialization
                let testResult = '<div class="test-result success">';
                testResult += '<h3>‚úÖ Statistics Initialization Test</h3>';
                testResult += '<p>EventProcessor statistics initialized successfully.</p>';
                testResult += '<pre>' + JSON.stringify(processor.getProcessingStatistics(), null, 2) + '</pre>';
                testResult += '</div>';
                
                // Test mock data processing
                const mockEvents = [
                    { title: 'Bear Night Out', date: new Date().toISOString(), venue: 'Test Venue', city: 'NYC', description: 'A bear event' },
                    { title: 'Regular Event', date: new Date().toISOString(), venue: 'Test Venue', city: 'NYC', description: 'Not a bear event' },
                    { title: 'Past Bear Event', date: new Date(Date.now() - 86400000).toISOString(), venue: 'Test Venue', city: 'NYC', description: 'Bear event in the past' }
                ];
                
                // Process mock events
                for (const eventData of mockEvents) {
                    const processedEvent = await processor.processEvent(eventData, { 
                        name: 'Test Source',
                        defaultCity: 'NYC',
                        defaultVenue: 'Test Venue'
                    });
                    
                    if (processedEvent) {
                        processor.analyzeEventStructure(processedEvent);
                        processor.updateDistributionStats(processedEvent);
                        processor.updateDateStats(processedEvent);
                        
                        if (processedEvent.isBearEvent) {
                            processor.trackBearKeywordMatches(eventData, {});
                        }
                        
                        if (!processor.isValidEvent(processedEvent)) {
                            processor.trackDiscardedEvent(processedEvent, 'Failed validation');
                        }
                    }
                }
                
                const finalStats = processor.getProcessingStatistics();
                
                testResult += '<div class="test-result success">';
                testResult += '<h3>‚úÖ Event Processing Test</h3>';
                testResult += '<p>Successfully processed mock events and generated statistics.</p>';
                testResult += '<pre>' + JSON.stringify(finalStats, null, 2) + '</pre>';
                testResult += '</div>';
                
                // Test display adapter
                const mockResults = {
                    events: [
                        { title: 'Test Bear Event', date: new Date().toISOString(), venue: 'Test Venue', city: 'NYC', isBearEvent: true, source: 'Test' }
                    ],
                    comprehensiveStats: finalStats,
                    successfulSources: 1,
                    totalSources: 1,
                    bearEventCount: 1,
                    processingStats: {
                        totalEventsFound: 3,
                        duplicatesRemoved: 0,
                        pastEventsFiltered: 1,
                        finalEventCount: 1
                    }
                };
                
                const displayAdapter = DisplayAdapters.createDisplayAdapter();
                const displayResult = await displayAdapter.displayResults(mockResults, { format: 'html' });
                
                testResult += '<div class="test-result success">';
                testResult += '<h3>‚úÖ Enhanced Display Test</h3>';
                testResult += '<p>Successfully generated enhanced HTML display with comprehensive statistics.</p>';
                testResult += '</div>';
                
                // Show the actual enhanced display
                testResult += '<div class="test-result">';
                testResult += '<h3>üìä Enhanced Display Output</h3>';
                testResult += '</div>';
                
                resultsDiv.innerHTML = testResult;
                resultsDiv.appendChild(displayResult.element);
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="test-result error">
                        <h3>‚ùå Test Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Run Enhanced Output Test';
            }
        }
        
        // Run test automatically on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced Output Test Page Loaded');
            console.log('Available modules:', {
                InputAdapters: typeof InputAdapters !== 'undefined',
                EventProcessor: typeof EventProcessor !== 'undefined', 
                DisplayAdapters: typeof DisplayAdapters !== 'undefined',
                BearEventScraper: typeof BearEventScraper !== 'undefined'
            });
        });
    </script>
</body>
</html>