<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Share Button - chunky.dad</title>
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 40px 0;
        }
        .test-info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-info h2 {
            margin-top: 0;
        }
        .test-info ul {
            margin: 10px 0;
        }
        .test-info code {
            background: #333;
            color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Share Button Test Page</h1>
    
    <div class="test-info">
        <h2>Test Instructions:</h2>
        <ul>
            <li>Click the "Share" button on any event card below</li>
            <li>On mobile devices with Web Share API support, you'll see native share options</li>
            <li>On desktop or browsers without Web Share API, the link will be copied to clipboard</li>
            <li>Open browser console (F12) to see logging output</li>
            <li>The shared URL will include <code>?event=EVENT_SLUG</code> parameter for deep linking</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>Sample Event Cards with Share Buttons</h2>
        <div class="events-list">
            <!-- Sample event cards will be inserted here -->
        </div>
    </div>
    
    <div class="test-section">
        <h2>Browser Compatibility:</h2>
        <div id="compatibility-info"></div>
    </div>

    <script src="../js/logger.js"></script>
    <script>
        // Enable debug logging
        logger.setDebugMode(true);
        
        // Check browser compatibility
        const compatInfo = document.getElementById('compatibility-info');
        const features = [];
        
        if (navigator.share) {
            features.push('‚úÖ Web Share API supported');
        } else {
            features.push('‚ùå Web Share API not supported (will use clipboard fallback)');
        }
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
            features.push('‚úÖ Modern Clipboard API supported');
        } else {
            features.push('‚ö†Ô∏è Modern Clipboard API not supported (will use legacy method)');
        }
        
        compatInfo.innerHTML = '<ul>' + features.map(f => `<li>${f}</li>`).join('') + '</ul>';
        
        // Create sample event cards
        const sampleEvents = [
            {
                slug: 'bear-happy-hour-sf',
                name: 'Bear Happy Hour',
                day: 'Friday',
                time: '5pm-9pm',
                bar: 'The Edge',
                recurring: true,
                cover: 'Free',
                links: ['https://example.com/event1']
            },
            {
                slug: 'underwear-party-nyc',
                name: 'Underwear Party',
                day: 'Saturday',
                time: '10pm-2am',
                bar: 'The Eagle NYC',
                recurring: false,
                cover: '$20',
                links: ['https://example.com/event2', 'https://tickets.com']
            },
            {
                slug: 'bear-brunch-la',
                name: 'Bear Brunch',
                day: 'Sunday',
                time: '11am-3pm',
                bar: 'Akbar',
                recurring: true,
                cover: 'No cover',
                tea: 'Join us for bottomless mimosas and good vibes!',
                links: []
            }
        ];
        
        // Generate event cards HTML
        function generateEventCard(event) {
            const recurringBadge = event.recurring ? 
                '<span class="recurring-badge" title="This event happens regularly">üîÑ Recurring</span>' : '';
            
            const coverHtml = event.cover ? 
                `<div class="event-info"><span class="info-label">üíµ Cover:</span> <span class="info-value">${event.cover}</span></div>` : '';
            
            const teaHtml = event.tea ? 
                `<div class="event-info tea"><span class="info-label">‚òï The Tea:</span> <span class="info-value">${event.tea}</span></div>` : '';
            
            const linksHtml = event.links.map((link, index) => 
                `<a href="${link}" target="_blank" rel="noopener noreferrer" class="event-link">üîó Link ${index + 1}</a>`
            ).join('');
            
            const locationHtml = `<div class="event-info"><span class="info-label">üìç Location:</span> <span class="info-value">${event.bar}</span></div>`;
            
            return `
                <div class="event-card detailed" data-event-slug="${event.slug}">
                    <div class="event-header">
                        <h3>${event.name}</h3>
                        <div class="event-meta">
                            <div class="event-day">${event.day} ${event.time}</div>
                            ${recurringBadge}
                        </div>
                    </div>
                    <div class="event-details">
                        ${locationHtml}
                        ${coverHtml}
                        ${teaHtml}
                        <div class="event-links">
                            ${linksHtml}
                            <button class="share-event-btn" 
                                    data-event-slug="${event.slug}" 
                                    data-event-name="${event.name}" 
                                    data-event-venue="${event.bar}" 
                                    data-event-time="${event.day} ${event.time}" 
                                    title="Share this event">
                                <span class="share-icon">üì§</span> Share
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Render event cards
        const eventsList = document.querySelector('.events-list');
        eventsList.innerHTML = sampleEvents.map(event => generateEventCard(event)).join('');
        
        // Setup share button handlers (copied from dynamic-calendar-loader.js)
        function setupShareButtons() {
            const shareButtons = document.querySelectorAll('.share-event-btn');
            
            shareButtons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    
                    const eventSlug = button.dataset.eventSlug;
                    const eventName = button.dataset.eventName;
                    const eventVenue = button.dataset.eventVenue;
                    const eventTime = button.dataset.eventTime;
                    
                    // Build the share URL with the event slug
                    const baseUrl = window.location.origin + '/city.html';
                    const shareUrl = `${baseUrl}?event=${eventSlug}`;
                    
                    // Build share text
                    const shareTitle = `${eventName}`;
                    const shareText = `Check out ${eventName} at ${eventVenue} - ${eventTime}`;
                    
                    logger.userInteraction('EVENT', 'Share button clicked', {
                        eventSlug,
                        eventName,
                        shareUrl
                    });
                    
                    // Try to use Web Share API if available
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: shareTitle,
                                text: shareText,
                                url: shareUrl
                            });
                            logger.info('EVENT', 'Event shared successfully via Web Share API', {
                                eventSlug,
                                eventName
                            });
                            showShareToast('Event shared successfully! üéâ');
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                logger.warn('EVENT', 'Web Share API failed', err);
                                fallbackShare(shareUrl, shareText);
                            } else {
                                logger.debug('EVENT', 'User cancelled share');
                            }
                        }
                    } else {
                        fallbackShare(shareUrl, shareText);
                    }
                });
            });
            
            logger.debug('EVENT', `Set up ${shareButtons.length} share button handlers`);
        }
        
        // Fallback share method
        function fallbackShare(url, text) {
            const shareContent = `${text}\n${url}`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareContent)
                    .then(() => {
                        showShareToast('Link copied to clipboard! üìã');
                        logger.info('EVENT', 'Event URL copied to clipboard via Clipboard API');
                    })
                    .catch(err => {
                        logger.error('EVENT', 'Clipboard API failed', err);
                        legacyClipboardCopy(shareContent);
                    });
            } else {
                legacyClipboardCopy(shareContent);
            }
        }
        
        // Legacy clipboard copy
        function legacyClipboardCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            textArea.style.padding = '0';
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            textArea.style.background = 'transparent';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showShareToast('Link copied to clipboard! üìã');
                    logger.info('EVENT', 'Event URL copied to clipboard via legacy method');
                } else {
                    showShareToast('Failed to copy link');
                    logger.error('EVENT', 'Legacy clipboard copy failed');
                }
            } catch (err) {
                showShareToast('Failed to copy link');
                logger.error('EVENT', 'Legacy clipboard copy error', err);
            }
            
            document.body.removeChild(textArea);
        }
        
        // Toast notification
        function showShareToast(message) {
            const existingToast = document.querySelector('.share-toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'share-toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--primary-color, #8B4513);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideUp 0.3s ease-out;
                font-family: 'Poppins', sans-serif;
            `;
            
            if (!document.querySelector('#share-toast-animations')) {
                const style = document.createElement('style');
                style.id = 'share-toast-animations';
                style.textContent = `
                    @keyframes slideUp {
                        from {
                            transform: translateX(-50%) translateY(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(-50%) translateY(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Initialize share buttons
        setupShareButtons();
        
        logger.componentInit('TEST', 'Share button test page initialized');
    </script>
</body>
</html>