<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="toolbox-icon" content="üìä">
    <meta name="toolbox-description" content="Sheet Metal Worker - Loads and shapes Google Sheets data">
    <title>üìä chunky.dad's Toolbox - Sheet Metal Worker</title>
    <meta name="description" content="Loads and shapes Google Sheets data - chunky.dad's toolbox">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YKQBFFQR5E"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-YKQBFFQR5E');
    </script>
    <link rel="icon" type="image/png" href="../Rising_Star_Ryan_Head_Compressed.png">
    <link rel="apple-touch-icon" href="../Rising_Star_Ryan_Head_Compressed.png">
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Permanent+Marker&family=Roboto+Condensed:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <!-- Logger -->
    <script src="../js/logger.js"></script>
    <style>
        /* Testing-specific styles */
        body {
            background: #0a0a0a;
            color: #e0e0e0;
        }
        
        .test-panel {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #333;
            color: #e0e0e0;
        }
        
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .test-title {
            color: #FFA500;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .test-btn {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .test-btn:hover {
            background: #444;
            border-color: #FFA500;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 165, 0, 0.3);
        }
        
        .test-btn.active {
            background: #FFA500;
            color: #000;
            border-color: #FFA500;
        }
        
        .test-btn.danger {
            background: #dc2626;
            border-color: #dc2626;
        }
        
        .test-btn.danger:hover {
            background: #ef4444;
            border-color: #ef4444;
        }
        
        .test-btn.success {
            background: #10b981;
            border-color: #10b981;
        }
        
        .test-btn.success:hover {
            background: #34d399;
            border-color: #34d399;
        }
        
        .data-viewer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        /* Instagram embed styles */
        .instagram-embed-wrapper {
            position: relative;
            background: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .instagram-embed-container {
            width: 100%;
            min-height: 400px;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .instagram-embed-container::before {
            content: "Loading Instagram...";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 0.9rem;
            z-index: 1;
        }
        
        .instagram-embed-container.loaded::before {
            display: none;
        }
        
        .instagram-embed-container.error::before {
            content: "Failed to load Instagram";
            color: #ff6b6b;
        }
        
        .instagram-embed-container iframe {
            width: 100% !important;
            height: auto !important;
            min-height: 400px;
            background: white;
            border: none;
            position: relative;
            z-index: 2;
        }
        
        .instagram-embed-container .instagram-media {
            margin: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            background: white !important;
            min-width: 326px !important;
        }
        
        /* Instagram specific iframe fixes */
        .instagram-embed-container blockquote.instagram-media {
            background: white !important;
            border: 0 !important;
            border-radius: 3px !important;
            box-shadow: 0 0 1px 0 rgba(0,0,0,0.5), 0 1px 10px 0 rgba(0,0,0,0.15) !important;
            margin: 1px !important;
            max-width: 540px !important;
            min-width: 326px !important;
            padding: 0 !important;
            width: calc(100% - 2px) !important;
        }
        
        .data-column {
            background: #0d0d0d;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .data-column h3 {
            color: #FFA500;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .raw-data, .processed-data {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #000;
            border-radius: 4px;
            border: 1px solid #222;
        }
        
        .log-viewer {
            background: #000;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
        }
        
        .log-entry.info {
            color: #60a5fa;
        }
        
        .log-entry.success {
            color: #34d399;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .log-entry.warning {
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }
        
        .log-entry.error {
            color: #f87171;
            background: rgba(248, 113, 113, 0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #0d0d0d;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #FFA500;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #999;
        }
        
        .test-status {
            padding: 10px 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
        }
        
        .test-status.loading {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }
        
        .test-status.success {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid #34d399;
        }
        
        .test-status.error {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
            border: 1px solid #f87171;
        }
        
        .sheet-url-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #0d0d0d;
            border: 1px solid #333;
            color: #e0e0e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .sheet-url-input:focus {
            outline: none;
            border-color: #FFA500;
        }
        
        .test-map {
            height: 400px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #333;
        }
        
        @media (max-width: 768px) {
            .data-viewer {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="nav-container">
                <div class="logo">
                    <h1><a href="../index.html"><img src="../Rising_Star_Ryan_Head_Compressed.png" alt="chunky.dad logo" class="logo-img"> chunky.dad</a></h1>
                </div>
                <ul class="nav-menu">
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="index.html">Tests</a></li>
                    <li><a href="../bear-directory.html">Directory</a></li>
                </ul>
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <div class="container">
            <h2 style="color: #FFA500; text-align: center; margin: 2rem 0;">
                <img src="../Rising_Star_Ryan_Head_Compressed.png" alt="chunky.dad" class="section-icon"> Google Sheets Loader Testing Tool
            </h2>
            
            <!-- Configuration Panel -->
            <div class="test-panel">
                <div class="test-header">
                    <h3 class="test-title">Configuration</h3>
                    <div class="test-controls">
                        <button class="test-btn" onclick="resetToDefault()">Reset to Default</button>
                        <button class="test-btn danger" onclick="clearAllData()">Clear All Data</button>
                    </div>
                </div>
                <div>
                    <label for="sheetUrl" style="color: #999;">Google Sheet URL:</label>
                    <input type="text" id="sheetUrl" class="sheet-url-input" 
                           value="https://docs.google.com/spreadsheets/d/1-ttoHpM6unij08U40voVi8YLn7j8Mhld4FkRsKrzql4/edit?usp=drivesdk"
                           placeholder="Enter Google Sheets URL">
                    <div style="margin-top: 10px;">
                        <button class="test-btn success" onclick="loadSheetData()">Load Sheet Data</button>
                        <button class="test-btn" onclick="testInstagramEmbed()">Test Instagram Embeds</button>
                        <button class="test-btn" onclick="testMapMarkers()">Test Map Markers</button>
                    </div>
                </div>
            </div>

            <!-- Status Panel -->
            <div id="statusPanel" class="test-status" style="display: none;">
                <span id="statusText">Ready to load data...</span>
            </div>

            <!-- Statistics Panel -->
            <div class="test-panel">
                <h3 class="test-title">Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalItems">0</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="artistCount">0</div>
                        <div class="stat-label">Artists</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="businessCount">0</div>
                        <div class="stat-label">Businesses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="withInstagram">0</div>
                        <div class="stat-label">With Instagram</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="withLocation">0</div>
                        <div class="stat-label">With Location</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="loadTime">0ms</div>
                        <div class="stat-label">Load Time</div>
                    </div>
                </div>
            </div>

            <!-- Data Viewer -->
            <div class="test-panel">
                <h3 class="test-title">Data Viewer</h3>
                <div class="data-viewer">
                    <div class="data-column">
                        <h3>Raw Response</h3>
                        <div id="rawData" class="raw-data">No data loaded yet...</div>
                    </div>
                    <div class="data-column">
                        <h3>Processed Data</h3>
                        <div id="processedData" class="processed-data">No data loaded yet...</div>
                    </div>
                </div>
            </div>

            <!-- Map Test Panel -->
            <div class="test-panel">
                <h3 class="test-title">Map Visualization</h3>
                <div id="testMap" class="test-map"></div>
            </div>

            <!-- Instagram Test Panel -->
            <div class="test-panel">
                <h3 class="test-title">Instagram Embed Test</h3>
                <div id="instagramTest" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                    <!-- Instagram embeds will be inserted here -->
                </div>
            </div>

            <!-- Log Viewer -->
            <div class="test-panel">
                <div class="test-header">
                    <h3 class="test-title">Log Viewer</h3>
                    <div class="test-controls">
                        <button class="test-btn" onclick="clearLogs()">Clear Logs</button>
                        <button class="test-btn" onclick="exportLogs()">Export Logs</button>
                    </div>
                </div>
                <div id="logViewer" class="log-viewer">
                    <div class="log-entry info">Logger initialized - Ready for testing...</div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 chunky.dad - Testing Tool</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="../js/navigation.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <script>
        // Test-specific logging setup
        const testLogger = {
            logs: [],
            logToViewer(level, message, data) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${level}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                if (data) {
                    logEntry.textContent += ` - ${JSON.stringify(data, null, 2)}`;
                }
                document.getElementById('logViewer').appendChild(logEntry);
                logEntry.scrollIntoView({ behavior: 'smooth' });
                
                this.logs.push({ timestamp, level, message, data });
            }
        };

        // Global variables
        let testMap = null;
        let testMarkers = [];
        let sheetData = [];
        let loadStartTime = null;

        // Initialize map
        function initTestMap() {
            try {
                testLogger.logToViewer('info', 'Initializing test map');
                testMap = L.map('testMap').setView([40.7128, -74.0060], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(testMap);
                testLogger.logToViewer('success', 'Test map initialized');
            } catch (error) {
                testLogger.logToViewer('error', 'Failed to initialize map', error.message);
            }
        }

        // Load sheet data
        async function loadSheetData() {
            const sheetUrl = document.getElementById('sheetUrl').value;
            if (!sheetUrl) {
                testLogger.logToViewer('error', 'No sheet URL provided');
                return;
            }

            // Extract sheet ID from URL
            const sheetIdMatch = sheetUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (!sheetIdMatch) {
                testLogger.logToViewer('error', 'Invalid Google Sheets URL');
                return;
            }

            const sheetId = sheetIdMatch[1];
            const apiUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

            testLogger.logToViewer('info', 'Starting data load', { sheetId, apiUrl });
            showStatus('loading', 'Loading data from Google Sheets...');
            
            loadStartTime = performance.now();

            try {
                const response = await fetch(apiUrl);
                const text = await response.text();
                
                testLogger.logToViewer('success', 'Data fetched successfully', { 
                    responseLength: text.length,
                    statusCode: response.status 
                });

                // Show raw response
                document.getElementById('rawData').textContent = text.substring(0, 1000) + '...';

                // Parse Google Sheets response
                const jsonString = text.substring(47).slice(0, -2);
                const json = JSON.parse(jsonString);
                
                testLogger.logToViewer('success', 'JSON parsed successfully');

                // Process data
                sheetData = processSheetData(json);
                
                const loadTime = performance.now() - loadStartTime;
                updateStatistics(loadTime);
                
                showStatus('success', `Loaded ${sheetData.length} items in ${loadTime.toFixed(2)}ms`);
                testLogger.logToViewer('success', 'Data processing complete', { 
                    itemCount: sheetData.length,
                    loadTime: `${loadTime.toFixed(2)}ms`
                });

            } catch (error) {
                showStatus('error', `Error: ${error.message}`);
                testLogger.logToViewer('error', 'Failed to load data', error.message);
                console.error('Load error:', error);
            }
        }

        // Process sheet data
        function processSheetData(json) {
            testLogger.logToViewer('info', 'Processing sheet data');
            
            const rows = json.table.rows;
            const data = [];
            
            // Skip header row
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.c;
                
                const item = {
                    name: cells[0]?.v || '',
                    shop: cells[1]?.v || '',
                    website: cells[2]?.v || '',
                    instagram: cells[3]?.v || '',
                    type: cells[4]?.v || '',
                    googleMaps: cells[5]?.v || '',
                    coordinates: cells[6]?.v || '',
                    city: cells[7]?.v || '',
                    display: cells[8]?.v || '' // New Display field
                };
                
                // Clean Instagram username - remove @ symbol and trim
                if (item.instagram) {
                    item.instagram = item.instagram.replace('@', '').trim();
                }
                
                if (item.name) {
                    data.push(item);
                    testLogger.logToViewer('info', `Processed: ${item.name}`, { 
                        type: item.type, 
                        hasInstagram: !!item.instagram,
                        instagram: item.instagram,
                        hasLocation: !!item.coordinates 
                    });
                }
            }
            
            // Update processed data view
            document.getElementById('processedData').textContent = JSON.stringify(data, null, 2);
            
            return data;
        }

        // Update statistics
        function updateStatistics(loadTime) {
            const stats = {
                total: sheetData.length,
                artists: sheetData.filter(item => item.type.toLowerCase() === 'art').length,
                businesses: sheetData.filter(item => item.type.toLowerCase() !== 'art').length,
                withInstagram: sheetData.filter(item => item.instagram).length,
                withLocation: sheetData.filter(item => item.coordinates).length
            };

            document.getElementById('totalItems').textContent = stats.total;
            document.getElementById('artistCount').textContent = stats.artists;
            document.getElementById('businessCount').textContent = stats.businesses;
            document.getElementById('withInstagram').textContent = stats.withInstagram;
            document.getElementById('withLocation').textContent = stats.withLocation;
            document.getElementById('loadTime').textContent = `${loadTime.toFixed(0)}ms`;

            testLogger.logToViewer('info', 'Statistics updated', stats);
        }

        // Test Instagram embeds with different display options
        let currentInstagramMode = 'full'; // full, media-only, grid
        
        function testInstagramEmbed(mode = 'full') {
            currentInstagramMode = mode || currentInstagramMode;
            testLogger.logToViewer('info', `Testing Instagram embeds in ${currentInstagramMode} mode`);
            
            const container = document.getElementById('instagramTest');
            container.innerHTML = '';
            
            const itemsWithInstagram = sheetData.filter(item => item.instagram).slice(0, 6);
            
            if (itemsWithInstagram.length === 0) {
                testLogger.logToViewer('warning', 'No items with Instagram found');
                container.innerHTML = '<p style="color: #999;">No Instagram accounts found in data</p>';
                return;
            }
            
            // Add mode selector buttons
            const modeSelector = document.createElement('div');
            modeSelector.style.cssText = 'margin-bottom: 20px; display: flex; gap: 10px;';
            modeSelector.innerHTML = `
                <button class="test-btn ${currentInstagramMode === 'full' ? 'active' : ''}" onclick="testInstagramEmbed('full')">Full Feed</button>
                <button class="test-btn ${currentInstagramMode === 'media-only' ? 'active' : ''}" onclick="testInstagramEmbed('media-only')">Media Only</button>
                <button class="test-btn ${currentInstagramMode === 'grid' ? 'active' : ''}" onclick="testInstagramEmbed('grid')">Grid View</button>
                <button class="test-btn ${currentInstagramMode === 'compact' ? 'active' : ''}" onclick="testInstagramEmbed('compact')">Compact</button>
            `;
            container.appendChild(modeSelector);
            
            const contentContainer = document.createElement('div');
            contentContainer.style.cssText = getContainerStyle(currentInstagramMode);
            container.appendChild(contentContainer);
            
            itemsWithInstagram.forEach((item, index) => {
                const embedDiv = document.createElement('div');
                embedDiv.className = 'instagram-embed-wrapper';
                embedDiv.style.cssText = getEmbedStyle(currentInstagramMode);
                
                let embedContent = '';
                
                switch(currentInstagramMode) {
                    case 'full':
                        embedContent = `
                            <h4 style="color: #FFA500; margin-bottom: 10px;">${item.name}</h4>
                            <div class="instagram-embed-container">
                                <blockquote class="instagram-media" 
                                    data-instgrm-permalink="https://www.instagram.com/${item.instagram}/" 
                                    data-instgrm-version="14"
                                    data-instgrm-captioned>
                                </blockquote>
                            </div>
                        `;
                        break;
                    
                    case 'media-only':
                        embedContent = `
                            <h4 style="color: #FFA500; margin-bottom: 10px;">${item.name}</h4>
                            <div class="instagram-embed-container">
                                <blockquote class="instagram-media" 
                                    data-instgrm-permalink="https://www.instagram.com/${item.instagram}/" 
                                    data-instgrm-version="14"
                                    data-instgrm-captioned="false">
                                </blockquote>
                            </div>
                        `;
                        break;
                    
                    case 'grid':
                        embedContent = `
                            <div class="instagram-embed-container" style="aspect-ratio: 1;">
                                <blockquote class="instagram-media" 
                                    data-instgrm-permalink="https://www.instagram.com/${item.instagram}/" 
                                    data-instgrm-version="14"
                                    data-instgrm-captioned="false"
                                    style="max-width: 100%;">
                                </blockquote>
                            </div>
                            <p style="color: #FFA500; margin-top: 10px; text-align: center; font-size: 0.9rem;">${item.name}</p>
                        `;
                        break;
                    
                    case 'compact':
                        embedContent = `
                            <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #222; border-radius: 8px;">
                                <div style="flex: 0 0 100px;">
                                    <img src="https://www.instagram.com/${item.instagram}/media/?size=t" 
                                         style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;"
                                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%2250%25%22 x=%2250%25%22 text-anchor=%22middle%22 font-size=%2240%22>üêª</text></svg>'">
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="color: #FFA500; margin: 0;">${item.name}</h4>
                                    <a href="https://instagram.com/${item.instagram}" target="_blank" style="color: #888; text-decoration: none;">@${item.instagram}</a>
                                </div>
                            </div>
                        `;
                        break;
                }
                
                embedDiv.innerHTML = embedContent;
                contentContainer.appendChild(embedDiv);
                
                testLogger.logToViewer('info', `Added Instagram embed for ${item.name}`, { 
                    username: item.instagram,
                    mode: currentInstagramMode
                });
            });
            
            // Load Instagram embed script with better error handling
            loadInstagramScript();
        }
        
        function getContainerStyle(mode) {
            switch(mode) {
                case 'grid':
                    return 'display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;';
                case 'compact':
                    return 'display: flex; flex-direction: column; gap: 10px;';
                default:
                    return 'display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;';
            }
        }
        
        function getEmbedStyle(mode) {
            switch(mode) {
                case 'grid':
                    return 'background: #1a1a1a; border-radius: 8px; overflow: hidden;';
                case 'compact':
                    return '';
                default:
                    return '';
            }
        }
        
        function loadInstagramScript() {
            if (!window.instgrm) {
                const script = document.createElement('script');
                script.async = true;
                script.defer = true;
                script.src = 'https://www.instagram.com/embed.js';
                
                script.onerror = (error) => {
                    testLogger.logToViewer('error', 'Failed to load Instagram embed script', {
                        error: error.toString(),
                        src: script.src,
                        message: 'Instagram script failed to load - may be blocked by ad blocker or network issues'
                    });
                    
                    // Log to main logger as well
                    if (window.logger) {
                        logger.componentError('INSTAGRAM', 'Failed to load Instagram embed script', error);
                    }
                };
                
                script.onload = () => {
                    testLogger.logToViewer('success', 'Instagram embed script loaded successfully');
                    
                    // Log to main logger
                    if (window.logger) {
                        logger.componentLoad('INSTAGRAM', 'Instagram embed script loaded');
                    }
                    
                    setTimeout(() => {
                        if (window.instgrm && window.instgrm.Embeds) {
                            // Mark containers and add observers
                            const containers = document.querySelectorAll('.instagram-embed-container');
                            containers.forEach(container => {
                                const observer = new MutationObserver((mutations) => {
                                    const iframe = container.querySelector('iframe');
                                    if (iframe) {
                                        container.classList.add('loaded');
                                        observer.disconnect();
                                    }
                                });
                                observer.observe(container, { childList: true, subtree: true });
                                
                                // Timeout for failed loads
                                setTimeout(() => {
                                    if (!container.classList.contains('loaded')) {
                                        container.classList.add('error');
                                        const username = container.querySelector('a')?.href?.match(/instagram\.com\/([^/]+)/)?.[1] || 'unknown';
                                        testLogger.logToViewer('warn', `Instagram embed timeout for @${username}`);
                                    }
                                }, 10000);
                            });
                            
                            window.instgrm.Embeds.process();
                            testLogger.logToViewer('success', 'Instagram embeds processed', {
                                containerCount: containers.length
                            });
                            
                            // Check if embeds were actually created
                            setTimeout(() => {
                                const embeds = document.querySelectorAll('.instagram-media-rendered');
                                testLogger.logToViewer('info', `Found ${embeds.length} rendered Instagram embeds`);
                            }, 1000);
                        } else {
                            testLogger.logToViewer('warning', 'Instagram API not available after script load');
                        }
                    }, 500); // Increased timeout for better reliability
                };
                
                document.body.appendChild(script);
                testLogger.logToViewer('info', 'Loading Instagram embed script from: ' + script.src);
            } else {
                testLogger.logToViewer('info', 'Instagram API already loaded, processing embeds');
                setTimeout(() => {
                    if (window.instgrm && window.instgrm.Embeds) {
                        // Mark containers and add observers for already loaded script
                        const containers = document.querySelectorAll('.instagram-embed-container');
                        containers.forEach(container => {
                            const observer = new MutationObserver((mutations) => {
                                const iframe = container.querySelector('iframe');
                                if (iframe) {
                                    container.classList.add('loaded');
                                    observer.disconnect();
                                }
                            });
                            observer.observe(container, { childList: true, subtree: true });
                            
                            // Timeout for failed loads
                            setTimeout(() => {
                                if (!container.classList.contains('loaded')) {
                                    container.classList.add('error');
                                    const username = container.querySelector('a')?.href?.match(/instagram\.com\/([^/]+)/)?.[1] || 'unknown';
                                    testLogger.logToViewer('warn', `Instagram embed timeout for @${username}`);
                                }
                            }, 10000);
                        });
                        
                        window.instgrm.Embeds.process();
                        testLogger.logToViewer('info', 'Instagram embeds reprocessed', {
                            containerCount: containers.length
                        });
                        
                        // Check rendered embeds
                        setTimeout(() => {
                            const embeds = document.querySelectorAll('.instagram-media-rendered');
                            testLogger.logToViewer('info', `Found ${embeds.length} rendered Instagram embeds after reprocess`);
                        }, 1000);
                    }
                }, 100);
            }
        }

        // Test map markers
        function testMapMarkers() {
            testLogger.logToViewer('info', 'Testing map markers');
            
            // Clear existing markers
            testMarkers.forEach(marker => marker.remove());
            testMarkers = [];
            
            const itemsWithLocation = sheetData.filter(item => item.coordinates);
            
            if (itemsWithLocation.length === 0) {
                testLogger.logToViewer('warning', 'No items with coordinates found');
                return;
            }
            
            itemsWithLocation.forEach(item => {
                try {
                    const [lat, lng] = item.coordinates.split(',').map(coord => parseFloat(coord.trim()));
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        const marker = L.marker([lat, lng])
                            .addTo(testMap)
                            .bindPopup(`
                                <div>
                                    <h4>${item.name}</h4>
                                    <p>${item.type}</p>
                                    ${item.city ? `<p>üìç ${item.city}</p>` : ''}
                                </div>
                            `);
                        
                        testMarkers.push(marker);
                        testLogger.logToViewer('success', `Added marker for ${item.name}`, { lat, lng });
                    }
                } catch (error) {
                    testLogger.logToViewer('error', `Failed to add marker for ${item.name}`, error.message);
                }
            });
            
            // Fit map to markers
            if (testMarkers.length > 0) {
                const group = new L.featureGroup(testMarkers);
                testMap.fitBounds(group.getBounds().pad(0.1));
                testLogger.logToViewer('success', `Map fitted to ${testMarkers.length} markers`);
            }
        }

        // Utility functions
        function showStatus(type, message) {
            const statusPanel = document.getElementById('statusPanel');
            const statusText = document.getElementById('statusText');
            
            statusPanel.style.display = 'block';
            statusPanel.className = `test-status ${type}`;
            statusText.textContent = message;
        }

        function resetToDefault() {
            document.getElementById('sheetUrl').value = 'https://docs.google.com/spreadsheets/d/1-ttoHpM6unij08U40voVi8YLn7j8Mhld4FkRsKrzql4/edit?usp=drivesdk';
            testLogger.logToViewer('info', 'Reset to default sheet URL');
        }

        function clearAllData() {
            sheetData = [];
            document.getElementById('rawData').textContent = 'No data loaded yet...';
            document.getElementById('processedData').textContent = 'No data loaded yet...';
            document.getElementById('instagramTest').innerHTML = '';
            testMarkers.forEach(marker => marker.remove());
            testMarkers = [];
            updateStatistics(0);
            showStatus('', '');
            document.getElementById('statusPanel').style.display = 'none';
            testLogger.logToViewer('warning', 'All data cleared');
        }

        function clearLogs() {
            document.getElementById('logViewer').innerHTML = '<div class="log-entry info">Logs cleared</div>';
            testLogger.logs = [];
        }

        function exportLogs() {
            const logsText = testLogger.logs.map(log => 
                `[${log.timestamp}] ${log.level.toUpperCase()}: ${log.message} ${log.data ? JSON.stringify(log.data) : ''}`
            ).join('\n');
            
            const blob = new Blob([logsText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `google-sheets-test-logs-${new Date().toISOString()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            testLogger.logToViewer('info', 'Logs exported');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            logger.componentInit('TEST', 'Google Sheets Loader Test initialized');
            initTestMap();
            testLogger.logToViewer('success', 'Test page ready');
        });
    </script>
</body>
</html>