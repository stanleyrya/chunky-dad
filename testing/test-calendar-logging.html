<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìù chunky.dad's Toolbox - Diagnostic Tool</title>
    <meta name="description" content="Advanced diagnostic tool for calendar event processing - chunky.dad's toolbox">
    <link rel="icon" type="image/png" href="../Rising_Star_Ryan_Head_Compressed.png">
    <link rel="apple-touch-icon" href="../Rising_Star_Ryan_Head_Compressed.png">
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Roboto+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <style>
        /* Debugging-specific styles */
        body {
            background: #0a0a0a;
            color: #e0e0e0;
        }
        
        .debug-panel {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #333;
            color: #e0e0e0;
        }
        
        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .debug-title {
            color: #FFA500;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .debug-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .debug-btn {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .debug-btn:hover {
            background: #444;
            border-color: #FFA500;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 165, 0, 0.3);
        }
        
        .debug-btn.active {
            background: #FFA500;
            color: #000;
            border-color: #FFA500;
        }
        
        .event-debugger {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .debug-column {
            background: #0d0d0d;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .debug-column h3 {
            color: #FFA500;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .raw-data, .processed-data {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            color: #ccc;
            background: #0a0a0a;
            padding: 10px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .event-selector {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .event-list {
            max-height: 400px;
            overflow-y: auto;
            background: #0d0d0d;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .event-item {
            padding: 12px;
            margin: 5px 0;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #e0e0e0;
        }
        
        .event-item:hover {
            background: #333;
            border-color: #FFA500;
            transform: translateX(2px);
        }
        
        .event-item.selected {
            background: #FFA500;
            color: #000;
            border-color: #FFA500;
        }
        
        .event-item-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .event-item-meta {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #0d0d0d;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            border-color: #FFA500;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 165, 0, 0.2);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #FFA500;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #999;
        }
        
        .city-quick-switch {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .city-quick-btn {
            background: #333;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-decoration: none;
        }
        
        .city-quick-btn:hover {
            background: #444;
            border-color: #FFA500;
            transform: translateY(-2px);
        }
        
        .city-quick-btn.current {
            background: #FFA500;
            color: #000;
            border-color: #FFA500;
        }
        
        .city-quick-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .city-emoji {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        /* Enhanced Log Section Styles */
        .log-container {
            position: relative;
            background: #0d0d0d;
            border-radius: 8px;
            border: 1px solid #333;
            transition: all 0.3s ease;
        }
        
        .log-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            margin: 0;
            border-radius: 0;
            display: flex;
            flex-direction: column;
        }
        
        .log-filters {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .log-search {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            background: #0d0d0d;
            border: 1px solid #333;
            color: #fff;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .log-search:focus {
            outline: none;
            border-color: #FFA500;
            box-shadow: 0 0 0 2px rgba(255, 165, 0, 0.2);
        }
        
        .component-filter {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .component-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
            background: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .component-btn:hover {
            background: #3a3a3a;
            border-color: #666;
        }
        
        .component-btn.active {
            background: #FFA500;
            color: #000;
            border-color: #FFA500;
        }
        
        .processing-log {
            background: #0d0d0d;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #e0e0e0;
        }
        
        .log-container.fullscreen .processing-log {
            max-height: none;
            flex: 1;
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #222;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            transition: background 0.2s ease;
        }
        
        .log-entry:hover {
            background: rgba(255, 165, 0, 0.05);
        }
        
        .log-timestamp {
            color: #666;
            white-space: nowrap;
            font-size: 0.8rem;
        }
        
        .log-level {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 3px;
            white-space: nowrap;
        }
        
        .log-level-debug { 
            color: #888;
            background: rgba(136, 136, 136, 0.1);
        }
        .log-level-info { 
            color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }
        .log-level-warn { 
            color: #f39c12;
            background: rgba(243, 156, 18, 0.1);
        }
        .log-level-error { 
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }
        
        .log-component {
            color: #61afef;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .log-message {
            flex: 1;
            color: #e0e0e0;
            word-break: break-word;
            white-space: pre-wrap;
        }
        
        .processing-log.no-wrap .log-message {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .processing-log.no-wrap .log-entry {
            flex-wrap: nowrap;
        }
        
        .processing-log.no-wrap {
            overflow-x: auto;
        }
        
        .log-data {
            margin-top: 5px;
            padding: 8px;
            background: #0a0a0a;
            border-radius: 4px;
            font-size: 0.8em;
            color: #999;
            border: 1px solid #222;
        }
        
        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            z-index: 10;
        }
        
        .fullscreen-btn:hover {
            background: #444;
            border-color: #FFA500;
        }
        
        .data-comparison {
            margin: 20px 0;
        }
        
        .diff-highlight {
            background: rgba(255, 165, 0, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .field-missing {
            color: #e74c3c;
            font-style: italic;
        }
        
        .field-present {
            color: #2ecc71;
        }
        
        /* Syntax highlighting for processed data */
        .json-string { color: #98c379; }
        .json-number { color: #d19a66; }
        .json-boolean { color: #56b6c2; }
        .json-null { color: #e06c75; }
        .json-key { color: #e06c75; }
        
        /* Input and search styling */
        input[type="text"], input[type="search"] {
            background: #0d0d0d;
            border: 1px solid #333;
            color: #fff;
            padding: 10px;
            border-radius: 8px;
        }
        
        input[type="text"]:focus, input[type="search"]:focus {
            outline: none;
            border-color: #FFA500;
            box-shadow: 0 0 0 2px rgba(255, 165, 0, 0.2);
        }
        
        /* Scrollbar styling for dark mode */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #0d0d0d;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        
        @media (max-width: 768px) {
            .event-debugger {
                grid-template-columns: 1fr;
            }
            
            .city-quick-switch {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .log-filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .log-search {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="nav-container">
                <div class="logo">
                    <h1><a href="index.html"><img src="../Rising_Star_Ryan_Head_Compressed.png" alt="chunky.dad logo" class="logo-img"> chunky.dad - Calendar Debugger</a></h1>
                </div>
                
                <ul class="nav-menu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="city.html" id="city-link">City Page</a></li>
                    <li><a href="#" id="clear-logs">Clear Logs</a></li>
                    <li><a href="#" id="export-data">Export Data</a></li>
                </ul>
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section class="debug-hero">
            <div class="container">
                <h1>üîß Calendar Event Debugging Tool</h1>
                <p>Advanced debugging interface for calendar event processing</p>
                
                <!-- Quick City Switcher -->
                <div class="debug-panel">
                    <h2 class="debug-title">üèôÔ∏è Quick City Switch</h2>
                    <div class="city-quick-switch" id="city-quick-switch">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Statistics Overview -->
                <div class="debug-panel">
                    <h2 class="debug-title">üìä Calendar Statistics</h2>
                    <div class="stats-grid" id="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-events">0</div>
                            <div class="stat-label">Total Events</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="recurring-events">0</div>
                            <div class="stat-label">Recurring Events</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="unique-venues">0</div>
                            <div class="stat-label">Unique Venues</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="parse-time">0ms</div>
                            <div class="stat-label">Parse Time</div>
                        </div>
                    </div>
                </div>
                
                <!-- Event Browser -->
                <div class="debug-panel">
                    <div class="debug-header">
                        <h2 class="debug-title">üéØ Event Browser</h2>
                        <div class="debug-controls">
                            <button class="debug-btn" id="filter-all">All Events</button>
                            <button class="debug-btn" id="filter-recurring">Recurring Only</button>
                            <button class="debug-btn" id="filter-oneoff">One-off Only</button>
                            <button class="debug-btn" id="filter-errors">Errors Only</button>
                        </div>
                    </div>
                    
                    <div class="event-selector">
                        <input type="text" id="event-search" placeholder="üîç Search events..." style="width: 100%; padding: 10px; background: #0d0d0d; border: 1px solid #333; color: #fff; border-radius: 8px; margin-bottom: 10px;">
                        <div class="event-list" id="event-list">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Event Comparison -->
                <div class="debug-panel">
                    <h2 class="debug-title">üî¨ Event Data Comparison</h2>
                    <div class="event-debugger">
                        <div class="debug-column">
                            <h3>üìÑ Raw iCal Data</h3>
                            <div class="raw-data" id="raw-data">
                                Select an event to view raw data...
                            </div>
                        </div>
                        <div class="debug-column">
                            <h3>‚öôÔ∏è Processed Event Object</h3>
                            <div class="processed-data" id="processed-data">
                                Select an event to view processed data...
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Timezone Debugging Panel -->
                <div class="debug-panel">
                    <h2 class="debug-title">üåç Timezone Translation Analysis</h2>
                    <div class="timezone-info" style="margin-bottom: 20px;">
                        <strong>Your Browser Timezone:</strong> <span id="browser-timezone">Loading...</span><br>
                        <strong>Calendar Default Timezone:</strong> <span id="calendar-timezone">Loading...</span><br>
                        <strong>Current Local Time:</strong> <span id="current-time">Loading...</span>
                    </div>
                    
                    <div id="timezone-analysis" style="display: none;">
                        <h3 style="color: #FFA500; margin-bottom: 15px;">Selected Event Timezone Analysis</h3>
                        
                        <div class="event-debugger">
                            <div class="debug-column">
                                <h3>üìÖ Original Time Data</h3>
                                <div class="raw-data" id="tz-original">
                                    Select an event to analyze timezone handling...
                                </div>
                            </div>
                            <div class="debug-column">
                                <h3>üîÑ Time Translation Steps</h3>
                                <div class="processed-data" id="tz-translation">
                                    Select an event to see translation process...
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h3 style="color: #FFA500; margin-bottom: 15px;">Time Display Comparison</h3>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-label">UTC Time</div>
                                    <div class="stat-value" id="tz-utc" style="font-size: 1.2rem;">--</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Calendar Timezone</div>
                                    <div class="stat-value" id="tz-calendar" style="font-size: 1.2rem;">--</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Your Local Time</div>
                                    <div class="stat-value" id="tz-local" style="font-size: 1.2rem;">--</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Display Time</div>
                                    <div class="stat-value" id="tz-display" style="font-size: 1.2rem;">--</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h3 style="color: #FFA500; margin-bottom: 15px;">Timezone Test Cases</h3>
                            <button class="debug-btn" id="test-timezone-conversion">üß™ Run Timezone Tests</button>
                            <div id="timezone-test-results" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Processing Log -->
                <div class="debug-panel">
                    <div class="debug-header">
                        <h2 class="debug-title">üìã Processing Logs</h2>
                        <div class="debug-controls">
                            <button class="debug-btn" id="log-toggle-wrap">‚ÜîÔ∏è Toggle Wrap</button>
                            <button class="debug-btn" id="log-toggle-fullscreen">‚õ∂ Fullscreen</button>
                            <button class="debug-btn" id="log-clear">üóëÔ∏è Clear</button>
                            <button class="debug-btn" id="log-export">üíæ Export</button>
                        </div>
                    </div>
                    <div class="log-container" id="log-container">
                        <div class="log-filters">
                            <input type="search" class="log-search" id="log-search" placeholder="üîç Search logs...">
                            
                            <div class="debug-controls">
                                <button class="debug-btn" id="log-all" class="active">All</button>
                                <button class="debug-btn" id="log-debug">Debug</button>
                                <button class="debug-btn" id="log-info">Info</button>
                                <button class="debug-btn" id="log-warn">Warnings</button>
                                <button class="debug-btn" id="log-error">Errors</button>
                            </div>
                            
                            <div class="component-filter" id="component-filter">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                        <div class="processing-log" id="processing-log">
                            <!-- Populated by JavaScript -->
                        </div>
                        <button class="fullscreen-btn" id="fullscreen-close" style="display: none;">‚úï Close</button>
                    </div>
                </div>
                
                <!-- Advanced Tools -->
                <div class="debug-panel">
                    <h2 class="debug-title">üõ†Ô∏è Advanced Tools</h2>
                    <div class="debug-controls" style="flex-wrap: wrap; gap: 10px;">
                        <button class="debug-btn" id="reload-calendar">üîÑ Reload Calendar</button>
                        <button class="debug-btn" id="test-parsing">üß™ Test Event Parsing</button>
                        <button class="debug-btn" id="validate-data">‚úÖ Validate All Events</button>
                        <button class="debug-btn" id="benchmark">‚ö° Run Benchmark</button>
                        <button class="debug-btn" id="download-raw">üíæ Download Raw iCal</button>
                        <button class="debug-btn" id="download-json">üíæ Download Processed JSON</button>
                        <button class="debug-btn" id="compare-cities">üîç Compare Cities</button>
                        <button class="debug-btn" id="test-recurrence">üìÖ Test Recurrence Rules</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
                            <p>&copy; 2025 chunky.dad Calendar Debugger. Made with <img src="../Rising_Star_Ryan_Head_Compressed.png" alt="chunky.dad" class="button-icon"> for debugging.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="../js/logger.js"></script>
<script src="../js/debug-overlay.js"></script>
<script src="../js/city-config.js"></script>
    <script src="../js/calendar-core.js"></script>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    <script src="../js/navigation.js"></script>
    <script src="../js/page-effects.js"></script>
    <script src="../js/forms.js"></script>
    <script src="../js/dynamic-calendar-loader.js"></script>
    
    <!-- Debugging-specific script -->
    <script>
        // Enhanced Calendar Debugger
        class CalendarDebugger extends DynamicCalendarLoader {
            constructor() {
                super();
                this.debugLogs = [];
                this.selectedEvent = null;
                this.rawCalendarData = '';
                this.eventFilter = 'all';
                this.logFilter = 'all';
                this.logSearchTerm = '';
                this.activeComponents = new Set();
                this.allComponents = new Set();
                this.isLogFullscreen = false;
                this.isLogWrap = false; // New property for line wrap
                
                // Override logger methods to capture logs
                this.originalLogMethods = {
                    debug: logger.debug.bind(logger),
                    info: logger.info.bind(logger),
                    warn: logger.warn.bind(logger),
                    error: logger.error.bind(logger)
                };
                
                this.setupLogCapture();
                logger.componentInit('DEBUGGER', 'Calendar Debugger initialized');
            }
            
            setupLogCapture() {
                const self = this;
                
                // Wrap logger methods to capture output
                ['debug', 'info', 'warn', 'error'].forEach(level => {
                    logger[level] = function(component, message, data) {
                        // Call original method
                        self.originalLogMethods[level](component, message, data);
                        
                        // Track component
                        self.allComponents.add(component);
                        
                        // Capture log
                        self.debugLogs.push({
                            timestamp: new Date(),
                            level,
                            component,
                            message,
                            data
                        });
                        
                        // Update UI
                        self.updateProcessingLog();
                        self.updateComponentFilter();
                    };
                });
            }
            
            parseICalData(icalText) {
                this.rawCalendarData = icalText;
                const startTime = performance.now();
                
                // Store reference to calendar core for timezone analysis
                this.calendarCore = this;
                
                const result = super.parseICalData(icalText);
                const parseTime = performance.now() - startTime;
                
                document.getElementById('parse-time').textContent = `${parseTime.toFixed(2)}ms`;
                
                // Update calendar timezone display
                this.updateCalendarTimezone();
                
                return result;
            }
            
            setupCityQuickSwitch() {
                const container = document.getElementById('city-quick-switch');
                const cities = getAvailableCities();
                
                container.innerHTML = cities.map(city => {
                    const isActive = city.key === this.currentCity;
                    const hasCalendar = hasCityCalendar(city.key);
                    
                    return `
                        <a href="test-calendar-logging.html?city=${city.key}" 
                           class="city-quick-btn ${isActive ? 'current' : ''} ${!hasCalendar ? 'disabled' : ''}"
                           title="${city.name}">
                            <div class="city-emoji">${city.emoji}</div>
                            <div>${city.name}</div>
                            ${!hasCalendar ? '<small style="opacity: 0.5;">No Calendar</small>' : ''}
                        </a>
                    `;
                }).join('');
                
                // Update city link in nav
                const cityLink = document.getElementById('city-link');
                if (cityLink) {
                    cityLink.href = `city.html?city=${this.currentCity}`;
                }
            }
            
            updateStats() {
                const allEvents = this.allEvents || [];
                const recurringEvents = allEvents.filter(e => e.recurring).length;
                const venues = new Set(allEvents.map(e => e.bar).filter(Boolean));
                
                document.getElementById('total-events').textContent = allEvents.length;
                document.getElementById('recurring-events').textContent = recurringEvents;
                document.getElementById('unique-venues').textContent = venues.size;
            }
            
            displayEventList() {
                const container = document.getElementById('event-list');
                const events = this.getFilteredEventList();
                
                if (!events.length) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No events found</div>';
                    return;
                }
                
                container.innerHTML = events.map((event, index) => `
                    <div class="event-item" data-index="${index}">
                        <div class="event-item-title">${event.name || 'Unnamed Event'}</div>
                        <div class="event-item-meta">
                            ${event.recurring ? 'üîÑ Recurring' : 'üìÖ One-off'} | 
                            ${event.bar || 'No venue'} | 
                            ${event.time || 'No time'}
                            ${event._parseError ? ' | ‚ö†Ô∏è Parse Error' : ''}
                        </div>
                    </div>
                `).join('');
                
                // Add click handlers
                container.querySelectorAll('.event-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const index = parseInt(item.dataset.index);
                        const filteredEvents = this.getFilteredEventList();
                        this.selectEvent(filteredEvents[index], item);
                    });
                });
            }
            
            getFilteredEventList() {
                const events = this.allEvents || [];
                const searchTerm = document.getElementById('event-search').value.toLowerCase();
                
                return events.filter(event => {
                    // Apply filter
                    if (this.eventFilter === 'recurring' && !event.recurring) return false;
                    if (this.eventFilter === 'oneoff' && event.recurring) return false;
                    if (this.eventFilter === 'errors' && !event._parseError) return false;
                    
                    // Apply search
                    if (searchTerm) {
                        const searchableText = `${event.name} ${event.bar || ''} ${event.tea || ''}`.toLowerCase();
                        if (!searchableText.includes(searchTerm)) return false;
                    }
                    
                    return true;
                });
            }
            
            selectEvent(event, element) {
                // Update UI
                document.querySelectorAll('.event-item').forEach(el => el.classList.remove('selected'));
                if (element) element.classList.add('selected');
                
                this.selectedEvent = event;
                this.displayEventComparison();
                this.analyzeEventTimezone();
            }
            
            analyzeEventTimezone() {
                if (!this.selectedEvent) return;
                
                // Show timezone analysis section
                document.getElementById('timezone-analysis').style.display = 'block';
                
                // Get raw event data
                const rawEvent = this.findRawEvent(this.selectedEvent);
                
                // Extract time information from raw data
                let originalTimeData = 'No raw event data found';
                let dtStartMatch = null;
                let dtEndMatch = null;
                
                if (rawEvent) {
                    // Extract DTSTART and DTEND
                    dtStartMatch = rawEvent.match(/DTSTART(?:;[^:]+)?:(.+)/);
                    dtEndMatch = rawEvent.match(/DTEND(?:;[^:]+)?:(.+)/);
                    
                    originalTimeData = `Raw iCal Time Data:\n`;
                    originalTimeData += `DTSTART: ${dtStartMatch ? dtStartMatch[0] : 'Not found'}\n`;
                    originalTimeData += `DTEND: ${dtEndMatch ? dtEndMatch[0] : 'Not found'}\n\n`;
                    
                    // Check for timezone info
                    const tzidMatch = rawEvent.match(/DTSTART;TZID=([^:]+):/);
                    if (tzidMatch) {
                        originalTimeData += `Event Timezone: ${tzidMatch[1]}\n`;
                    } else if (dtStartMatch && dtStartMatch[1].endsWith('Z')) {
                        originalTimeData += `Event Timezone: UTC (Z suffix)\n`;
                    } else {
                        originalTimeData += `Event Timezone: Floating (no timezone specified)\n`;
                    }
                    
                    originalTimeData += `\nCalendar Default TZ: ${this.calendarCore.calendarTimezone || 'Not specified'}\n`;
                    originalTimeData += `Was UTC: ${this.selectedEvent.wasUTC ? 'Yes' : 'No'}`;
                }
                
                document.getElementById('tz-original').textContent = originalTimeData;
                
                // Show translation steps
                this.displayTimezoneTranslation();
                
                // Update time displays
                this.updateTimeDisplays();
            }
            
            displayTimezoneTranslation() {
                if (!this.selectedEvent || !this.selectedEvent.startDate) {
                    document.getElementById('tz-translation').innerHTML = '<pre style="margin: 0; color: #999;">No event selected</pre>';
                    return;
                }
                
                const event = this.selectedEvent;
                const startDate = new Date(event.startDate);
                
                let translationSteps = `Time Translation Process:\n\n`;
                
                // Step 1: Original parsing
                translationSteps += `1. Original Parse:\n`;
                translationSteps += `   Raw value: ${event.startDate}\n`;
                translationSteps += `   ISO String: ${startDate.toISOString()}\n`;
                translationSteps += `   Timestamp: ${startDate.getTime()}\n\n`;
                
                // Step 2: Timezone detection
                translationSteps += `2. Timezone Detection:\n`;
                translationSteps += `   Was UTC: ${event.wasUTC ? 'Yes' : 'No'}\n`;
                translationSteps += `   Event TZ: ${event.startTimezone || 'None'}\n`;
                translationSteps += `   Calendar TZ: ${event.calendarTimezone || 'None'}\n`;
                translationSteps += `   Display TZ: ${event.wasUTC && event.calendarTimezone ? event.calendarTimezone : 'User local'}\n\n`;
                
                // Step 3: Display formatting
                translationSteps += `3. Display Formatting:\n`;
                translationSteps += `   Method: ${event.wasUTC && event.calendarTimezone ? 'Calendar timezone conversion' : 'Direct local display'}\n`;
                translationSteps += `   Day: ${event.day}\n`;
                translationSteps += `   Time: ${event.time}\n\n`;
                
                // Step 4: Browser handling
                translationSteps += `4. Browser Information:\n`;
                translationSteps += `   User TZ: ${Intl.DateTimeFormat().resolvedOptions().timeZone}\n`;
                translationSteps += `   Local offset: ${startDate.getTimezoneOffset()} minutes\n`;
                
                document.getElementById('tz-translation').innerHTML = `<pre style="margin: 0; color: #ccc;">${this.escapeHtml(translationSteps)}</pre>`;
            }
            
            updateTimeDisplays() {
                if (!this.selectedEvent || !this.selectedEvent.startDate) {
                    ['tz-utc', 'tz-calendar', 'tz-local', 'tz-display'].forEach(id => {
                        document.getElementById(id).textContent = '--';
                    });
                    return;
                }
                
                const event = this.selectedEvent;
                const startDate = new Date(event.startDate);
                
                // UTC time
                document.getElementById('tz-utc').textContent = startDate.toISOString();
                
                // Calendar timezone time
                if (event.calendarTimezone) {
                    try {
                        const formatter = new Intl.DateTimeFormat('en-US', {
                            timeZone: event.calendarTimezone,
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        });
                        document.getElementById('tz-calendar').textContent = formatter.format(startDate);
                    } catch (e) {
                        document.getElementById('tz-calendar').textContent = 'Invalid timezone';
                    }
                } else {
                    document.getElementById('tz-calendar').textContent = 'No calendar TZ';
                }
                
                // Local time
                document.getElementById('tz-local').textContent = startDate.toLocaleString();
                
                // Display time (what the user sees)
                document.getElementById('tz-display').textContent = `${event.day} ${event.time}`;
            }
            
            setupTimezoneInfo() {
                // Update browser timezone
                const browserTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                document.getElementById('browser-timezone').textContent = browserTz;
                
                // Update current time
                const updateCurrentTime = () => {
                    document.getElementById('current-time').textContent = new Date().toLocaleString();
                };
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                // Calendar timezone will be updated when data loads
            }
            
            updateCalendarTimezone() {
                const calendarTz = this.calendarCore?.calendarTimezone || 'Not specified';
                document.getElementById('calendar-timezone').textContent = calendarTz;
            }
            
            runTimezoneTests() {
                const resultsDiv = document.getElementById('timezone-test-results');
                resultsDiv.innerHTML = '<h4>Running timezone conversion tests...</h4>';
                
                // Test cases
                const testCases = [
                    {
                        name: 'UTC Event (Z suffix)',
                        icalDate: '20250817T050000Z',
                        expectedBehavior: 'Should display in calendar timezone'
                    },
                    {
                        name: 'Timezone-specific Event',
                        icalDate: 'TZID=America/Los_Angeles:20250817T220000',
                        expectedBehavior: 'Should display in specified timezone'
                    },
                    {
                        name: 'Floating Time Event',
                        icalDate: '20250817T190000',
                        expectedBehavior: 'Should display in user local timezone'
                    }
                ];
                
                let results = '<div style="margin-top: 15px;">';
                
                testCases.forEach(test => {
                    // Create a mock event
                    const mockEvent = {
                        start: this.calendarCore.parseICalDate(test.icalDate),
                        wasUTC: test.icalDate.endsWith('Z')
                    };
                    
                    // Extract timezone if present
                    const tzMatch = test.icalDate.match(/TZID=([^:]+):/);
                    if (tzMatch) {
                        mockEvent.startTimezone = tzMatch[1];
                    }
                    
                    // Get formatted times
                    const localTime = mockEvent.start.toLocaleString();
                    let calendarTime = 'N/A';
                    
                    if (this.calendarCore.calendarTimezone) {
                        try {
                            const formatter = new Intl.DateTimeFormat('en-US', {
                                timeZone: this.calendarCore.calendarTimezone,
                                dateStyle: 'short',
                                timeStyle: 'short'
                            });
                            calendarTime = formatter.format(mockEvent.start);
                        } catch (e) {
                            calendarTime = 'Error formatting';
                        }
                    }
                    
                    results += `
                        <div style="background: #0d0d0d; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #333;">
                            <h5 style="color: #FFA500; margin-bottom: 10px;">${test.name}</h5>
                            <div style="font-family: monospace; font-size: 0.9em;">
                                <div>Input: ${test.icalDate}</div>
                                <div>Parsed: ${mockEvent.start.toISOString()}</div>
                                <div>Local Display: ${localTime}</div>
                                <div>Calendar TZ Display: ${calendarTime}</div>
                                <div style="color: #999; margin-top: 5px;">Expected: ${test.expectedBehavior}</div>
                            </div>
                        </div>
                    `;
                });
                
                results += '</div>';
                resultsDiv.innerHTML = results;
            }
            
            displayEventComparison() {
                if (!this.selectedEvent) return;
                
                // Find raw event data
                const rawEvent = this.findRawEvent(this.selectedEvent);
                
                // Display raw data
                document.getElementById('raw-data').textContent = rawEvent || 'Raw data not found';
                
                // Display processed data with nice formatting
                const processed = JSON.stringify(this.selectedEvent, null, 2);
                document.getElementById('processed-data').innerHTML = this.highlightProcessedData(processed);
            }
            
            findRawEvent(processedEvent) {
                // Try to find the raw VEVENT in the calendar data
                const events = this.rawCalendarData.split('BEGIN:VEVENT');
                
                for (let i = 1; i < events.length; i++) {
                    const rawEvent = 'BEGIN:VEVENT' + events[i].split('END:VEVENT')[0] + 'END:VEVENT';
                    
                    // Check if this matches our processed event by name
                    if (processedEvent.name && rawEvent.includes(`SUMMARY:${processedEvent.name}`)) {
                        return rawEvent;
                    }
                }
                
                return null;
            }
            
            highlightProcessedData(json) {
                // Add syntax highlighting
                return json
                    .replace(/(".*?")/g, '<span class="json-string">$1</span>')
                    .replace(/(:)(\s*)([0-9]+)/g, '$1$2<span class="json-number">$3</span>')
                    .replace(/(:)(\s*)(true|false)/g, '$1$2<span class="json-boolean">$3</span>')
                    .replace(/(:)(\s*)(null)/g, '$1$2<span class="json-null">$3</span>');
            }
            
            updateProcessingLog() {
                const container = document.getElementById('processing-log');
                const filteredLogs = this.debugLogs.filter(log => {
                    // Filter by level
                    if (this.logFilter !== 'all' && log.level !== this.logFilter) return false;
                    
                    // Filter by component
                    if (this.activeComponents.size > 0 && !this.activeComponents.has(log.component)) return false;
                    
                    // Filter by search term
                    if (this.logSearchTerm) {
                        const searchableText = `${log.component} ${log.message} ${JSON.stringify(log.data || '')}`.toLowerCase();
                        if (!searchableText.includes(this.logSearchTerm.toLowerCase())) return false;
                    }
                    
                    return true;
                });
                
                const maxLogs = this.isLogFullscreen ? 500 : 100;
                const recentLogs = filteredLogs.slice(-maxLogs);
                
                container.innerHTML = recentLogs.map(log => {
                    const logContent = `
                        <div class="log-entry">
                            <span class="log-timestamp">${log.timestamp.toLocaleTimeString()}</span>
                            <span class="log-level log-level-${log.level}">[${log.level.toUpperCase().padEnd(5)}]</span>
                            <span class="log-component">[${log.component}]</span>
                            <div class="log-message">${this.escapeHtml(log.message)}
                                ${log.data ? `<div class="log-data">${this.formatLogData(log.data)}</div>` : ''}
                            </div>
                        </div>
                    `;
                    return logContent;
                }).join('');
                
                // Auto-scroll to bottom if near bottom
                if (container.scrollHeight - container.scrollTop - container.clientHeight < 100) {
                    container.scrollTop = container.scrollHeight;
                }
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            formatLogData(data) {
                try {
                    const json = JSON.stringify(data, null, 2);
                    return this.escapeHtml(json);
                } catch (e) {
                    return this.escapeHtml(String(data));
                }
            }
            
            updateComponentFilter() {
                const container = document.getElementById('component-filter');
                const components = Array.from(this.allComponents).sort();
                
                container.innerHTML = components.map(component => `
                    <button class="component-btn ${this.activeComponents.has(component) ? 'active' : ''}" 
                            data-component="${component}">
                        ${component}
                    </button>
                `).join('');
                
                // Add click handlers
                container.querySelectorAll('.component-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const component = btn.dataset.component;
                        if (this.activeComponents.has(component)) {
                            this.activeComponents.delete(component);
                        } else {
                            this.activeComponents.add(component);
                        }
                        this.updateComponentFilter();
                        this.updateProcessingLog();
                    });
                });
            }
            
            toggleLogFullscreen() {
                const container = document.getElementById('log-container');
                const closeBtn = document.getElementById('fullscreen-close');
                const toggleBtn = document.getElementById('log-toggle-fullscreen');
                
                this.isLogFullscreen = !this.isLogFullscreen;
                
                if (this.isLogFullscreen) {
                    container.classList.add('fullscreen');
                    closeBtn.style.display = 'block';
                    toggleBtn.innerHTML = '‚õ∂ Exit Fullscreen';
                    document.body.style.overflow = 'hidden';
                } else {
                    container.classList.remove('fullscreen');
                    closeBtn.style.display = 'none';
                    toggleBtn.innerHTML = '‚õ∂ Fullscreen';
                    document.body.style.overflow = '';
                }
                
                this.updateProcessingLog();
            }
            
            toggleLogWrap() {
                const container = document.getElementById('processing-log');
                const wrapBtn = document.getElementById('log-toggle-wrap');
                this.isLogWrap = !this.isLogWrap;
                
                if (this.isLogWrap) {
                    container.classList.add('no-wrap');
                    wrapBtn.innerHTML = '‚ÜîÔ∏è Exit No-Wrap';
                } else {
                    container.classList.remove('no-wrap');
                    wrapBtn.innerHTML = '‚ÜîÔ∏è Toggle Wrap';
                }
                this.updateProcessingLog();
            }
            
            setupEventHandlers() {
                // City filter
                document.getElementById('filter-all').addEventListener('click', () => {
                    this.eventFilter = 'all';
                    this.updateFilterButtons();
                    this.displayEventList();
                });
                
                document.getElementById('filter-recurring').addEventListener('click', () => {
                    this.eventFilter = 'recurring';
                    this.updateFilterButtons();
                    this.displayEventList();
                });
                
                document.getElementById('filter-oneoff').addEventListener('click', () => {
                    this.eventFilter = 'oneoff';
                    this.updateFilterButtons();
                    this.displayEventList();
                });
                
                document.getElementById('filter-errors').addEventListener('click', () => {
                    this.eventFilter = 'errors';
                    this.updateFilterButtons();
                    this.displayEventList();
                });
                
                // Event search
                document.getElementById('event-search').addEventListener('input', () => {
                    this.displayEventList();
                });
                
                // Log filters
                document.getElementById('log-all').addEventListener('click', () => {
                    this.logFilter = 'all';
                    this.updateLogButtons();
                    this.updateProcessingLog();
                });
                
                ['debug', 'info', 'warn', 'error'].forEach(level => {
                    document.getElementById(`log-${level}`).addEventListener('click', () => {
                        this.logFilter = level;
                        this.updateLogButtons();
                        this.updateProcessingLog();
                    });
                });
                
                // Log search
                document.getElementById('log-search').addEventListener('input', (e) => {
                    this.logSearchTerm = e.target.value;
                    this.updateProcessingLog();
                });
                
                // Fullscreen toggle
                document.getElementById('log-toggle-fullscreen').addEventListener('click', () => {
                    this.toggleLogFullscreen();
                });
                
                // Toggle wrap
                document.getElementById('log-toggle-wrap').addEventListener('click', () => {
                    this.toggleLogWrap();
                });
                
                document.getElementById('fullscreen-close').addEventListener('click', () => {
                    this.toggleLogFullscreen();
                });
                
                // Log clear
                document.getElementById('log-clear').addEventListener('click', () => {
                    this.debugLogs = [];
                    this.updateProcessingLog();
                });
                
                // Log export
                document.getElementById('log-export').addEventListener('click', () => {
                    this.exportLogs();
                });
                
                // Advanced tools
                document.getElementById('reload-calendar').addEventListener('click', () => {
                    this.debugLogs = [];
                    this.loadCalendarData(this.currentCity);
                });
                
                document.getElementById('test-parsing').addEventListener('click', () => {
                    this.testEventParsing();
                });
                
                document.getElementById('validate-data').addEventListener('click', () => {
                    this.validateAllEvents();
                });
                
                document.getElementById('benchmark').addEventListener('click', () => {
                    this.runBenchmark();
                });
                
                document.getElementById('download-raw').addEventListener('click', () => {
                    this.downloadData(this.rawCalendarData, `${this.currentCity}-calendar.ics`, 'text/calendar');
                });
                
                document.getElementById('download-json').addEventListener('click', () => {
                    const data = JSON.stringify(this.eventsData, null, 2);
                    this.downloadData(data, `${this.currentCity}-events.json`, 'application/json');
                });
                
                document.getElementById('compare-cities').addEventListener('click', () => {
                    this.compareCities();
                });
                
                document.getElementById('test-recurrence').addEventListener('click', () => {
                    this.testRecurrenceRules();
                });
                
                document.getElementById('test-timezone-conversion').addEventListener('click', () => {
                    this.runTimezoneTests();
                });
                
                document.getElementById('clear-logs').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.debugLogs = [];
                    this.updateProcessingLog();
                });
                
                document.getElementById('export-data').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.exportDebugData();
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Escape to exit fullscreen
                    if (e.key === 'Escape' && this.isLogFullscreen) {
                        this.toggleLogFullscreen();
                    }
                    
                    // Ctrl/Cmd + K to focus search
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        document.getElementById('log-search').focus();
                    }
                    
                    // Ctrl/Cmd + L to clear logs
                    if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                        e.preventDefault();
                        this.debugLogs = [];
                        this.updateProcessingLog();
                    }
                });
            }
            
            updateFilterButtons() {
                document.querySelectorAll('#filter-all, #filter-recurring, #filter-oneoff, #filter-errors').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`filter-${this.eventFilter}`).classList.add('active');
            }
            
            updateLogButtons() {
                document.querySelectorAll('#log-all, #log-debug, #log-info, #log-warn, #log-error').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`log-${this.logFilter}`).classList.add('active');
            }
            
            exportLogs() {
                const exportData = {
                    timestamp: new Date().toISOString(),
                    city: this.currentCity,
                    filters: {
                        level: this.logFilter,
                        components: Array.from(this.activeComponents),
                        search: this.logSearchTerm
                    },
                    logs: this.debugLogs
                };
                
                this.downloadData(JSON.stringify(exportData, null, 2), `logs-${this.currentCity}-${Date.now()}.json`, 'application/json');
            }
            
            testEventParsing() {
                logger.info('DEBUGGER', 'Starting event parsing test');
                
                const testCases = [
                    {
                        name: 'Simple event',
                        raw: 'SUMMARY:Test Event\\nLOCATION:Test Bar\\nDTSTART:20250115T190000'
                    },
                    {
                        name: 'Recurring event',
                        raw: 'SUMMARY:Weekly Test\\nRRULE:FREQ=WEEKLY;BYDAY=FR\\nDTSTART:20250110T200000'
                    },
                    {
                        name: 'Event with description',
                        raw: 'SUMMARY:Complex Event\\nDESCRIPTION:Bar Name: Test Bar\\\\nLink: https://example.com'
                    }
                ];
                
                testCases.forEach(test => {
                    logger.info('DEBUGGER', `Testing: ${test.name}`, { raw: test.raw });
                    // Parse would happen here
                });
                
                alert('Event parsing tests completed. Check the processing log for results.');
            }
            
            validateAllEvents() {
                logger.info('DEBUGGER', 'Starting event validation');
                
                const events = this.eventsData?.events || [];
                let errors = 0;
                let warnings = 0;
                
                events.forEach((event, index) => {
                    const issues = [];
                    
                    // Check required fields
                    if (!event.name) issues.push({ level: 'error', msg: 'Missing event name' });
                    if (!event.uid) issues.push({ level: 'error', msg: 'Missing UID' });
                    if (!event.startDate && !event.isRecurring) issues.push({ level: 'error', msg: 'Missing start date' });
                    
                    // Check optional but recommended fields
                    if (!event.barName) issues.push({ level: 'warn', msg: 'Missing venue name' });
                    if (!event.location) issues.push({ level: 'warn', msg: 'Missing location' });
                    
                    if (issues.length > 0) {
                        logger.warn('DEBUGGER', `Event ${index} validation issues`, { event, issues });
                        errors += issues.filter(i => i.level === 'error').length;
                        warnings += issues.filter(i => i.level === 'warn').length;
                    }
                });
                
                const message = `Validation complete: ${events.length} events checked, ${errors} errors, ${warnings} warnings`;
                logger.info('DEBUGGER', message);
                alert(message);
            }
            
            runBenchmark() {
                logger.info('DEBUGGER', 'Starting performance benchmark');
                
                const iterations = 10;
                const times = [];
                
                for (let i = 0; i < iterations; i++) {
                    const start = performance.now();
                    this.parseICalData(this.rawCalendarData);
                    const end = performance.now();
                    times.push(end - start);
                }
                
                const avg = times.reduce((a, b) => a + b, 0) / times.length;
                const min = Math.min(...times);
                const max = Math.max(...times);
                
                const result = `Benchmark Results (${iterations} iterations):\nAverage: ${avg.toFixed(2)}ms\nMin: ${min.toFixed(2)}ms\nMax: ${max.toFixed(2)}ms`;
                logger.info('DEBUGGER', result);
                alert(result);
            }
            
            downloadData(data, filename, type) {
                const blob = new Blob([data], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            compareCities() {
                // This would load multiple cities and compare their data
                logger.info('DEBUGGER', 'City comparison feature - coming soon!');
                alert('City comparison feature coming soon! This will allow comparing event counts, types, and venues across cities.');
            }
            
            testRecurrenceRules() {
                if (!this.selectedEvent || !this.selectedEvent.recurring) {
                    alert('Please select a recurring event first');
                    return;
                }
                
                logger.info('DEBUGGER', 'Testing recurrence rules for selected event');
                
                // Generate next 10 occurrences
                const testDates = [];
                const startDate = new Date();
                
                for (let i = 0; i < 52; i++) { // Check next 52 weeks
                    const testDate = new Date(startDate);
                    testDate.setDate(testDate.getDate() + (i * 7));
                    
                    if (this.isEventOccurringOnDate(this.selectedEvent, testDate)) {
                        testDates.push(testDate);
                        if (testDates.length >= 10) break;
                    }
                }
                
                const message = `Next 10 occurrences:\n${testDates.map(d => d.toLocaleDateString()).join('\n')}`;
                logger.info('DEBUGGER', 'Recurrence test results', { event: this.selectedEvent, occurrences: testDates });
                alert(message);
            }
            
            exportDebugData() {
                const exportData = {
                    timestamp: new Date().toISOString(),
                    city: this.currentCity,
                    cityConfig: this.currentCityConfig,
                    stats: {
                        totalEvents: this.eventsData?.events?.length || 0,
                        recurringEvents: this.eventsData?.events?.filter(e => e.isRecurring).length || 0,
                        parseTime: document.getElementById('parse-time').textContent
                    },
                    logs: this.debugLogs,
                    events: this.eventsData,
                    rawCalendarLength: this.rawCalendarData.length
                };
                
                this.downloadData(JSON.stringify(exportData, null, 2), `debug-export-${this.currentCity}-${Date.now()}.json`, 'application/json');
            }
            
            async renderDebugPage() {
                logger.componentInit('DEBUGGER', 'Rendering debug page');
                
                this.currentCity = this.getCityFromURL();
                this.currentCityConfig = getCityConfig(this.currentCity);
                
                if (!this.currentCityConfig) {
                    logger.error('DEBUGGER', `City not found: ${this.currentCity}`);
                    window.location.href = 'index.html';
                    return;
                }
                
                // Set up UI
                this.setupCityQuickSwitch();
                this.setupEventHandlers();
                this.setupTimezoneInfo();
                
                // Load calendar data
                try {
                    await this.loadCalendarData(this.currentCity);
                    this.updateStats();
                    this.displayEventList();
                } catch (error) {
                    logger.error('DEBUGGER', 'Failed to load calendar data', error);
                }
            }
            
            async init() {
                await this.renderDebugPage();
            }
        }
        
                 // Initialize debugger when DOM is ready
         document.addEventListener('DOMContentLoaded', () => {
             const calendarDebugger = new CalendarDebugger();
             calendarDebugger.init();
         });
    </script>
</body>
</html>