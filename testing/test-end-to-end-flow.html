<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bear Event Scraper - End-to-End Flow Validation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .header {
            background: #333;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .validation-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        
        .validation-item.success {
            background: #e8f5e8;
            border-left: 4px solid #4CAF50;
        }
        
        .validation-item.error {
            background: #ffe6e6;
            border-left: 4px solid #f44336;
        }
        
        .validation-item.info {
            background: #e6f3ff;
            border-left: 4px solid #2196F3;
        }
        
        .status-icon {
            margin-right: 10px;
            font-size: 16px;
        }
        
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
        }
        
        button:hover {
            background: #005a87;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .results {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
            overflow: hidden;
        }
        
        .console-output {
            background: #1e1e1e;
            color: #ffffff;
            padding: 20px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .module-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .module-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        
        .module-card h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .module-methods {
            font-size: 12px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üêª Bear Event Scraper - End-to-End Flow Validation</h1>
        <p>Comprehensive testing to ensure we're using actual downloaded libraries, not mock code</p>
    </div>

    <div class="test-section">
        <h2>Module Loading Validation</h2>
        <p>This test validates that we're loading and using the actual downloaded core modules from the <code>scripts/core/</code> directory.</p>
        
        <div id="module-validation"></div>
        
        <div class="module-info">
            <div class="module-card">
                <h4>InputAdapters</h4>
                <div class="module-methods">
                    Expected: createInputAdapter(), WebInputAdapter, ScriptableInputAdapter
                </div>
            </div>
            <div class="module-card">
                <h4>EventProcessor</h4>
                <div class="module-methods">
                    Expected: Constructor with enhanced bear keywords, city mapping, venue defaults
                </div>
            </div>
            <div class="module-card">
                <h4>DisplayAdapters</h4>
                <div class="module-methods">
                    Expected: createDisplayAdapter(), WebDisplayAdapter, ScriptableDisplayAdapter
                </div>
            </div>
        </div>
        
        <button onclick="validateModules()">Validate Module Loading</button>
    </div>

    <div class="test-section">
        <h2>End-to-End Flow Testing</h2>
        <p>Test the complete flow: Input ‚Üí Processing ‚Üí Display using actual modules</p>
        
        <button onclick="testMockFlow()">Test Mock Data Flow</button>
        <button onclick="testRealFlow()" id="realFlowBtn">Test Real Website Flow</button>
        <button onclick="clearResults()">Clear Results</button>
        
        <div id="flow-results"></div>
    </div>

    <div class="test-section">
        <h2>Module Functionality Deep Dive</h2>
        <p>Test specific functionality of each downloaded module</p>
        
        <button onclick="testInputAdapterFeatures()">Test Input Adapter Features</button>
        <button onclick="testEventProcessorFeatures()">Test Event Processor Features</button>
        <button onclick="testDisplayAdapterFeatures()">Test Display Adapter Features</button>
        
        <div id="deep-dive-results"></div>
    </div>

    <div class="test-section">
        <h2>Console Output</h2>
        <div id="console-output" class="console-output"></div>
    </div>

    <!-- Load the actual core modules -->
    <script src="../scripts/core/input-adapters.js"></script>
    <script src="../scripts/core/event-processor.js"></script>
    <script src="../scripts/core/display-adapters.js"></script>
    <script src="../scripts/bear-event-scraper-unified.js"></script>

    <script>
        // Console capture for display
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const consoleOutput = document.getElementById('console-output');
        
        function logToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üìù';
            consoleOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logToConsole(args.join(' '), 'error');
        };

        function createValidationItem(message, status, details = '') {
            const item = document.createElement('div');
            item.className = `validation-item ${status}`;
            
            const icon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            item.innerHTML = `
                <span class="status-icon">${icon}</span>
                <div>
                    <strong>${message}</strong>
                    ${details ? `<br><small>${details}</small>` : ''}
                </div>
            `;
            
            return item;
        }

        async function validateModules() {
            const container = document.getElementById('module-validation');
            container.innerHTML = '<p>Validating modules...</p>';
            
            const validations = [];
            
            try {
                // Check if modules are loaded
                if (typeof InputAdapters !== 'undefined') {
                    validations.push(createValidationItem(
                        'InputAdapters module loaded',
                        'success',
                        `Available methods: ${Object.keys(InputAdapters).join(', ')}`
                    ));
                    
                    // Test createInputAdapter
                    if (typeof InputAdapters.createInputAdapter === 'function') {
                        const adapter = InputAdapters.createInputAdapter();
                        validations.push(createValidationItem(
                            'InputAdapter instance created successfully',
                            'success',
                            `Environment detected: ${adapter.environment || 'unknown'}`
                        ));
                    } else {
                        validations.push(createValidationItem(
                            'createInputAdapter method missing',
                            'error'
                        ));
                    }
                } else {
                    validations.push(createValidationItem(
                        'InputAdapters module not loaded',
                        'error'
                    ));
                }
                
                // Check EventProcessor
                if (typeof EventProcessor !== 'undefined') {
                    validations.push(createValidationItem(
                        'EventProcessor module loaded',
                        'success',
                        'Constructor function available'
                    ));
                    
                    const processor = new EventProcessor({ enableDebugMode: true });
                    validations.push(createValidationItem(
                        'EventProcessor instance created',
                        'success',
                        `Bear keywords: ${processor.bearKeywords ? processor.bearKeywords.length : 0} loaded`
                    ));
                } else {
                    validations.push(createValidationItem(
                        'EventProcessor module not loaded',
                        'error'
                    ));
                }
                
                // Check DisplayAdapters
                if (typeof DisplayAdapters !== 'undefined') {
                    validations.push(createValidationItem(
                        'DisplayAdapters module loaded',
                        'success',
                        `Available methods: ${Object.keys(DisplayAdapters).join(', ')}`
                    ));
                    
                    if (typeof DisplayAdapters.createDisplayAdapter === 'function') {
                        const adapter = DisplayAdapters.createDisplayAdapter();
                        validations.push(createValidationItem(
                            'DisplayAdapter instance created successfully',
                            'success',
                            `Environment detected: ${adapter.environment || 'unknown'}`
                        ));
                    } else {
                        validations.push(createValidationItem(
                            'createDisplayAdapter method missing',
                            'error'
                        ));
                    }
                } else {
                    validations.push(createValidationItem(
                        'DisplayAdapters module not loaded',
                        'error'
                    ));
                }
                
                // Check BearEventScraper
                if (typeof BearEventScraper !== 'undefined') {
                    validations.push(createValidationItem(
                        'BearEventScraper class loaded',
                        'success',
                        'Main scraper class available'
                    ));
                    
                    const scraper = new BearEventScraper({ mockMode: true });
                    validations.push(createValidationItem(
                        'BearEventScraper instance created',
                        'success',
                        `Mock mode: ${scraper.config.mockMode}`
                    ));
                } else {
                    validations.push(createValidationItem(
                        'BearEventScraper class not loaded',
                        'error'
                    ));
                }
                
            } catch (error) {
                validations.push(createValidationItem(
                    'Module validation failed',
                    'error',
                    error.message
                ));
            }
            
            container.innerHTML = '';
            validations.forEach(item => container.appendChild(item));
        }

        async function testMockFlow() {
            const container = document.getElementById('flow-results');
            container.innerHTML = '<div class="validation-item info"><span class="status-icon">üîÑ</span><div>Testing mock data flow...</div></div>';
            
            try {
                console.log('üß™ Starting mock flow test...');
                
                const scraper = new BearEventScraper({
                    mockMode: true,
                    maxEvents: 10,
                    enableDebugMode: true
                });
                
                // Test the initialization
                await scraper.initialize();
                console.log('‚úÖ Scraper initialized successfully');
                
                // Validate modules are being used
                scraper.validateModules();
                console.log('‚úÖ Module validation passed');
                
                // Test with a single source first
                const testSources = [{
                    name: "Test Furball NYC",
                    parser: "furball",
                    url: "https://www.furball.nyc",
                    alwaysBear: true,
                    defaultCity: "nyc",
                    defaultVenue: "Test Venue"
                }];
                
                const results = await scraper.scrapeEvents(testSources);
                
                const validations = [
                    createValidationItem(
                        'Mock flow completed successfully',
                        'success',
                        `Found ${results.events.length} events (${results.bearEventCount} bear events)`
                    ),
                    createValidationItem(
                        'Using actual downloaded modules',
                        'success',
                        'No fallback to inline mock modules'
                    ),
                    createValidationItem(
                        'End-to-end flow validated',
                        'success',
                        'Input ‚Üí Processing ‚Üí Display pipeline working'
                    )
                ];
                
                container.innerHTML = '';
                validations.forEach(item => container.appendChild(item));
                
            } catch (error) {
                console.error('‚ùå Mock flow test failed:', error);
                container.innerHTML = '';
                container.appendChild(createValidationItem(
                    'Mock flow test failed',
                    'error',
                    error.message
                ));
            }
        }

        async function testRealFlow() {
            const container = document.getElementById('flow-results');
            const btn = document.getElementById('realFlowBtn');
            
            btn.disabled = true;
            btn.textContent = 'Testing Real Flow...';
            
            container.innerHTML = '<div class="validation-item info"><span class="status-icon">üåê</span><div>Testing real website flow (this may take longer)...</div></div>';
            
            try {
                console.log('üåê Starting real website flow test...');
                
                const scraper = new BearEventScraper({
                    mockMode: false,
                    maxEvents: 5,
                    enableDebugMode: true
                });
                
                await scraper.initialize();
                scraper.validateModules();
                
                // Test with one real source
                const testSources = [{
                    name: "Real Test Source",
                    parser: "generic",
                    url: "https://httpbin.org/html", // Safe test URL
                    defaultCity: "test",
                    defaultVenue: "Test Venue"
                }];
                
                const results = await scraper.scrapeEvents(testSources);
                
                const validations = [
                    createValidationItem(
                        'Real flow completed',
                        results.successfulSources > 0 ? 'success' : 'info',
                        `${results.successfulSources}/${results.totalSources} sources successful`
                    ),
                    createValidationItem(
                        'Network requests working',
                        'success',
                        'Able to fetch from real websites'
                    ),
                    createValidationItem(
                        'Full pipeline operational',
                        'success',
                        'Real data processing confirmed'
                    )
                ];
                
                container.innerHTML = '';
                validations.forEach(item => container.appendChild(item));
                
            } catch (error) {
                console.error('‚ùå Real flow test failed:', error);
                container.innerHTML = '';
                container.appendChild(createValidationItem(
                    'Real flow test failed',
                    'error',
                    error.message
                ));
            } finally {
                btn.disabled = false;
                btn.textContent = 'Test Real Website Flow';
            }
        }

        async function testInputAdapterFeatures() {
            const container = document.getElementById('deep-dive-results');
            container.innerHTML = '<p>Testing InputAdapter features...</p>';
            
            try {
                const adapter = InputAdapters.createInputAdapter();
                const validations = [];
                
                // Test environment detection
                validations.push(createValidationItem(
                    'Environment detection',
                    'success',
                    `Detected: ${adapter.environment}`
                ));
                
                // Test mock data fetch
                const mockResult = await adapter.fetchData({
                    url: 'https://test.com',
                    parser: 'furball',
                    mockMode: true
                });
                
                validations.push(createValidationItem(
                    'Mock data fetch',
                    mockResult.mock ? 'success' : 'error',
                    `HTML length: ${mockResult.html ? mockResult.html.length : 0} chars`
                ));
                
                container.innerHTML = '';
                validations.forEach(item => container.appendChild(item));
                
            } catch (error) {
                container.innerHTML = '';
                container.appendChild(createValidationItem(
                    'InputAdapter test failed',
                    'error',
                    error.message
                ));
            }
        }

        async function testEventProcessorFeatures() {
            const container = document.getElementById('deep-dive-results');
            container.innerHTML = '<p>Testing EventProcessor features...</p>';
            
            try {
                const processor = new EventProcessor({ enableDebugMode: true });
                const validations = [];
                
                // Test bear keyword detection
                const testEvent = { title: 'Bear Happy Hour', description: 'For all cubs and otters' };
                const isBear = processor.isBearEvent(testEvent, { alwaysBear: false });
                
                validations.push(createValidationItem(
                    'Bear keyword detection',
                    isBear ? 'success' : 'error',
                    `Detected bear event: ${isBear}`
                ));
                
                // Test enhanced features
                validations.push(createValidationItem(
                    'Enhanced bear keywords loaded',
                    processor.bearKeywords && processor.bearKeywords.length > 10 ? 'success' : 'error',
                    `${processor.bearKeywords ? processor.bearKeywords.length : 0} keywords loaded`
                ));
                
                validations.push(createValidationItem(
                    'City calendar mapping',
                    processor.cityCalendarMap ? 'success' : 'error',
                    `${processor.cityCalendarMap ? Object.keys(processor.cityCalendarMap).length : 0} cities mapped`
                ));
                
                validations.push(createValidationItem(
                    'Venue defaults',
                    processor.venueDefaults ? 'success' : 'error',
                    `${processor.venueDefaults ? Object.keys(processor.venueDefaults).length : 0} venues configured`
                ));
                
                container.innerHTML = '';
                validations.forEach(item => container.appendChild(item));
                
            } catch (error) {
                container.innerHTML = '';
                container.appendChild(createValidationItem(
                    'EventProcessor test failed',
                    'error',
                    error.message
                ));
            }
        }

        async function testDisplayAdapterFeatures() {
            const container = document.getElementById('deep-dive-results');
            container.innerHTML = '<p>Testing DisplayAdapter features...</p>';
            
            try {
                const adapter = DisplayAdapters.createDisplayAdapter();
                const validations = [];
                
                // Test different display formats
                const testResults = {
                    events: [
                        { title: 'Test Event', isBearEvent: true, date: new Date().toISOString() }
                    ],
                    source: 'Test Source'
                };
                
                // Test HTML display
                const htmlResult = await adapter.displayResults(testResults, { format: 'html' });
                validations.push(createValidationItem(
                    'HTML display format',
                    htmlResult.element ? 'success' : 'error',
                    'Generated HTML element'
                ));
                
                // Test JSON display
                const jsonResult = await adapter.displayResults(testResults, { format: 'json' });
                validations.push(createValidationItem(
                    'JSON display format',
                    jsonResult.text ? 'success' : 'error',
                    'Generated JSON output'
                ));
                
                // Test table display
                const tableResult = await adapter.displayResults(testResults, { format: 'table' });
                validations.push(createValidationItem(
                    'Table display format',
                    tableResult.element ? 'success' : 'error',
                    'Generated table element'
                ));
                
                container.innerHTML = '';
                validations.forEach(item => container.appendChild(item));
                
            } catch (error) {
                container.innerHTML = '';
                container.appendChild(createValidationItem(
                    'DisplayAdapter test failed',
                    'error',
                    error.message
                ));
            }
        }

        function clearResults() {
            document.getElementById('flow-results').innerHTML = '';
            document.getElementById('deep-dive-results').innerHTML = '';
            document.getElementById('console-output').textContent = '';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üêª Bear Event Scraper End-to-End Test Page Loaded');
            
            // Auto-validate modules on load
            setTimeout(validateModules, 500);
        });
    </script>
</body>
</html>