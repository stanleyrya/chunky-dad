<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validate Character Calculations - chunky.dad</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 20px;
            background: var(--background-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-section {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        
        .results {
            background: #fff;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
        }
        
        .event-name {
            font-size: var(--event-name-font-size);
            font-weight: var(--event-name-font-weight);
            line-height: var(--event-name-line-height);
            border: 2px solid red;
            margin: 5px;
            padding: 2px 4px;
            display: inline-block;
            background: white;
        }
        
        .measurement-element {
            border: 2px solid blue;
            background: lightblue;
        }
        
        .user-data {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .comparison-table th {
            background: #f0f0f0;
        }
        
        .highlight-difference {
            background: #ffe6e6;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Character Calculation Validation</h1>
        
        <div class="user-data">
            <h2>User's Test Data</h2>
            <p><strong>Debug Output:</strong> Viewport: 440 × 956, Chars/Line: 7, Event Width: 56px, Zoom: 100%</p>
            <p><strong>Manual Measurements:</strong> MEGAW = 5 chars, Megawo = 6 chars, div.event-name = 52px</p>
        </div>
        
        <div class="test-grid">
            <div class="test-section">
                <h3>Manual Test Elements</h3>
                <p>These replicate the user's manual test:</p>
                <div class="event-name">MEGAW</div>
                <div class="event-name">Megawo</div>
                <div class="event-name measurement-element">Sample Event</div>
            </div>
            
            <div class="test-section">
                <h3>Current Viewport</h3>
                <p><strong>Size:</strong> <span id="current-viewport">-</span></p>
                <p><strong>Zoom:</strong> <span id="current-zoom">-</span></p>
                <p><strong>Breakpoint:</strong> <span id="current-breakpoint">-</span></p>
            </div>
        </div>
        
        <div class="test-section">
            <h2>Measurement Results</h2>
            <button onclick="runFullTest()" style="padding: 10px 20px; margin: 10px 0; font-size: 16px;">Run Complete Measurement Test</button>
            <div id="results" class="results">Click the button above to run the test...</div>
        </div>
        
        <div class="test-section">
            <h2>Comparison Table</h2>
            <table class="comparison-table" id="comparison-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>User's Data</th>
                        <th>Our Calculation</th>
                        <th>Difference</th>
                    </tr>
                </thead>
                <tbody id="comparison-body">
                    <tr><td colspan="4">Run test to see comparison...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function updateCurrentInfo() {
            document.getElementById('current-viewport').textContent = `${window.innerWidth} × ${window.innerHeight}`;
            
            const visualZoom = (window.visualViewport && window.visualViewport.scale) || 1;
            document.getElementById('current-zoom').textContent = `${(visualZoom * 100).toFixed(0)}%`;
            
            const width = window.innerWidth;
            let breakpoint = 'unknown';
            if (width <= 374) breakpoint = 'xs';
            else if (width <= 767) breakpoint = 'sm';
            else if (width <= 1023) breakpoint = 'md';
            else breakpoint = 'lg';
            
            document.getElementById('current-breakpoint').textContent = breakpoint;
        }
        
        function runFullTest() {
            const resultsDiv = document.getElementById('results');
            const comparisonBody = document.getElementById('comparison-body');
            
            try {
                let output = 'COMPREHENSIVE CHARACTER CALCULATION TEST\n';
                output += '='.repeat(50) + '\n\n';
                
                // Test 1: Measure the visible elements
                const visibleElements = document.querySelectorAll('.event-name');
                output += `Found ${visibleElements.length} .event-name elements\n\n`;
                
                const measurements = [];
                visibleElements.forEach((element, index) => {
                    const rect = element.getBoundingClientRect();
                    const style = window.getComputedStyle(element);
                    
                    const paddingLeft = parseFloat(style.paddingLeft) || 0;
                    const paddingRight = parseFloat(style.paddingRight) || 0;
                    const borderLeft = parseFloat(style.borderLeftWidth) || 0;
                    const borderRight = parseFloat(style.borderRightWidth) || 0;
                    
                    const availableWidth = rect.width - paddingLeft - paddingRight - borderLeft - borderRight;
                    
                    const measurement = {
                        text: element.textContent,
                        charCount: element.textContent.length,
                        totalWidth: rect.width,
                        availableWidth: availableWidth,
                        padding: paddingLeft + paddingRight,
                        borders: borderLeft + borderRight,
                        pixelsPerChar: availableWidth / element.textContent.length
                    };
                    
                    measurements.push(measurement);
                    
                    output += `Element ${index + 1}: "${measurement.text}"\n`;
                    output += `  Total width: ${measurement.totalWidth.toFixed(2)}px\n`;
                    output += `  Available width: ${measurement.availableWidth.toFixed(2)}px\n`;
                    output += `  Padding: ${measurement.padding.toFixed(2)}px, Borders: ${measurement.borders.toFixed(2)}px\n`;
                    output += `  Pixels per char: ${measurement.pixelsPerChar.toFixed(2)}px\n\n`;
                });
                
                // Test 2: Calculate chars per pixel like the calendar loader does
                const testElement = document.createElement('div');
                testElement.className = 'event-name';
                testElement.style.cssText = `
                    position: absolute;
                    visibility: hidden;
                    white-space: nowrap;
                    font-family: 'Poppins', sans-serif;
                    font-size: var(--event-name-font-size);
                    font-weight: var(--event-name-font-weight);
                    line-height: var(--event-name-line-height);
                `;
                
                const testString = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789- ';
                testElement.textContent = testString;
                document.body.appendChild(testElement);
                
                const testWidth = testElement.getBoundingClientRect().width;
                const testCharCount = testString.length;
                const pixelsPerChar = testWidth / testCharCount;
                const charsPerPixel = 1 / pixelsPerChar;
                
                document.body.removeChild(testElement);
                
                output += 'Character Calculation Logic:\n';
                output += `  Test string: "${testString}"\n`;
                output += `  Test string width: ${testWidth.toFixed(2)}px\n`;
                output += `  Test string length: ${testCharCount} chars\n`;
                output += `  Pixels per char: ${pixelsPerChar.toFixed(4)}px\n`;
                output += `  Chars per pixel: ${charsPerPixel.toFixed(4)}\n\n`;
                
                // Test 3: Apply calculation to user's test strings
                if (measurements.length > 0) {
                    const sampleWidth = measurements[0].availableWidth;
                    const expectedCharsInWidth = Math.floor(sampleWidth * charsPerPixel);
                    
                    output += 'Applied to User Test Data:\n';
                    output += `  Available width: ${sampleWidth.toFixed(2)}px\n`;
                    output += `  Expected chars that fit: ${expectedCharsInWidth}\n`;
                    output += `  User reported chars/line: 7\n`;
                    output += `  Difference: ${expectedCharsInWidth - 7}\n\n`;
                }
                
                resultsDiv.textContent = output;
                
                // Update comparison table
                updateComparisonTable(measurements, charsPerPixel);
                
            } catch (error) {
                resultsDiv.textContent = 'Error: ' + error.message;
                console.error('Test error:', error);
            }
        }
        
        function updateComparisonTable(measurements, charsPerPixel) {
            const tbody = document.getElementById('comparison-body');
            
            if (measurements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">No measurements available</td></tr>';
                return;
            }
            
            const sampleMeasurement = measurements[0];
            const ourCharsPerLine = Math.floor(sampleMeasurement.availableWidth * charsPerPixel);
            
            const rows = [
                {
                    metric: 'Viewport',
                    user: '440 × 956',
                    ours: `${window.innerWidth} × ${window.innerHeight}`,
                    difference: 'Different screen'
                },
                {
                    metric: 'Event Width',
                    user: '56px',
                    ours: `${sampleMeasurement.totalWidth.toFixed(0)}px`,
                    difference: `${(sampleMeasurement.totalWidth - 56).toFixed(1)}px`
                },
                {
                    metric: 'Available Width',
                    user: '52px (estimated)',
                    ours: `${sampleMeasurement.availableWidth.toFixed(0)}px`,
                    difference: `${(sampleMeasurement.availableWidth - 52).toFixed(1)}px`
                },
                {
                    metric: 'Chars/Line',
                    user: '7',
                    ours: `${ourCharsPerLine}`,
                    difference: `${ourCharsPerLine - 7}`
                }
            ];
            
            tbody.innerHTML = rows.map(row => `
                <tr>
                    <td>${row.metric}</td>
                    <td>${row.user}</td>
                    <td>${row.ours}</td>
                    <td class="${Math.abs(parseFloat(row.difference)) > 2 ? 'highlight-difference' : ''}">${row.difference}</td>
                </tr>
            `).join('');
        }
        
        // Update current info on load and resize
        updateCurrentInfo();
        window.addEventListener('resize', updateCurrentInfo);
        
        // Auto-run test on load
        setTimeout(runFullTest, 500);
    </script>
</body>
</html>