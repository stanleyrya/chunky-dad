<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Conflict Display Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #event-display {
            margin-top: 20px;
        }
        /* Event card styles from scriptable adapter */
        .event-card {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        .action-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        .badge-warning {
            background: #ff9500;
        }
        .event-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-right: 100px;
        }
        .event-details {
            margin-top: 10px;
        }
        .event-detail {
            display: flex;
            align-items: flex-start;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .event-detail > span:first-child {
            margin-right: 8px;
            flex-shrink: 0;
        }
        .event-metadata {
            margin-top: 10px;
            font-size: 11px;
            color: #666;
        }
        .conflict-info {
            margin-top: 15px;
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
        }
        table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th {
            text-align: left;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        td {
            padding: 5px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Time Conflict Display Test</h1>
        
        <div class="test-info">
            <h3>Test Scenario</h3>
            <p>Testing the display of a MEGAWOOF event with <code>_action: "time_conflict"</code> that should show merge comparison.</p>
            <p>The event has merge information and should display a diff view showing how fields will be merged.</p>
        </div>
        
        <div id="event-display">
            <!-- Event display will be rendered here -->
        </div>
    </div>

    <script>
        // Test event data from the user
        const testEvent = {
            "title": "MEGAWOOF",
            "startDate": "2025-08-17T05:00:00Z",
            "endDate": "2025-08-17T10:00:00Z",
            "location": "34.043925, -118.24242909999998",
            "notes": "Bar: TBA\nShort Name: MEGA-WOOF\nInstagram: https://www.instagram.com/megawoof_america\nWebsite: https://www.eventbrite.com/e/duro-summer-night-foam-edition-tickets-1446957562019\nGmaps: https://maps.google.com/?q=34.043925,-118.24242909999998\n\nKey: megawoof|2025-08-17|tba\nDebugCity: la\nDebugSource: eventbrite\nDebugImage: https://img.evbuc.com/https%3A%2F%2Fcdn.evbuc.com%2Fimages%2F1074412243%2F185013722403%2F1%2Foriginal.20250716-002220?crop=focalpoint&fit=crop&h=230&w=460&auto=format%2Ccompress&q=75&sharp=10&fp-x=0.5&fp-y=0.5&s=59b8e3f4c9f6ab9142960372a78ee67d",
            "city": "la",
            "key": "megawoof|2025-08-17|tba",
            "_parserConfig": {
                "name": "Megawoof America",
                "parser": "eventbrite"
            },
            "_fieldMergeStrategies": {
                "title": "clobber",
                "shortTitle": "upsert",
                "instagram": "clobber",
                "description": "preserve",
                "venue": "clobber",
                "startDate": "clobber",
                "endDate": "clobber",
                "website": "upsert",
                "gmaps": "upsert"
            },
            "description": "Location TBA, but likely in a dark DTLA warehouse 😈 Be sure to follow them on IG for location, updates, and more!",
            "venue": "TBA",
            "address": "DTLA , Los Angeles, CA 90013",
            "coordinates": {
                "lat": "34.043925",
                "lng": "-118.24242909999998"
            },
            "url": "https://www.eventbrite.com/e/duro-summer-night-foam-edition-tickets-1446957562019",
            "price": "",
            "image": "https://img.evbuc.com/https%3A%2F%2Fcdn.evbuc.com%2Fimages%2F1074412243%2F185013722403%2F1%2Foriginal.20250716-002220?crop=focalpoint&fit=crop&h=230&w=460&auto=format%2Ccompress&q=75&sharp=10&fp-x=0.5&fp-y=0.5&s=59b8e3f4c9f6ab9142960372a78ee67d",
            "source": "eventbrite",
            "isBearEvent": true,
            "shortTitle": "MEGA-WOOF",
            "instagram": "https://www.instagram.com/megawoof_america",
            "googleMapsLink": "https://maps.google.com/?q=34.043925,-118.24242909999998",
            "_analysis": {
                "action": "conflict",
                "reason": "Time conflict detected",
                "conflictType": "time_conflict"
            },
            "_action": "time_conflict",
            "_conflicts": [
                {
                    "identifier": "2DDBF0E6-6877-4FBF-BB94-EC2708DFD113:1o1kijpavt9mfq2f5bbtcj4jng@google.com",
                    "title": "Megawoof: DURO",
                    "location": null,
                    "notes": "Tea: Location TBA, but likely in a dark DTLA warehouse 😈 Be sure to follow them on IG for location, updates, and more! \nInstagram: https://www.instagram.com/megawoof_america?igsh=MWg3dHltdmpwYjZzaQ==",
                    "startDate": "2025-08-17T05:00:00.000Z",
                    "endDate": "2025-08-17T09:00:00.000Z",
                    "isAllDay": false,
                    "attendees": null,
                    "availability": "busy",
                    "timeZone": "America/Los_Angeles",
                    "calendar": {
                        "identifier": "45253F79-77B1-49C5-B0DF-4FBD7D22BB44",
                        "title": "chunky-dad-la",
                        "isSubscribed": false,
                        "allowsContentModifications": true,
                        "color": {
                            "hex": "CD74E6",
                            "red": 0.8039215803146362,
                            "green": 0.45490193367004395,
                            "blue": 0.9019607901573181,
                            "alpha": 1
                        }
                    }
                }
            ],
            "_original": {
                "new": {
                    "title": "MEGAWOOF",
                    "startDate": "2025-08-17T05:00:00Z",
                    "endDate": "2025-08-17T10:00:00Z",
                    "location": "34.043925, -118.24242909999998",
                    "notes": "Bar: TBA\nShort Name: MEGA-WOOF\nInstagram: https://www.instagram.com/megawoof_america\nWebsite: https://www.eventbrite.com/e/duro-summer-night-foam-edition-tickets-1446957562019\nGmaps: https://maps.google.com/?q=34.043925,-118.24242909999998\n\nKey: megawoof|2025-08-17|tba\nDebugCity: la\nDebugSource: eventbrite\nDebugImage: https://img.evbuc.com/https%3A%2F%2Fcdn.evbuc.com%2Fimages%2F1074412243%2F185013722403%2F1%2Foriginal.20250716-002220?crop=focalpoint&fit=crop&h=230&w=460&auto=format%2Ccompress&q=75&sharp=10&fp-x=0.5&fp-y=0.5&s=59b8e3f4c9f6ab9142960372a78ee67d",
                    "city": "la",
                    "key": "megawoof|2025-08-17|tba",
                    "_parserConfig": {
                        "name": "Megawoof America",
                        "parser": "eventbrite"
                    },
                    "_fieldMergeStrategies": {
                        "title": "clobber",
                        "shortTitle": "upsert",
                        "instagram": "clobber",
                        "description": "preserve",
                        "venue": "clobber",
                        "startDate": "clobber",
                        "endDate": "clobber",
                        "website": "upsert",
                        "gmaps": "upsert"
                    },
                    "description": "D>U>R>O!  L O S   A N G E L E S.    S U M M E R",
                    "venue": "TBA",
                    "address": "DTLA , Los Angeles, CA 90013",
                    "coordinates": {
                        "lat": "34.043925",
                        "lng": "-118.24242909999998"
                    },
                    "url": "https://www.eventbrite.com/e/duro-summer-night-foam-edition-tickets-1446957562019",
                    "price": "",
                    "image": "https://img.evbuc.com/https%3A%2F%2Fcdn.evbuc.com%2Fimages%2F1074412243%2F185013722403%2F1%2Foriginal.20250716-002220?crop=focalpoint&fit=crop&h=230&w=460&auto=format%2Ccompress&q=75&sharp=10&fp-x=0.5&fp-y=0.5&s=59b8e3f4c9f6ab9142960372a78ee67d",
                    "source": "eventbrite",
                    "isBearEvent": true,
                    "shortTitle": "MEGA-WOOF",
                    "instagram": "https://www.instagram.com/megawoof_america",
                    "googleMapsLink": "https://maps.google.com/?q=34.043925,-118.24242909999998"
                },
                "existing": {
                    "identifier": "2DDBF0E6-6877-4FBF-BB94-EC2708DFD113:1o1kijpavt9mfq2f5bbtcj4jng@google.com",
                    "title": "Megawoof: DURO",
                    "location": null,
                    "notes": "Tea: Location TBA, but likely in a dark DTLA warehouse 😈 Be sure to follow them on IG for location, updates, and more! \nInstagram: https://www.instagram.com/megawoof_america?igsh=MWg3dHltdmpwYjZzaQ==",
                    "startDate": "2025-08-17T05:00:00.000Z",
                    "endDate": "2025-08-17T09:00:00.000Z",
                    "isAllDay": false,
                    "attendees": null,
                    "availability": "busy",
                    "timeZone": "America/Los_Angeles",
                    "calendar": {
                        "identifier": "45253F79-77B1-49C5-B0DF-4FBD7D22BB44",
                        "title": "chunky-dad-la",
                        "isSubscribed": false,
                        "allowsContentModifications": true,
                        "color": {
                            "hex": "CD74E6",
                            "red": 0.8039215803146362,
                            "green": 0.45490193367004395,
                            "blue": 0.9019607901573181,
                            "alpha": 1
                        }
                    }
                }
            },
            "_mergeInfo": {
                "extractedFields": {
                    "tea": {
                        "value": "Location TBA, but likely in a dark DTLA warehouse 😈 Be sure to follow them on IG for location, updates, and more!",
                        "source": "existing.notes"
                    },
                    "description": {
                        "value": "Location TBA, but likely in a dark DTLA warehouse 😈 Be sure to follow them on IG for location, updates, and more!",
                        "source": "existing.notes"
                    },
                    "instagram": {
                        "value": "https://www.instagram.com/megawoof_america",
                        "source": "existing.notes"
                    }
                },
                "mergedFields": {
                    "tea": "existing",
                    "description": "existing"
                },
                "strategy": {
                    "title": "clobber",
                    "shortTitle": "upsert",
                    "instagram": "clobber",
                    "description": "preserve",
                    "venue": "clobber",
                    "startDate": "clobber",
                    "endDate": "clobber",
                    "website": "upsert",
                    "gmaps": "upsert"
                }
            },
            "tea": "Location TBA, but likely in a dark DTLA warehouse 😈 Be sure to follow them on IG for location, updates, and more!"
        };

        // Simplified version of the generateEventCard method
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function generateEventCard(event) {
            const actionBadge = {
                'new': '<span class="action-badge badge-new">NEW</span>',
                'update': '<span class="action-badge badge-update">UPDATE</span>',
                'merge': '<span class="action-badge badge-merge">MERGE</span>',
                'conflict': '<span class="action-badge badge-warning">CONFLICT</span>',
                'key_conflict': '<span class="action-badge badge-warning">KEY MISMATCH</span>',
                'time_conflict': '<span class="action-badge badge-warning">TIME OVERLAP</span>',
                'missing_calendar': '<span class="action-badge badge-error">MISSING CALENDAR</span>'
            }[event._action] || '';
            
            const eventDate = new Date(event.startDate);
            const endDate = event.endDate ? new Date(event.endDate) : null;
            const dateStr = eventDate.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
            const timeStr = eventDate.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit' 
            });
            const endTimeStr = endDate ? endDate.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit' 
            }) : '';
            
            let html = `
            <div class="event-card">
                ${actionBadge}
                <div class="event-title">${escapeHtml(event.title || event.name)}</div>
                
                <!-- Main Event Info -->
                <div class="event-details">
                    ${event.venue || event.bar ? `
                        <div class="event-detail">
                            <span>📍</span>
                            <span>${escapeHtml(event.venue || event.bar)}</span>
                        </div>
                    ` : ''}
                    <div class="event-detail">
                        <span>📅</span>
                        <span>${dateStr} ${timeStr}${endTimeStr ? ` - ${endTimeStr}` : ''}</span>
                    </div>
                    ${event.city ? `
                        <div class="event-detail">
                            <span>🌍</span>
                            <span>${escapeHtml(event.city.toUpperCase())}</span>
                        </div>
                    ` : ''}
                    ${event.tea ? `
                        <div class="event-detail" style="background: #e8f5e9; padding: 8px; border-radius: 5px; margin-top: 8px;">
                            <span>☕</span>
                            <span style="font-style: italic;">${escapeHtml(event.tea)}</span>
                        </div>
                    ` : ''}
                    ${event.instagram ? `
                        <div class="event-detail">
                            <span>📸</span>
                            <span><a href="${escapeHtml(event.instagram)}" style="color: #007aff;">Instagram</a></span>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Show comparison if we have original data -->
                ${event._original && (event._action === 'conflict' || event._action === 'time_conflict') ? `
                    <div style="margin-top: 15px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; font-size: 14px;">📊 Conflict Resolution</h4>
                        </div>
                        
                        <!-- Show what was extracted -->
                        ${event._mergeInfo?.extractedFields && Object.keys(event._mergeInfo.extractedFields).length > 0 ? `
                            <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                <strong style="font-size: 12px;">Extracted from existing event:</strong>
                                ${Object.entries(event._mergeInfo.extractedFields).map(([field, info]) => `
                                    <div style="margin-top: 5px; font-size: 12px;">
                                        • <strong>${field}:</strong> "${escapeHtml(info.value)}"
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <!-- Table view -->
                        <div>
                            <table>
                                <tr>
                                    <th style="width: 20%;">Field</th>
                                    <th style="width: 30%;">Existing Event</th>
                                    <th style="width: 10%; text-align: center;">Flow</th>
                                    <th style="width: 30%;">New Event</th>
                                    <th style="width: 10%;">Result</th>
                                </tr>
                                ${generateComparisonRows(event)}
                            </table>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Simplified metadata -->
                ${event.key || event.source ? `
                    <div class="event-metadata">
                        ${event.source ? `<span>Source: ${event.source}</span>` : ''}
                        ${event.key ? `<span style="margin-left: 10px;">Key: ${escapeHtml(event.key)}</span>` : ''}
                    </div>
                ` : ''}
                
                ${(event._action === 'key_conflict' || event._action === 'time_conflict') && event._conflicts ? `
                    <div class="conflict-info">
                        <strong>⚠️ Overlapping Events:</strong> ${event._conflicts.length} event(s) at same time
                        <div style="margin-top: 10px;">
                        ${event._conflicts.map(conflict => `
                            <div style="background: #d4edda; padding: 8px; border-radius: 5px; margin-bottom: 5px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>"${escapeHtml(conflict.title)}"</strong>
                                        <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                            ${new Date(conflict.startDate).toLocaleString()}
                                        </div>
                                    </div>
                                    <div style="font-size: 12px; font-weight: 600; color: #155724;">
                                        ✓ Will Merge
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
            `;
            
            return html;
        }

        function generateComparisonRows(event) {
            if (!event._original) return '';
            
            const fieldsToCompare = ['title', 'venue', 'tea', 'instagram', 'website', 'gmaps', 'price', 'startDate', 'endDate'];
            const rows = [];
            
            fieldsToCompare.forEach(field => {
                let newValue = event._original.new[field] || '';
                let existingValue = event._original.existing?.[field] || '';
                const finalValue = event[field] || '';
                const strategy = event._fieldMergeStrategies?.[field] || 'preserve';
                const wasUsed = event._mergeInfo?.mergedFields?.[field];
                
                // Check if this field was extracted from existing event's notes
                if (!existingValue && event._mergeInfo?.extractedFields?.[field]) {
                    existingValue = event._mergeInfo.extractedFields[field].value;
                }
                
                // Skip if both are empty and no final value
                if (!newValue && !existingValue && !finalValue) return;
                
                // Format values for display
                const formatValue = (val, maxLength = 30) => {
                    if (!val) return '<em style="color: #999;">empty</em>';
                    if (field.includes('Date') && val) {
                        return new Date(val).toLocaleString('en-US', { 
                            month: 'short', 
                            day: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit'
                        });
                    }
                    const str = val.toString();
                    if (str.length > maxLength) {
                        return `<span title="${escapeHtml(str)}">${escapeHtml(str.substring(0, maxLength))}...</span>`;
                    }
                    return escapeHtml(str);
                };
                
                // Determine flow direction and result
                let flowIcon = '';
                let resultText = '';
                
                if (!existingValue && newValue) {
                    flowIcon = '→';
                    resultText = '<span style="color: #34c759;">ADDED</span>';
                } else if (existingValue && newValue && existingValue === newValue) {
                    flowIcon = '—';
                    resultText = '<span style="color: #999;">NO CHANGE</span>';
                } else if (wasUsed === 'existing') {
                    flowIcon = '←';
                    resultText = '<span style="color: #007aff;">EXISTING</span>';
                } else if (finalValue === newValue) {
                    flowIcon = '→';
                    resultText = '<span style="color: #ff9500;">NEW</span>';
                } else if (finalValue && finalValue !== existingValue && finalValue !== newValue) {
                    flowIcon = '↔';
                    resultText = '<span style="color: #32d74b;">MERGED</span>';
                } else {
                    flowIcon = '—';
                    resultText = '<span style="color: #999;">NO CHANGE</span>';
                }
                
                rows.push(`
                    <tr>
                        <td>
                            <strong>${field}</strong>
                            <br><small style="color: #666;">${strategy}</small>
                        </td>
                        <td style="word-break: break-word;">
                            ${formatValue(existingValue)}
                        </td>
                        <td style="text-align: center; font-size: 16px; color: #007aff;">
                            ${flowIcon}
                        </td>
                        <td style="word-break: break-word;">
                            ${formatValue(newValue)}
                        </td>
                        <td style="text-align: center;">
                            ${resultText}
                        </td>
                    </tr>
                `);
            });
            
            return rows.join('');
        }

        // Render the test event
        document.getElementById('event-display').innerHTML = generateEventCard(testEvent);
    </script>
</body>
</html>