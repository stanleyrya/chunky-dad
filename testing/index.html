<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Toolbox | chunky.dad</title>
  <meta name="description" content="Toolbox for chunky.dad test pages and utilities.">
  <link rel="icon" type="image/x-icon" href="/favicons/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
  <link rel="manifest" href="/favicons/site.webmanifest">
  <meta name="theme-color" content="#667eea">
  <link rel="stylesheet" href="../styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body class="toolbox-page">
  <header>
    <nav>
      <div class="nav-container">
        <div class="logo">
          <h1>
            <a href="../index.html">
              <img src="../favicons/favicon-192x192.png" alt="chunky.dad logo" class="logo-img">
              chunky.dad/tools
            </a>
          </h1>
        </div>
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </nav>
  </header>

  <main class="toolbox-main">
    <section class="toolbox-hero">
      <div class="container">
        <div class="toolbox-hero-card">
          <div class="toolbox-hero-text">
            <span class="toolbox-kicker">Tool Shed</span>
            <h1>chunky.dad Toolbox</h1>
            <p>Cute toolbox, subversive gay vibes, big dad energy. Grab a tool and get weird.</p>
            <div class="toolbox-actions">
              <a class="toolbox-button" href="../index.html">Back to main site</a>
              <a class="toolbox-button secondary" href="../bear-directory.html">Bear directory</a>
            </div>
          </div>
          <div class="toolbox-hero-aside">
            <div class="toolbox-badges">
              <span class="toolbox-badge">Cute</span>
              <span class="toolbox-badge">Subversive</span>
              <span class="toolbox-badge">Dad Energy</span>
            </div>
            <div class="toolbox-hero-note">
              <span class="toolbox-note-title">Small page, big tools</span>
              <p>Two-column layout so you can scan the whole kit fast.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="toolbox-content">
      <div class="container">
        <div class="toolbox-toolbar">
          <div class="toolbox-toolbar-text">
            <span class="toolbox-toolbar-label">Choose a tool</span>
            <p>Open any test page to tinker, debug, or stress a layout.</p>
          </div>
          <div class="toolbox-stats" id="toolbox-stats">Loading tools...</div>
        </div>

        <details class="toolbox-debug" id="debug-info" hidden>
          <summary>Load details</summary>
          <div id="debug-content" class="toolbox-debug-list"></div>
        </details>

        <div id="file-grid" class="toolbox-grid">
          <div class="toolbox-loading">Loading tools...</div>
        </div>
      </div>
    </section>
  </main>

  <footer class="toolbox-footer">
    <div class="container">
      <div class="toolbox-footer-inner">
        <span class="toolbox-footer-icons">üß∞ üîß ‚öíÔ∏è</span>
        <p>Built for cute chaos, subversive joy, and steady dad hands.</p>
      </div>
    </div>
  </footer>

  <script>
    function getFileInfo(file) {
      const baseName = file.name.replace('.html', '');

      return {
        icon: file.icon || 'üß∞',
        desc: file.description || 'Test file',
        displayName: baseName.replace(/-/g, ' ').replace(/\b\w/g, (letter) => letter.toUpperCase())
      };
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
      return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    }

    function setupDebugPanel() {
      const debugInfo = document.getElementById('debug-info');
      const debugContent = document.getElementById('debug-content');
      const debugEnabled = new URLSearchParams(window.location.search).has('debug');

      if (!debugInfo || !debugContent) {
        return {
          addEntry: () => {},
          reveal: () => {}
        };
      }

      debugInfo.hidden = !debugEnabled;
      if (debugEnabled) {
        debugInfo.open = true;
      }

      const reveal = (open = false) => {
        if (debugInfo.hidden) {
          debugInfo.hidden = false;
        }
        if (open) {
          debugInfo.open = true;
        }
      };

      const addEntry = (type, message) => {
        const shouldReveal = debugEnabled || type === 'warn' || type === 'error';
        if (shouldReveal) {
          reveal(type === 'error' || type === 'warn');
        }

        const entry = document.createElement('div');
        entry.className = `toolbox-debug-item ${type}`;
        entry.textContent = message;
        debugContent.appendChild(entry);
      };

      return { addEntry, reveal };
    }

    async function parseDirectoryListing() {
      try {
        const response = await fetch('./');
        const text = await response.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/html');

        const files = [];
        const links = doc.querySelectorAll('a');
        for (const link of links) {
          const href = link.getAttribute('href');
          if (href && href.endsWith('.html') && !href.includes('/') && href !== 'index.html') {
            files.push({
              name: href,
              displayText: link.textContent.trim(),
              exists: true
            });
          }
        }

        if (files.length === 0) {
          const rows = doc.querySelectorAll('tr');
          for (const row of rows) {
            const link = row.querySelector('a');
            if (link) {
              const href = link.getAttribute('href');
              if (href && href.endsWith('.html') && !href.includes('/') && href !== 'index.html') {
                files.push({
                  name: href,
                  exists: true
                });
              }
            }
          }
        }

        return files;
      } catch (error) {
        return null;
      }
    }

    async function loadTestFiles() {
      const debugPanel = setupDebugPanel();
      const fileGrid = document.getElementById('file-grid');

      try {
        let testFiles = [];

        try {
          const manifestResponse = await fetch('./manifest.json', { cache: 'no-cache' });
          debugPanel.addEntry('info', `Manifest fetch: ${manifestResponse.status} ${manifestResponse.statusText}`);

          if (manifestResponse.ok) {
            const manifest = await manifestResponse.json();
            testFiles = manifest.files.filter((file) => file.name !== 'index.html');
            debugPanel.addEntry('success', `Loaded ${testFiles.length} files from manifest.json`);
          } else {
            debugPanel.addEntry('warn', 'Manifest fetch failed, trying directory listing.');
          }
        } catch (error) {
          debugPanel.addEntry('error', `Error loading manifest: ${error.message}`);
        }

        if (testFiles.length === 0) {
          const parsedFiles = await parseDirectoryListing();

          if (parsedFiles && parsedFiles.length > 0) {
            testFiles = parsedFiles;
            debugPanel.addEntry('success', `Loaded ${testFiles.length} files from directory listing`);
          } else {
            debugPanel.addEntry('warn', 'Directory listing empty, probing known files.');
            const allKnownFiles = [
              'ultimate-style-tester.html',
              'style-test.html',
              'event-test-index.html',
              'event-test-1-carousel.html',
              'event-test-2-timeline.html',
              'event-test-3-map.html',
              'event-test-4-masonry.html',
              'event-test-5-heatmap.html',
              'event-test-6-ticker.html',
              'event-test-7-circular.html',
              'event-test-8-kanban.html',
              'event-test-9-bubbles.html',
              'event-test-10-flipcards.html',
              'event-test-11-weekview.html',
              'event-test-12-swipe-tiles.html',
              'test-calendar-logging.html',
              'test-google-sheets-loader.html',
              'test-display-modes.html',
              'event-builder.html',
              'css-breakpoint-test.html',
              'multiline-breakpoint-test.html',
              'hyphenation-test.html',
              'simplified-hyphenation-test.html',
              'test-event-abbreviation.html'
            ];

            const fileChecks = allKnownFiles.map(async (filename) => {
              try {
                const response = await fetch(filename, { method: 'HEAD' });
                if (response.ok) {
                  const contentLength = response.headers.get('content-length');
                  return {
                    name: filename,
                    exists: true,
                    size: contentLength ? parseInt(contentLength, 10) : null
                  };
                }
              } catch (error) {
                return null;
              }
              return null;
            });

            const results = await Promise.all(fileChecks);
            testFiles = results.filter((file) => file !== null);
            debugPanel.addEntry('success', `Loaded ${testFiles.length} files from probe`);
          }
        }

        testFiles.sort((a, b) => a.name.localeCompare(b.name));
        displayFiles(testFiles);
      } catch (error) {
        if (fileGrid) {
          fileGrid.innerHTML = `
            <div class="toolbox-error">
              <h3>Toolbox misfire</h3>
              <p>Dad dropped the wrench: ${error.message}</p>
            </div>
          `;
        }
      }
    }

    function displayFiles(files) {
      const existingFiles = files.filter((file) => file.exists !== false);
      const statsEl = document.getElementById('toolbox-stats');
      const container = document.getElementById('file-grid');

      if (statsEl) {
        statsEl.textContent = `${existingFiles.length} tool${existingFiles.length !== 1 ? 's' : ''} ready`;
      }

      if (!container) {
        return;
      }

      container.innerHTML = '';

      if (existingFiles.length === 0) {
        container.innerHTML = `
          <div class="toolbox-empty">
            <h3>Empty tool shed</h3>
            <p>No test files found in the testing directory.</p>
          </div>
        `;
        return;
      }

      existingFiles.forEach((file) => {
        const fileInfo = getFileInfo(file);
        const card = document.createElement('a');
        card.href = file.name;
        card.className = 'toolbox-card';
        card.innerHTML = `
          <span class="toolbox-card-icon">${fileInfo.icon}</span>
          <div class="toolbox-card-body">
            <div class="toolbox-card-title">
              <h3>${fileInfo.displayName}</h3>
              <span class="toolbox-card-arrow">‚Üí</span>
            </div>
            <div class="toolbox-card-meta">
              <span class="toolbox-card-file">${file.name}</span>
              ${file.size ? `<span class="toolbox-card-size">${formatFileSize(file.size)}</span>` : ''}
            </div>
            <p class="toolbox-card-desc">${fileInfo.desc}</p>
          </div>
        `;
        container.appendChild(card);
      });
    }

    loadTestFiles();
  </script>
</body>
</html>
