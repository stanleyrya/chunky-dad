<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventbrite Parser Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-section {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .warning {
            color: orange;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Eventbrite Parser Debug Test</h1>
    <p>This test helps debug the Eventbrite parsing issues by testing the enhanced logging and JSON parsing improvements.</p>
    
    <div class="test-section">
        <h3>Test 1: Enhanced Logging Validation</h3>
        <p>Test that our enhanced logging is working correctly with mock data.</p>
        <button onclick="testEnhancedLogging()">Run Enhanced Logging Test</button>
        <div id="logging-results" class="log"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 2: JSON Structure Detection</h3>
        <p>Test the improved JSON structure detection for different Eventbrite page types.</p>
        <button onclick="testJsonStructures()">Run JSON Structure Test</button>
        <div id="json-results" class="log"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 3: isEventObject Improvements</h3>
        <p>Test the enhanced event object detection logic.</p>
        <button onclick="testEventObjectDetection()">Run Event Object Test</button>
        <div id="event-results" class="log"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 4: Alternative Structure Search</h3>
        <p>Test the new alternative JSON structure search functionality.</p>
        <button onclick="testAlternativeSearch()">Run Alternative Search Test</button>
        <div id="alternative-results" class="log"></div>
    </div>

    <script>
        // Mock console to capture logs
        function createMockConsole(outputElement) {
            return {
                log: (msg) => {
                    outputElement.innerHTML += msg + '\n';
                    outputElement.scrollTop = outputElement.scrollHeight;
                },
                warn: (msg) => {
                    outputElement.innerHTML += '<span class="warning">WARN: ' + msg + '</span>\n';
                    outputElement.scrollTop = outputElement.scrollHeight;
                },
                error: (msg) => {
                    outputElement.innerHTML += '<span class="error">ERROR: ' + msg + '</span>\n';
                    outputElement.scrollTop = outputElement.scrollHeight;
                }
            };
        }
        
        // Load the EventbriteParser
        async function loadParser() {
            if (window.EventbriteParser) {
                return new window.EventbriteParser();
            }
            
            // Try to load the parser
            try {
                const response = await fetch('../scripts/parsers/eventbrite-parser.js');
                const code = await response.text();
                eval(code);
                return new window.EventbriteParser();
            } catch (error) {
                console.error('Failed to load EventbriteParser:', error);
                return null;
            }
        }
        
        async function testEnhancedLogging() {
            const output = document.getElementById('logging-results');
            output.innerHTML = 'Loading parser...\n';
            
            const parser = await loadParser();
            if (!parser) {
                output.innerHTML += '<span class="error">Failed to load EventbriteParser</span>\n';
                return;
            }
            
            // Override console for this test
            const originalConsole = console;
            console = createMockConsole(output);
            
            try {
                output.innerHTML += '<span class="success">✓ EventbriteParser loaded successfully</span>\n';
                
                // Test with mock HTML that has no __SERVER_DATA__
                const mockHtml = `
                    <!DOCTYPE html>
                    <html>
                    <head><title>Test Event</title></head>
                    <body>
                        <div>Some eventbrite content but no JSON data</div>
                    </body>
                    </html>
                `;
                
                const result = parser.parseEvents({
                    html: mockHtml,
                    url: 'https://www.eventbrite.com/e/test-event-123'
                }, {});
                
                output.innerHTML += '<span class="success">✓ Enhanced logging test completed</span>\n';
                output.innerHTML += `Result: ${result.events.length} events found\n`;
                
            } catch (error) {
                output.innerHTML += `<span class="error">Error in test: ${error.message}</span>\n`;
            } finally {
                console = originalConsole;
            }
        }
        
        async function testJsonStructures() {
            const output = document.getElementById('json-results');
            output.innerHTML = 'Testing JSON structures...\n';
            
            const parser = await loadParser();
            if (!parser) {
                output.innerHTML += '<span class="error">Failed to load EventbriteParser</span>\n';
                return;
            }
            
            const originalConsole = console;
            console = createMockConsole(output);
            
            try {
                // Test different JSON structures
                const testCases = [
                    {
                        name: 'Organizer page with future_events',
                        html: `<script>window.__SERVER_DATA__ = {
                            "view_data": {
                                "events": {
                                    "future_events": [{
                                        "name": {"text": "Test Event 1"},
                                        "start": {"utc": "2025-12-01T20:00:00Z"},
                                        "url": "https://www.eventbrite.com/e/test-1"
                                    }]
                                }
                            }
                        };</script>`
                    },
                    {
                        name: 'Individual event page',
                        html: `<script>window.__SERVER_DATA__ = {
                            "event": {
                                "name": {"text": "Test Event 2"},
                                "start": {"utc": "2025-12-02T20:00:00Z"},
                                "url": "https://www.eventbrite.com/e/test-2"
                            }
                        };</script>`
                    },
                    {
                        name: 'Alternative structure',
                        html: `<script>window.__SERVER_DATA__ = {
                            "view_data": {
                                "primary_event": {
                                    "name": {"text": "Test Event 3"},
                                    "start": {"utc": "2025-12-03T20:00:00Z"},
                                    "url": "https://www.eventbrite.com/e/test-3"
                                }
                            }
                        };</script>`
                    }
                ];
                
                for (const testCase of testCases) {
                    output.innerHTML += `\n--- Testing: ${testCase.name} ---\n`;
                    
                    const result = parser.parseEvents({
                        html: testCase.html,
                        url: 'https://www.eventbrite.com/e/test'
                    }, {});
                    
                    output.innerHTML += `Found ${result.events.length} events\n`;
                    if (result.events.length > 0) {
                        result.events.forEach((event, idx) => {
                            output.innerHTML += `  Event ${idx + 1}: ${event.title}\n`;
                        });
                    }
                }
                
                output.innerHTML += '\n<span class="success">✓ JSON structure tests completed</span>\n';
                
            } catch (error) {
                output.innerHTML += `<span class="error">Error in test: ${error.message}</span>\n`;
            } finally {
                console = originalConsole;
            }
        }
        
        async function testEventObjectDetection() {
            const output = document.getElementById('event-results');
            output.innerHTML = 'Testing event object detection...\n';
            
            const parser = await loadParser();
            if (!parser) {
                output.innerHTML += '<span class="error">Failed to load EventbriteParser</span>\n';
                return;
            }
            
            try {
                const testObjects = [
                    {
                        name: 'Valid event with name.text',
                        obj: {
                            name: { text: 'Test Event' },
                            start: { utc: '2025-12-01T20:00:00Z' },
                            url: 'https://example.com'
                        },
                        expected: true
                    },
                    {
                        name: 'Valid event with title',
                        obj: {
                            title: 'Test Event',
                            startDate: '2025-12-01T20:00:00Z'
                        },
                        expected: true
                    },
                    {
                        name: 'Event with URL but no date',
                        obj: {
                            name: 'Test Event',
                            url: 'https://example.com'
                        },
                        expected: true
                    },
                    {
                        name: 'Invalid - no name',
                        obj: {
                            start: '2025-12-01T20:00:00Z',
                            url: 'https://example.com'
                        },
                        expected: false
                    },
                    {
                        name: 'Invalid - array',
                        obj: ['not', 'an', 'event'],
                        expected: false
                    }
                ];
                
                let passed = 0;
                let total = testObjects.length;
                
                testObjects.forEach(test => {
                    const result = parser.isEventObject(test.obj);
                    const success = result === test.expected;
                    
                    if (success) {
                        passed++;
                        output.innerHTML += `<span class="success">✓ ${test.name}: ${result}</span>\n`;
                    } else {
                        output.innerHTML += `<span class="error">✗ ${test.name}: expected ${test.expected}, got ${result}</span>\n`;
                    }
                });
                
                output.innerHTML += `\nResults: ${passed}/${total} tests passed\n`;
                
                if (passed === total) {
                    output.innerHTML += '<span class="success">✓ All event object detection tests passed!</span>\n';
                } else {
                    output.innerHTML += '<span class="error">Some tests failed</span>\n';
                }
                
            } catch (error) {
                output.innerHTML += `<span class="error">Error in test: ${error.message}</span>\n`;
            }
        }
        
        async function testAlternativeSearch() {
            const output = document.getElementById('alternative-results');
            output.innerHTML = 'Testing alternative structure search...\n';
            
            const parser = await loadParser();
            if (!parser) {
                output.innerHTML += '<span class="error">Failed to load EventbriteParser</span>\n';
                return;
            }
            
            const originalConsole = console;
            console = createMockConsole(output);
            
            try {
                // Test alternative JSON structures that might exist on detail pages
                const testStructure = {
                    view_data: {
                        primary_event: {
                            name: { text: 'Alternative Event' },
                            start: { utc: '2025-12-01T20:00:00Z' },
                            url: 'https://www.eventbrite.com/e/alt-event'
                        }
                    },
                    page_data: {
                        events: [{
                            title: 'Page Data Event',
                            startDate: '2025-12-02T20:00:00Z',
                            url: 'https://www.eventbrite.com/e/page-event'
                        }]
                    },
                    deep: {
                        nested: {
                            data: {
                                event: {
                                    name: 'Deep Nested Event',
                                    start_date: '2025-12-03T20:00:00Z',
                                    event_url: 'https://www.eventbrite.com/e/deep-event'
                                }
                            }
                        }
                    }
                };
                
                const events = parser.searchAlternativeEventStructures(testStructure);
                
                output.innerHTML += `\nFound ${events.length} events in alternative structures:\n`;
                events.forEach((event, idx) => {
                    output.innerHTML += `  ${idx + 1}. ${event.title}\n`;
                });
                
                if (events.length > 0) {
                    output.innerHTML += '<span class="success">✓ Alternative structure search working!</span>\n';
                } else {
                    output.innerHTML += '<span class="warning">No events found - may need adjustment</span>\n';
                }
                
            } catch (error) {
                output.innerHTML += `<span class="error">Error in test: ${error.message}</span>\n`;
            } finally {
                console = originalConsole;
            }
        }
    </script>
</body>
</html>