<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="toolbox-icon" content="üó∫Ô∏è">
    <meta name="toolbox-description" content="Icon Stamper - Mark your territory with custom map icons">
    <title>üó∫Ô∏è chunky.dad's Toolbox - Icon Stamper</title>
    <meta name="description" content="Mark your territory with custom map icons - chunky.dad's toolbox">
    <link rel="icon" type="image/png" href="../Rising_Star_Ryan_Head_Compressed.png">
    <link rel="apple-touch-icon" href="../Rising_Star_Ryan_Head_Compressed.png">
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Permanent+Marker&family=Roboto+Condensed:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <style>
        :root {
            --primary-orange: #FFA500;
            --primary-gold: #FFD700;
            --bg-dark: #0a0a0a;
            --bg-medium: #1a1a1a;
            --bg-light: #2a2a2a;
            --text-light: #e0e0e0;
            --text-medium: #ccc;
            --text-dark: #aaa;
            --border-color: #333;
            --success-green: #2ecc71;
            --error-red: #e74c3c;
            --warning-yellow: #f39c12;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-medium);
            border-radius: 16px;
            border: 2px solid var(--border-color);
        }
        
        .title {
            color: var(--primary-orange);
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(255, 165, 0, 0.3);
        }
        
        .subtitle {
            color: var(--text-medium);
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .feature-item {
            background: var(--bg-light);
            padding: 8px;
            border-radius: 8px;
            font-size: 0.85rem;
            text-align: left;
        }

        .feature-item strong {
            color: var(--primary-orange);
        }
        
        .controls-section {
            margin-bottom: 30px;
            margin-top: 10px;
        }
        
        .control-panel {
            background: var(--bg-medium);
            border-radius: 16px;
            padding: 25px;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-group:last-child {
            margin-bottom: 0;
        }
        
        .control-label {
            display: block;
            color: var(--primary-orange);
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }
        
        .control-btn {
            background: var(--bg-light);
            color: var(--text-light);
            border: 2px solid var(--border-color);
            padding: 14px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.95rem;
            font-weight: 500;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 50px;
            position: relative;
            overflow: hidden;
        }
        
        .control-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 165, 0, 0.2);
        }
        
        .control-btn.active {
            background: linear-gradient(135deg, var(--primary-orange), #ff8c00);
            color: #000;
            border-color: var(--primary-orange);
            box-shadow: 0 6px 20px rgba(255, 165, 0, 0.4);
            font-weight: 600;
        }

        .control-btn.active::before {
            content: '‚úì';
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .map-section {
            margin-bottom: 30px;
        }
        
        .map-container {
            background: var(--bg-medium);
            border-radius: 16px;
            padding: 25px;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        #test-map {
            height: 650px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .events-section {
            background: var(--bg-medium);
            border-radius: 16px;
            padding: 25px;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .section-header {
            color: var(--primary-orange);
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .event-card {
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .event-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-orange), var(--primary-gold));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .event-card:hover {
            border-color: var(--primary-orange);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(255, 165, 0, 0.2);
        }

        .event-card:hover::before {
            transform: scaleX(1);
        }
        
        .event-name {
            color: var(--primary-orange);
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .live-indicator {
            background: var(--error-red);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .event-details {
            color: var(--text-dark);
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.8;
        }

        .event-details strong {
            color: var(--text-medium);
        }
        
        .field-display {
            margin-bottom: 8px;
            padding: 8px 12px;
            background: var(--bg-light);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .field-label {
            color: var(--primary-orange);
            font-weight: 600;
            margin-right: 8px;
        }

        .field-value {
            color: var(--text-light);
        }
        
        .icon-preview {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .preview-label {
            color: var(--primary-orange);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .preview-content {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Status indicators */
        .status-bar {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .status-value {
            color: var(--primary-orange);
            font-weight: 600;
        }

        /* Marker styles */
        .emoji-marker {
            background: transparent;
            border: none;
            font-size: 24px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .initials-marker {
            background: var(--primary-orange);
            color: #000;
            border: 2px solid #fff;
            font-size: 12px;
            font-weight: 700;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .mixed-marker {
            background: var(--primary-orange);
            color: #000;
            border: 2px solid #fff;
            font-size: 14px;
            font-weight: 600;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .title-marker {
            background: rgba(255, 165, 0, 0.95);
            color: #000;
            border: 2px solid #fff;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 12px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
            white-space: nowrap;
            text-align: center;
            font-size: 11px;
        }

        .favicon-marker {
            background: #fff;
            border: 2px solid var(--primary-orange);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
        }
        
        .favicon-marker img {
            width: 28px;
            height: 28px;
            object-fit: contain;
            border-radius: 4px;
        }

        .gradient-marker {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1, #96CEB4, #FFEAA7, #DDA0DD);
            background-size: 300% 300%;
            animation: gradientShift 3s ease infinite;
            color: #fff;
            border: 2px solid #fff;
            font-size: 16px;
            font-weight: 700;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .neon-marker {
            background: #0a0a0a;
            color: #00ffff;
            border: 2px solid #00ffff;
            font-size: 16px;
            font-weight: 700;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            box-shadow: 
                0 0 5px #00ffff,
                0 0 10px #00ffff,
                0 0 15px #00ffff;
            animation: neonPulse 2s ease-in-out infinite alternate;
            text-shadow: 0 0 5px #00ffff;
        }
        
        @keyframes neonPulse {
            from { box-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff, 0 0 15px #00ffff; }
            to { box-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff, 0 0 25px #00ffff; }
        }

        /* Color themes */
        .color-orange { --marker-color: #FFA500; }
        .color-blue { --marker-color: #4ECDC4; }
        .color-purple { --marker-color: #9B59B6; }
        .color-green { --marker-color: #2ECC71; }
        .color-red { --marker-color: #E74C3C; }
        .color-gold { --marker-color: #FFD700; }
        .color-pink { --marker-color: #FF69B4; }
        .color-cyan { --marker-color: #00FFFF; }

        /* Size variants */
        .size-small { transform: scale(0.8); }
        .size-medium { transform: scale(1.0); }
        .size-large { transform: scale(1.3); }
        .size-xl { transform: scale(1.6); }

        /* Responsive design */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .title { font-size: 1.8rem; }
            .subtitle { font-size: 1rem; }
            .header { padding: 15px; margin-bottom: 15px; }
            .feature-grid { grid-template-columns: 1fr; gap: 8px; }
            .feature-item { padding: 6px; font-size: 0.8rem; }
            .button-grid { grid-template-columns: 1fr; }
            .events-grid { grid-template-columns: 1fr; }
            #test-map { height: 400px; }
        }

        @media (max-width: 480px) {
            .title { font-size: 1.5rem; }
            .subtitle { font-size: 0.9rem; }
            .header { padding: 12px; margin-bottom: 12px; }
            .feature-grid { gap: 6px; }
            .feature-item { padding: 4px; font-size: 0.75rem; }
            .control-panel { padding: 15px; }
            .map-container { padding: 15px; }
            .events-section { padding: 15px; }
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--primary-orange);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ff8c00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üó∫Ô∏è Map Icon Laboratory</h1>
            <p class="subtitle">Advanced icon testing & customization for chunky.dad maps</p>
            
            <div class="feature-grid">
                <div class="feature-item">
                    <strong>üé® Style Options:</strong> Emojis, initials, titles, favicons, gradients, neon effects
                </div>
                <div class="feature-item">
                    <strong>üåà Color Themes:</strong> 8 different color schemes for markers
                </div>
                <div class="feature-item">
                    <strong>üìè Size Control:</strong> Small, medium, large, and XL marker sizes
                </div>
                <div class="feature-item">
                    <strong>üìÖ Real Data:</strong> Import actual calendar events from chunky.dad
                </div>
                <div class="feature-item">
                    <strong>üîß Smart Fields:</strong> Proper use of title, shortName, and shorterName
                </div>
                <div class="feature-item">
                    <strong>üåê Favicon Support:</strong> Automatic website favicon detection and fallbacks
                </div>
            </div>
        </div>

        <div class="controls-section">
            <div class="control-panel">
                <div class="status-bar">
                    <div class="status-item">
                        <span>üìç Events:</span>
                        <span class="status-value" id="event-count">0</span>
                    </div>
                    <div class="status-item">
                        <span>üé® Style:</span>
                        <span class="status-value" id="current-style">emoji</span>
                    </div>
                    <div class="status-item">
                        <span>üåà Color:</span>
                        <span class="status-value" id="current-color">orange</span>
                    </div>
                    <div class="status-item">
                        <span>üìè Size:</span>
                        <span class="status-value" id="current-size">medium</span>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">üé® Icon Style</label>
                    <div class="button-grid" id="style-controls">
                        <button class="control-btn active" data-style="emoji">üç∫ Emojis</button>
                        <button class="control-btn" data-style="initials">üî§ Initials</button>
                        <button class="control-btn" data-style="mixed">üé≠ Mixed</button>
                        <button class="control-btn" data-style="title">üìù Event Title</button>
                        <button class="control-btn" data-style="shortName">üìÑ Short Name</button>
                        <button class="control-btn" data-style="shorterName">üè∑Ô∏è Shorter Name</button>
                        <button class="control-btn" data-style="favicon">üåê Favicons</button>
                        <button class="control-btn" data-style="favicon-title">üåêüìù Favicon + Title</button>
                        <button class="control-btn" data-style="gradient">üåà Gradient</button>
                        <button class="control-btn" data-style="neon">‚ö° Neon</button>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">üåà Color Theme</label>
                    <div class="button-grid" id="color-controls">
                        <button class="control-btn active" data-color="orange">üß° Orange</button>
                        <button class="control-btn" data-color="blue">üíô Blue</button>
                        <button class="control-btn" data-color="purple">üíú Purple</button>
                        <button class="control-btn" data-color="green">üíö Green</button>
                        <button class="control-btn" data-color="red">‚ù§Ô∏è Red</button>
                        <button class="control-btn" data-color="gold">üíõ Gold</button>
                        <button class="control-btn" data-color="pink">üíó Pink</button>
                        <button class="control-btn" data-color="cyan">üíé Cyan</button>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">üìè Marker Size</label>
                    <div class="button-grid" id="size-controls">
                        <button class="control-btn" data-size="small">üìè Small</button>
                        <button class="control-btn active" data-size="medium">üìê Medium</button>
                        <button class="control-btn" data-size="large">üìè Large</button>
                        <button class="control-btn" data-size="xl">üìè XL</button>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">üîß Map Actions</label>
                    <div class="button-grid" id="action-controls">
                        <button class="control-btn" data-action="refresh">üîÑ Refresh</button>
                        <button class="control-btn" data-action="fit-bounds">üéØ Fit All</button>
                        <button class="control-btn" data-action="add-random">‚ûï Add Random</button>
                        <button class="control-btn" data-action="load-calendar">üìÖ Load Calendar</button>
                        <button class="control-btn" data-action="test-favicons">üåê Test Favicons</button>
                        <button class="control-btn" data-action="reset">üóëÔ∏è Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <section class="map-section">
            <div class="map-container">
                <div id="test-map"></div>
            </div>
        </section>

        <section class="events-section">
            <h2 class="section-header">üìÖ Event Details</h2>
            <div id="events-grid" class="events-grid"></div>
        </section>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- Logger -->
    <script src="../js/logger.js"></script>
    <!-- Calendar integration -->
    <script src="../js/city-config.js"></script>
    <script src="../js/calendar-core.js"></script>
    <script src="../js/dynamic-calendar-loader.js"></script>
    
    <script>
        class MapIconLaboratory {
            constructor() {
                this.map = null;
                this.markers = [];
                this.events = [];
                this.calendarLoader = null;
                
                // Current settings
                this.settings = {
                    style: 'emoji',
                    color: 'orange',
                    size: 'medium'
                };

                // Color theme mapping
                this.colorThemes = {
                    orange: '#FFA500',
                    blue: '#4ECDC4',
                    purple: '#9B59B6',
                    green: '#2ECC71',
                    red: '#E74C3C',
                    gold: '#FFD700',
                    pink: '#FF69B4',
                    cyan: '#00FFFF'
                };

                this.init();
            }

            async init() {
                logger.componentInit('MAP', 'Map Icon Laboratory initializing');
                
                try {
                    this.setupCalendarLoader();
                    this.loadDefaultEvents();
                    this.initializeMap();
                    this.setupEventListeners();
                    this.updateDisplay();
                    
                    logger.componentLoad('MAP', 'Map Icon Laboratory initialized successfully');
                } catch (error) {
                    logger.componentError('MAP', 'Failed to initialize Map Icon Laboratory', error);
                }
            }

            setupCalendarLoader() {
                if (typeof DynamicCalendarLoader !== 'undefined') {
                    this.calendarLoader = new DynamicCalendarLoader();
                    this.calendarLoader.currentCity = 'nyc';
                    this.calendarLoader.currentCityConfig = getCityConfig('nyc');
                    this.calendarLoader.getCityFromURL = () => 'nyc';
                    logger.componentLoad('MAP', 'Calendar loader configured');
                } else {
                    logger.warn('MAP', 'DynamicCalendarLoader not available');
                }
            }

            loadDefaultEvents() {
                this.events = [
                    {
                        name: "Bear Happy Hour",
                        shortName: "Bear Happy Hour",
                        shorterName: "BHH",
                        nickname: "BHH",
                        bar: "The Bear Den",
                        time: "5:00 PM - 8:00 PM",
                        day: "Thursday",
                        cover: "Free",
                        coordinates: { lat: 40.7128, lng: -74.0060 },
                        emoji: "üç∫",
                        eventType: "Happy Hour",
                        website: "https://instagram.com/bearhappyhourny"
                    },
                    {
                        name: "Leather Night at The Eagle",
                        shortName: "Leather Night",
                        shorterName: "Leather",
                        nickname: "Leather",
                        bar: "The Eagle NYC",
                        time: "9:00 PM - 2:00 AM",
                        day: "Friday",
                        cover: "$10",
                        coordinates: { lat: 40.7589, lng: -73.9851 },
                        emoji: "üñ§",
                        eventType: "Themed Night",
                        website: "https://eagle-ny.com"
                    },
                    {
                        name: "Sunday Funday Brunch Special",
                        shortName: "Sunday Brunch",
                        shorterName: "Brunch",
                        nickname: "SFB",
                        bar: "Rainbow Cafe",
                        time: "11:00 AM - 4:00 PM",
                        day: "Sunday",
                        cover: "Free",
                        coordinates: { lat: 40.7505, lng: -73.9934 },
                        emoji: "ü•û",
                        eventType: "Brunch",
                        website: "https://animal.nyc"
                    },
                    {
                        name: "Karaoke Night Extravaganza",
                        shortName: "Karaoke Night",
                        shorterName: "Karaoke",
                        nickname: "Karaoke",
                        bar: "Sing Along Bar",
                        time: "8:00 PM - 12:00 AM",
                        day: "Wednesday",
                        cover: "$5",
                        coordinates: { lat: 40.7282, lng: -73.9942 },
                        emoji: "üé§",
                        eventType: "Entertainment",
                        website: "https://www.yelp.com"
                    },
                    {
                        name: "Monthly Pool Tournament Championship",
                        shortName: "Pool Tournament",
                        shorterName: "Pool",
                        nickname: "Pool",
                        bar: "Corner Pocket",
                        time: "7:00 PM - 11:00 PM",
                        day: "Tuesday",
                        cover: "$15",
                        coordinates: { lat: 40.7614, lng: -73.9776 },
                        emoji: "üé±",
                        eventType: "Tournament"
                    },
                    {
                        name: "Drag Bingo Spectacular Show",
                        shortName: "Drag Bingo",
                        shorterName: "D-Bingo",
                        nickname: "D-Bingo",
                        bar: "Glitter Palace",
                        time: "7:30 PM - 10:30 PM",
                        day: "Monday",
                        cover: "$20",
                        coordinates: { lat: 40.7831, lng: -73.9712 },
                        emoji: "üíÑ",
                        eventType: "Drag Show"
                    }
                ];
                
                logger.info('MAP', `Loaded ${this.events.length} default events`);
            }

            initializeMap() {
                this.map = L.map('test-map').setView([40.7505, -73.9934], 12);
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(this.map);
                
                this.updateMapMarkers();
                logger.componentLoad('MAP', 'Map initialized with dark theme');
            }

            setupEventListeners() {
                // Style controls
                document.getElementById('style-controls').addEventListener('click', (e) => {
                    if (e.target.dataset.style) {
                        this.setActiveButton('style-controls', e.target);
                        this.settings.style = e.target.dataset.style;
                        this.updateDisplay();
                        logger.userInteraction('MAP', `Style changed to: ${this.settings.style}`);
                    }
                });

                // Color controls
                document.getElementById('color-controls').addEventListener('click', (e) => {
                    if (e.target.dataset.color) {
                        this.setActiveButton('color-controls', e.target);
                        this.settings.color = e.target.dataset.color;
                        this.updateDisplay();
                        logger.userInteraction('MAP', `Color changed to: ${this.settings.color}`);
                    }
                });

                // Size controls
                document.getElementById('size-controls').addEventListener('click', (e) => {
                    if (e.target.dataset.size) {
                        this.setActiveButton('size-controls', e.target);
                        this.settings.size = e.target.dataset.size;
                        this.updateDisplay();
                        logger.userInteraction('MAP', `Size changed to: ${this.settings.size}`);
                    }
                });

                // Action controls
                document.getElementById('action-controls').addEventListener('click', (e) => {
                    if (e.target.dataset.action) {
                        this.handleAction(e.target.dataset.action);
                    }
                });
            }

            setActiveButton(containerId, activeButton) {
                const container = document.getElementById(containerId);
                container.querySelectorAll('.control-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                activeButton.classList.add('active');
            }

            handleAction(action) {
                logger.userInteraction('MAP', `Action triggered: ${action}`);
                
                switch (action) {
                    case 'refresh':
                        this.updateMapMarkers();
                        break;
                    case 'fit-bounds':
                        this.fitAllMarkers();
                        break;
                    case 'add-random':
                        this.addRandomEvent();
                        break;
                    case 'load-calendar':
                        this.loadRealCalendar();
                        break;
                    case 'test-favicons':
                        this.testFavicons();
                        break;
                    case 'reset':
                        this.resetToDefault();
                        break;
                }
            }

            updateDisplay() {
                this.updateStatusBar();
                this.updateMapMarkers();
                this.updateEventCards();
            }

            updateStatusBar() {
                document.getElementById('event-count').textContent = this.events.length;
                document.getElementById('current-style').textContent = this.settings.style;
                document.getElementById('current-color').textContent = this.settings.color;
                document.getElementById('current-size').textContent = this.settings.size;
            }

            updateMapMarkers() {
                // Clear existing markers
                this.markers.forEach(marker => this.map.removeLayer(marker));
                this.markers = [];
                
                let successCount = 0;
                
                this.events.forEach((event, index) => {
                    if (event.coordinates?.lat && event.coordinates?.lng) {
                        const marker = this.createMarker(event, index);
                        if (marker) {
                            marker.addTo(this.map);
                            this.markers.push(marker);
                            successCount++;
                        }
                    }
                });
                
                logger.info('MAP', `Updated ${successCount} markers on map`, {
                    style: this.settings.style,
                    color: this.settings.color,
                    size: this.settings.size
                });
            }

            createMarker(event, index) {
                const { lat, lng } = event.coordinates;
                const icon = this.createIcon(event, index);
                
                if (!icon) return null;
                
                const marker = L.marker([lat, lng], { icon });
                
                marker.bindPopup(this.createPopupContent(event));
                
                return marker;
            }

            createIcon(event, index) {
                const baseColor = this.colorThemes[this.settings.color];
                const sizeClass = `size-${this.settings.size}`;
                
                let iconHtml = '';
                let className = '';
                let iconSize = [32, 32];
                let iconAnchor = [16, 16];
                
                switch (this.settings.style) {
                    case 'emoji':
                        className = `emoji-marker ${sizeClass}`;
                        iconHtml = event.emoji || 'üìç';
                        iconSize = [30, 30];
                        iconAnchor = [15, 15];
                        break;
                        
                    case 'initials':
                        className = `initials-marker ${sizeClass}`;
                        iconHtml = this.getInitials(event.nickname || event.name);
                        iconSize = [32, 32];
                        iconAnchor = [16, 16];
                        break;
                        
                    case 'mixed':
                        className = `mixed-marker ${sizeClass}`;
                        iconHtml = this.shouldUseEmoji(event) ? 
                            event.emoji : this.getInitials(event.nickname || event.name);
                        iconSize = [36, 36];
                        iconAnchor = [18, 18];
                        break;
                        
                    case 'title':
                        className = `title-marker ${sizeClass}`;
                        iconHtml = this.truncateText(event.name, 20);
                        iconSize = [Math.max(60, iconHtml.length * 8), 24];
                        iconAnchor = [Math.max(30, iconHtml.length * 4), 12];
                        break;
                        
                    case 'shortName':
                        className = `title-marker ${sizeClass}`;
                        iconHtml = event.shortName || this.truncateText(event.name, 15);
                        iconSize = [Math.max(50, iconHtml.length * 7), 22];
                        iconAnchor = [Math.max(25, iconHtml.length * 3.5), 11];
                        break;
                        
                    case 'shorterName':
                        className = `title-marker ${sizeClass}`;
                        iconHtml = event.shorterName || this.truncateText(event.name, 8);
                        iconSize = [Math.max(32, iconHtml.length * 6), 20];
                        iconAnchor = [Math.max(16, iconHtml.length * 3), 10];
                        break;
                        
                    case 'favicon':
                        className = `favicon-marker ${sizeClass}`;
                        if (event.website) {
                            const faviconUrl = this.getFaviconUrl(event.website);
                            iconHtml = `<img src="${faviconUrl}" onerror="this.outerHTML='${event.emoji || 'üåê'}'" alt="favicon">`;
                        } else {
                            iconHtml = event.emoji || 'üåê';
                        }
                        iconSize = [40, 40];
                        iconAnchor = [20, 20];
                        break;
                        
                    case 'favicon-title':
                        className = `favicon-marker ${sizeClass}`;
                        const title = event.shortName || this.truncateText(event.name, 12);
                        if (event.website) {
                            const faviconUrl = this.getFaviconUrl(event.website);
                            iconHtml = `<div style="display:flex;align-items:center;gap:4px;padding:4px 8px;background:white;border-radius:8px;">
                                <img src="${faviconUrl}" onerror="this.style.display='none'" width="16" height="16" alt="favicon">
                                <span style="color:black;font-size:10px;font-weight:600;">${title}</span>
                            </div>`;
                        } else {
                            iconHtml = `<div style="padding:4px 8px;background:white;border-radius:8px;color:black;font-size:10px;font-weight:600;">${event.emoji || 'üåê'} ${title}</div>`;
                        }
                        iconSize = [Math.max(80, title.length * 8 + 30), 32];
                        iconAnchor = [Math.max(40, title.length * 4 + 15), 16];
                        break;
                        
                    case 'gradient':
                        className = `gradient-marker ${sizeClass}`;
                        iconHtml = event.emoji || 'üéâ';
                        iconSize = [40, 40];
                        iconAnchor = [20, 20];
                        break;
                        
                    case 'neon':
                        className = `neon-marker ${sizeClass}`;
                        iconHtml = event.emoji || '‚ö°';
                        iconSize = [38, 38];
                        iconAnchor = [19, 19];
                        break;
                        
                    default:
                        className = `initials-marker ${sizeClass}`;
                        iconHtml = this.getInitials(event.name);
                        break;
                }
                
                // Apply color theme for non-special styles
                const coloredStyles = ['initials', 'mixed', 'title', 'shortName', 'shorterName'];
                if (coloredStyles.includes(this.settings.style)) {
                    const style = `background-color: ${baseColor} !important;`;
                    iconHtml = `<div style="${style}">${iconHtml}</div>`;
                }
                
                return L.divIcon({
                    className: className,
                    html: iconHtml,
                    iconSize: iconSize,
                    iconAnchor: iconAnchor,
                    popupAnchor: [0, -iconAnchor[1]]
                });
            }

            createPopupContent(event) {
                return `
                    <div style="min-width: 200px;">
                        <h4 style="color: var(--primary-orange); margin: 0 0 10px 0;">${event.name}</h4>
                        <p><strong>üìç ${event.bar}</strong></p>
                        <p>üìÖ ${event.day} ${event.time}</p>
                        <p>üí∞ ${event.cover}</p>
                        <p>üé≠ ${event.eventType}</p>
                        ${event.shortName ? `<p>üìÑ Short: ${event.shortName}</p>` : ''}
                        ${event.shorterName ? `<p>üè∑Ô∏è Shorter: ${event.shorterName}</p>` : ''}
                        ${event.nickname ? `<p>üè∑Ô∏è Nickname: ${event.nickname}</p>` : ''}
                        ${event.website ? `<p>üåê <a href="${event.website}" target="_blank">Website</a></p>` : ''}
                        ${event.isRealEvent ? `<p style="color: var(--error-red);">üî¥ LIVE EVENT</p>` : ''}
                    </div>
                `;
            }

            updateEventCards() {
                const container = document.getElementById('events-grid');
                container.innerHTML = '';
                
                this.events.forEach((event, index) => {
                    const card = this.createEventCard(event, index);
                    container.appendChild(card);
                });
            }

            createEventCard(event, index) {
                const card = document.createElement('div');
                card.className = 'event-card';
                
                card.innerHTML = `
                    <div class="event-name">
                        ${event.name}
                        ${event.isRealEvent ? '<span class="live-indicator">LIVE</span>' : ''}
                    </div>
                    
                    <div class="field-display">
                        <span class="field-label">Title:</span>
                        <span class="field-value">${event.name}</span>
                    </div>
                    
                    ${event.shortName ? `
                        <div class="field-display">
                            <span class="field-label">Short Name:</span>
                            <span class="field-value">${event.shortName}</span>
                        </div>
                    ` : ''}
                    
                    ${event.shorterName ? `
                        <div class="field-display">
                            <span class="field-label">Shorter Name:</span>
                            <span class="field-value">${event.shorterName}</span>
                        </div>
                    ` : ''}
                    
                    ${event.nickname ? `
                        <div class="field-display">
                            <span class="field-label">Nickname:</span>
                            <span class="field-value">${event.nickname}</span>
                        </div>
                    ` : ''}
                    
                    <div class="event-details">
                        <strong>üìç ${event.bar}</strong><br>
                        üìÖ ${event.day} ${event.time}<br>
                        üí∞ ${event.cover}<br>
                        üé≠ ${event.eventType}
                    </div>
                    
                    <div class="icon-preview">
                        <span class="preview-label">Current Icon (${this.settings.size}):</span>
                        <span class="preview-content">${this.getIconPreview(event, index)}</span>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    if (this.markers[index]) {
                        this.map.setView([event.coordinates.lat, event.coordinates.lng], 15);
                        this.markers[index].openPopup();
                        logger.userInteraction('MAP', `Event card clicked: ${event.name}`);
                    }
                });
                
                return card;
            }

            // Utility methods
            getInitials(text) {
                if (!text) return '?';
                
                if (text.includes('-')) {
                    return text.split('-').map(part => part.charAt(0).toUpperCase()).join('');
                }
                
                const words = text.split(' ').filter(word => word.length > 0);
                if (words.length >= 2) {
                    return words.slice(0, 2).map(word => word.charAt(0).toUpperCase()).join('');
                }
                
                return text.substring(0, 2).toUpperCase();
            }

            shouldUseEmoji(event) {
                const commonEventTypes = ['Happy Hour', 'Brunch', 'Entertainment', 'Drag Show'];
                return commonEventTypes.includes(event.eventType) || 
                       event.name.toLowerCase().includes('happy hour');
            }

            truncateText(text, maxLength) {
                if (!text || text.length <= maxLength) return text;
                
                const words = text.split(' ');
                let result = '';
                
                for (const word of words) {
                    if ((result + ' ' + word).length <= maxLength - 3) {
                        result += (result ? ' ' : '') + word;
                    } else {
                        break;
                    }
                }
                
                return result ? result + '...' : text.substring(0, maxLength - 3) + '...';
            }

            getFaviconUrl(websiteUrl) {
                if (!websiteUrl) return null;
                
                try {
                    const url = new URL(websiteUrl);
                    return `https://www.google.com/s2/favicons?domain=${url.hostname}&sz=64`;
                } catch (error) {
                    logger.componentError('MAP', 'Invalid website URL for favicon', { url: websiteUrl, error });
                    return null;
                }
            }

            getIconPreview(event, index) {
                switch (this.settings.style) {
                    case 'emoji':
                        return event.emoji || 'üìç';
                    case 'initials':
                        return this.getInitials(event.nickname || event.name);
                    case 'mixed':
                        return this.shouldUseEmoji(event) ? event.emoji : this.getInitials(event.nickname || event.name);
                    case 'title':
                        return `"${this.truncateText(event.name, 20)}"`;
                    case 'shortName':
                        return `"${event.shortName || this.truncateText(event.name, 15)}"`;
                    case 'shorterName':
                        return `"${event.shorterName || this.truncateText(event.name, 8)}"`;
                    case 'favicon':
                        return event.website ? 'üåê (Favicon)' : '‚ùå (No Website)';
                    case 'favicon-title':
                        const title = event.shortName || this.truncateText(event.name, 12);
                        return `üåê ${event.website ? 'Favicon' : '‚ùå'} + "${title}"`;
                    case 'gradient':
                        return `üåà ${event.emoji || 'üéâ'}`;
                    case 'neon':
                        return `‚ö° ${event.emoji || '‚ö°'}`;
                    default:
                        return event.emoji || 'üìç';
                }
            }

            // Action methods
            fitAllMarkers() {
                if (this.markers.length > 0) {
                    const group = new L.featureGroup(this.markers);
                    this.map.fitBounds(group.getBounds(), { padding: [20, 20] });
                    logger.userInteraction('MAP', 'Fitted all markers to view');
                }
            }

            addRandomEvent() {
                const randomEvents = [
                    {
                        name: "Trivia Night Championship",
                        shortName: "Trivia Night",
                        shorterName: "Trivia",
                        nickname: "Trivia",
                        bar: "Quiz Palace",
                        time: "7:00 PM - 10:00 PM",
                        day: "Wednesday",
                        cover: "$5",
                        coordinates: { 
                            lat: 40.7400 + Math.random() * 0.05, 
                            lng: -73.9900 + Math.random() * 0.05 
                        },
                        emoji: "üß†",
                        eventType: "Quiz"
                    },
                    {
                        name: "Saturday Night Dance Party",
                        shortName: "Dance Party",
                        shorterName: "Dance",
                        nickname: "Dance",
                        bar: "Groove Central",
                        time: "10:00 PM - 3:00 AM",
                        day: "Saturday",
                        cover: "$15",
                        coordinates: { 
                            lat: 40.7500 + Math.random() * 0.05, 
                            lng: -73.9800 + Math.random() * 0.05 
                        },
                        emoji: "üíÉ",
                        eventType: "Dancing"
                    }
                ];
                
                const randomEvent = randomEvents[Math.floor(Math.random() * randomEvents.length)];
                this.events.push(randomEvent);
                this.updateDisplay();
                
                logger.userInteraction('MAP', `Added random event: ${randomEvent.name}`);
            }

            async loadRealCalendar() {
                if (!this.calendarLoader) {
                    logger.componentError('CALENDAR', 'Calendar loader not available');
                    return;
                }

                try {
                    logger.componentInit('CALENDAR', 'Loading real calendar data');
                    
                    const events = await this.calendarLoader.loadCalendarData('nyc');
                    
                    if (!events || !Array.isArray(events)) {
                        throw new Error('No valid events received from calendar');
                    }
                    
                    logger.info('CALENDAR', `Loaded ${events.length} real calendar events`);
                    
                    // Clear existing events
                    this.events = [];
                    
                    // Convert calendar events to our format
                    events.forEach((event, index) => {
                        const convertedEvent = this.convertCalendarEvent(event);
                        if (convertedEvent) {
                            this.events.push(convertedEvent);
                        }
                    });
                    
                    this.updateDisplay();
                    
                    logger.componentLoad('CALENDAR', `Successfully loaded ${this.events.length} real events`);
                    
                } catch (error) {
                    logger.componentError('CALENDAR', 'Failed to load real calendar data', error);
                    
                    // Add some realistic fallback events
                    this.events.push({
                        name: "Bears Are Animals NYC",
                        shortName: "Bears Are Animals",
                        shorterName: "BAA",
                        nickname: "BAA",
                        bar: "Animal NYC",
                        time: "7:00 PM - 10:00 PM",
                        day: "Thursday",
                        cover: "Free",
                        coordinates: { lat: 40.71739735291992, lng: -73.94930680925715 },
                        emoji: "üêª",
                        eventType: "Weekly Social",
                        website: "https://animal.nyc",
                        isRealEvent: true
                    });
                    
                    this.updateDisplay();
                    logger.componentLoad('CALENDAR', 'Loaded fallback real-style events');
                }
            }

            convertCalendarEvent(event) {
                const emoji = this.generateEmojiForEvent(event);
                const nickname = event.shortName || event.shorterName || this.generateNickname(event.name);
                const website = this.extractWebsiteFromDescription(event.description) || event.url || event.website || null;
                const coordinates = this.parseCoordinatesFromLocation(event.location) || 
                                  this.generateRandomNYCCoordinates();
                const venue = event.bar || event.barName || this.extractVenueFromLocation(event.location) || 'Unknown Location';
                
                return {
                    name: event.name || 'Unnamed Event',
                    shortName: event.shortName || null,
                    shorterName: event.shorterName || null,
                    nickname: nickname,
                    bar: venue,
                    time: event.time || 'Time TBD',
                    day: event.day || 'Day TBD',
                    cover: event.cover || this.extractCoverFromDescription(event.description) || 'TBD',
                    coordinates: coordinates,
                    emoji: emoji,
                    eventType: this.determineEventType(event),
                    website: website,
                    isRealEvent: true,
                    description: event.description,
                    originalEvent: event
                };
            }

            testFavicons() {
                logger.componentInit('MAP', 'Testing favicon URLs');
                
                let successCount = 0;
                let failureCount = 0;
                
                this.events.forEach((event, index) => {
                    if (event.website) {
                        const faviconUrl = this.getFaviconUrl(event.website);
                        logger.info('MAP', `Event ${index + 1}: ${event.name}`, {
                            website: event.website,
                            faviconUrl: faviconUrl
                        });
                        
                        if (faviconUrl) {
                            const testImg = new Image();
                            testImg.onload = () => {
                                successCount++;
                                logger.componentLoad('MAP', `‚úÖ Favicon loaded: ${event.name}`);
                            };
                            testImg.onerror = () => {
                                failureCount++;
                                logger.componentError('MAP', `‚ùå Favicon failed: ${event.name}`);
                            };
                            testImg.src = faviconUrl;
                        }
                    }
                });
                
                // Switch to favicon mode to see results
                const faviconBtn = document.querySelector('[data-style="favicon"]');
                if (faviconBtn) {
                    faviconBtn.click();
                }
                
                setTimeout(() => {
                    logger.info('MAP', 'Favicon test summary', {
                        totalEvents: this.events.length,
                        withWebsite: this.events.filter(e => e.website).length,
                        successfulLoads: successCount,
                        failedLoads: failureCount
                    });
                }, 2000);
            }

            resetToDefault() {
                this.loadDefaultEvents();
                this.updateDisplay();
                logger.userInteraction('MAP', 'Reset to default events');
            }

            // Helper methods for calendar event conversion
            generateEmojiForEvent(event) {
                const name = (event.name || '').toLowerCase();
                const description = (event.description || '').toLowerCase();
                const barName = (event.bar || event.barName || '').toLowerCase();
                
                if (name.includes('happy hour') || name.includes('social hour')) return 'üç∫';
                if (name.includes('brunch')) return 'ü•û';
                if (name.includes('karaoke')) return 'üé§';
                if (name.includes('drag') || name.includes('bingo')) return 'üíÑ';
                if (name.includes('leather')) return 'üñ§';
                if (name.includes('bear') || name.includes('cub')) return 'üêª';
                if (name.includes('pool') || name.includes('billiards')) return 'üé±';
                if (name.includes('dance') || name.includes('party')) return 'üíÉ';
                if (name.includes('trivia') || name.includes('quiz')) return 'üß†';
                if (name.includes('game')) return 'üé≤';
                if (name.includes('festival') || name.includes('weekend')) return 'üé™';
                if (name.includes('underwear') || name.includes('jock')) return 'ü©≤';
                
                if (barName.includes('animal')) return 'ü¶Å';
                if (barName.includes('eagle')) return 'ü¶Ö';
                if (barName.includes('phoenix')) return 'üî•';
                if (barName.includes('stonewall')) return 'üè≥Ô∏è‚Äçüåà';
                
                return 'üêª';
            }

            generateNickname(eventName) {
                if (!eventName) return 'Event';
                
                const words = eventName.split(' ')
                    .filter(word => word.length > 2 && !['the', 'and', 'or', 'at', 'in', 'on'].includes(word.toLowerCase()))
                    .slice(0, 3);
                
                if (words.length >= 2) {
                    return words.map(word => word.charAt(0).toUpperCase()).join('');
                }
                
                return eventName.substring(0, 3).toUpperCase();
            }

            extractWebsiteFromDescription(description) {
                if (!description) return null;
                
                const websiteMatch = description.match(/Website:\s*<a[^>]*href="([^"]*)"[^>]*>/i) ||
                                  description.match(/Website:\s*(https?:\/\/[^\s<\n\r]+)/i) ||
                                  description.match(/Link:\s*(https?:\/\/[^\s<\n\r]+)/i) ||
                                  description.match(/(https?:\/\/[^\s<\n\r]+)/);
                
                return websiteMatch ? websiteMatch[1] : null;
            }

            parseCoordinatesFromLocation(location) {
                if (!location) return null;
                
                const coordMatch = location.match(/(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)/);
                if (coordMatch) {
                    const lat = parseFloat(coordMatch[1]);
                    const lng = parseFloat(coordMatch[2]);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        return { lat, lng };
                    }
                }
                
                return null;
            }

            extractVenueFromLocation(location) {
                if (!location) return null;
                
                const coordMatch = location.match(/^([^0-9-]+)\s*(-?\d+\.?\d*\s*,\s*-?\d+\.?\d*)/);
                if (coordMatch) {
                    return coordMatch[1].trim();
                }
                
                return location;
            }

            extractCoverFromDescription(description) {
                if (!description) return null;
                
                const coverMatch = description.match(/cover:\s*\$?([^<\n\r]+)/i) ||
                                 description.match(/admission:\s*\$?([^<\n\r]+)/i) ||
                                 description.match(/price:\s*\$?([^<\n\r]+)/i);
                
                return coverMatch ? coverMatch[1].trim() : null;
            }

            determineEventType(event) {
                const name = (event.name || '').toLowerCase();
                const description = (event.description || '').toLowerCase();
                
                if (name.includes('happy hour') || description.includes('happy hour')) return 'Happy Hour';
                if (name.includes('brunch') || description.includes('brunch')) return 'Brunch';
                if (name.includes('drag') || description.includes('drag')) return 'Drag Show';
                if (name.includes('karaoke') || description.includes('karaoke')) return 'Entertainment';
                if (name.includes('social') || description.includes('social')) return 'Social Event';
                if (name.includes('party') || description.includes('party')) return 'Party';
                if (name.includes('festival') || description.includes('festival')) return 'Festival';
                if (name.includes('tournament') || description.includes('tournament')) return 'Tournament';
                if (name.includes('underwear') || description.includes('underwear')) return 'Themed Party';
                if (name.includes('leather') || description.includes('leather')) return 'Themed Night';
                
                return 'Social Event';
            }

            generateRandomNYCCoordinates() {
                const baseLat = 40.7505;
                const baseLng = -73.9934;
                const range = 0.1;
                
                return {
                    lat: baseLat + (Math.random() - 0.5) * range,
                    lng: baseLng + (Math.random() - 0.5) * range
                };
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new MapIconLaboratory();
        });
    </script>
</body>
</html>