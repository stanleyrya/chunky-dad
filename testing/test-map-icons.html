<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è chunky.dad's Toolbox - Icon Mapper</title>
    <meta name="description" content="Icon mapping tool for map markers - chunky.dad's toolbox">
    <link rel="icon" type="image/png" href="../Rising_Star_Ryan_Head_Compressed.png">
    <link rel="apple-touch-icon" href="../Rising_Star_Ryan_Head_Compressed.png">
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Roboto+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <style>
        body {
            background: #0a0a0a;
            color: #e0e0e0;
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .test-title {
            color: #FFA500;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .test-subtitle {
            color: #ccc;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        
        .icon-style-controls {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #333;
        }
        
        .control-section {
            margin-bottom: 20px;
        }
        
        .control-label {
            color: #FFA500;
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
        }
        
        .icon-style-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .style-btn {
            background: #333;
            color: #fff;
            border: 2px solid #555;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 120px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .style-btn:hover {
            background: #444;
            border-color: #FFA500;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 165, 0, 0.3);
        }
        
        .style-btn.active {
            background: #FFA500;
            color: #000;
            border-color: #FFA500;
            box-shadow: 0 4px 12px rgba(255, 165, 0, 0.4);
        }
        
        .map-container {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #333;
        }
        
        #test-map {
            height: 600px;
            border-radius: 8px;
            border: 2px solid #333;
        }
        
        .calendar-container {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #333;
        }
        
        .calendar-header {
            color: #FFA500;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .event-card {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .event-card:hover {
            border-color: #FFA500;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 165, 0, 0.2);
        }
        
        .event-name {
            color: #FFA500;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .event-nickname {
            color: #ccc;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .event-shortname {
            color: #FFA500;
            font-size: 0.85rem;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .event-shortername {
            color: #FFD700;
            font-size: 0.8rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .event-details {
            color: #aaa;
            font-size: 0.85rem;
        }
        
        .icon-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 8px;
            background: #2a2a2a;
            border-radius: 6px;
        }
        
        .icon-preview-label {
            color: #FFA500;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* Custom marker styles */
        .emoji-marker {
            background: transparent;
            border: none;
            font-size: 24px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .initials-marker {
            background: #FFA500;
            color: #000;
            border: 2px solid #fff;
            font-size: 12px;
            font-weight: 700;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .mixed-marker {
            background: #FFA500;
            color: #000;
            border: 2px solid #fff;
            font-size: 14px;
            font-weight: 600;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .overlay-marker {
            background: rgba(255, 165, 0, 0.9);
            color: #000;
            border: 2px solid #fff;
            font-size: 16px;
            font-weight: 700;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
        }
        
        .numbered-marker {
            background: linear-gradient(145deg, #FFA500, #FF8C00);
            color: #000;
            border: 2px solid #fff;
            font-size: 12px;
            font-weight: 700;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .numbered-marker::after {
            content: attr(data-emoji);
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 14px;
            background: #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #333;
        }
        
        .favicon-marker {
            background: #fff;
            border: 2px solid #FFA500;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        
        .favicon-marker img {
            width: 24px;
            height: 24px;
            object-fit: contain;
            border-radius: 4px;
            display: block;
        }
        
        .favicon-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .favicon-marker.loading {
            background: linear-gradient(45deg, #333, #555);
            color: #FFA500;
            font-size: 12px;
            font-weight: 600;
        }
        
        .favicon-marker.error {
            background: #444;
            color: #FFA500;
            font-size: 18px;
            font-weight: 600;
        }
        
        .gradient-marker {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4, #45B7D1, #96CEB4, #FFEAA7, #DDA0DD);
            background-size: 300% 300%;
            animation: gradientShift 3s ease infinite;
            color: #fff;
            border: 2px solid #fff;
            font-size: 16px;
            font-weight: 700;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .neon-marker {
            background: #0a0a0a;
            color: #00ffff;
            border: 2px solid #00ffff;
            font-size: 16px;
            font-weight: 700;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            box-shadow: 
                0 0 5px #00ffff,
                0 0 10px #00ffff,
                0 0 15px #00ffff,
                inset 0 0 5px rgba(0,255,255,0.2);
            animation: neonPulse 2s ease-in-out infinite alternate;
            text-shadow: 0 0 5px #00ffff;
        }
        
        @keyframes neonPulse {
            from {
                box-shadow: 
                    0 0 5px #00ffff,
                    0 0 10px #00ffff,
                    0 0 15px #00ffff,
                    inset 0 0 5px rgba(0,255,255,0.2);
            }
            to {
                box-shadow: 
                    0 0 10px #00ffff,
                    0 0 20px #00ffff,
                    0 0 25px #00ffff,
                    inset 0 0 10px rgba(0,255,255,0.4);
            }
        }

        /* Title-based markers */
        .title-full-marker {
            background: rgba(255, 165, 0, 0.95);
            color: #000;
            border: 2px solid #fff;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            min-width: 60px;
            max-width: 200px;
            height: auto;
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }

        .title-short-marker {
            background: rgba(255, 165, 0, 0.95);
            color: #000;
            border: 2px solid #fff;
            font-size: 10px;
            font-weight: 600;
            padding: 3px 6px;
            min-width: 40px;
            max-width: 120px;
            height: auto;
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }

        .title-shorter-marker {
            background: rgba(255, 165, 0, 0.95);
            color: #000;
            border: 2px solid #fff;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 4px;
            min-width: 24px;
            max-width: 60px;
            height: auto;
            min-height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }

        /* Favicon + Title combination markers */
        .favicon-title-side-marker {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #FFA500;
            padding: 4px 6px;
            min-width: 80px;
            max-width: 160px;
            height: auto;
            min-height: 28px;
            display: flex;
            align-items: center;
            gap: 4px;
            border-radius: 14px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .favicon-title-side-marker img {
            width: 16px;
            height: 16px;
            object-fit: contain;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .favicon-title-side-marker .title-text {
            font-size: 10px;
            font-weight: 600;
            color: #000;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .favicon-title-stacked-marker {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #FFA500;
            padding: 4px;
            min-width: 50px;
            max-width: 100px;
            height: auto;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            border-radius: 12px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .favicon-title-stacked-marker img {
            width: 20px;
            height: 20px;
            object-fit: contain;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .favicon-title-stacked-marker .title-text {
            font-size: 8px;
            font-weight: 600;
            color: #000;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
            max-width: 100%;
        }

        /* Additional creative marker styles */
        .badge-marker {
            background: linear-gradient(145deg, #FF6B6B, #FF8E53);
            color: #fff;
            border: 2px solid #fff;
            font-size: 12px;
            font-weight: 700;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            position: relative;
        }

        .badge-marker::before {
            content: '';
            position: absolute;
            top: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            background: #2ecc71;
            border: 2px solid #fff;
            border-radius: 50%;
            animation: badgePulse 2s ease-in-out infinite;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .speech-bubble-marker {
            background: #fff;
            color: #333;
            border: 2px solid #FFA500;
            font-size: 10px;
            font-weight: 600;
            padding: 6px 8px;
            min-width: 40px;
            max-width: 120px;
            height: auto;
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.3);
            position: relative;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .speech-bubble-marker::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #FFA500;
        }

        .speech-bubble-marker::before {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #fff;
            z-index: 1;
        }

        .pulsing-marker {
            background: radial-gradient(circle, #FFA500, #FF8C00);
            color: #000;
            border: 2px solid #fff;
            font-size: 14px;
            font-weight: 700;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: markerPulse 1.5s ease-in-out infinite;
            position: relative;
        }

        .pulsing-marker::before {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            border: 2px solid rgba(255, 165, 0, 0.6);
            border-radius: 50%;
            animation: ripple 1.5s ease-in-out infinite;
        }

        @keyframes markerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }

        /* Size variants */
        .marker-small {
            transform: scale(0.8);
        }

        .marker-medium {
            transform: scale(1);
        }

        .marker-large {
            transform: scale(1.3);
        }
        
        @media (max-width: 768px) {
            .icon-style-buttons {
                flex-direction: column;
            }
            
            .style-btn {
                text-align: center;
            }
            
            .events-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1 class="test-title">üó∫Ô∏è Map Icon Experiment</h1>
            <p class="test-subtitle">Testing different icon styles for event markers</p>
            <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 0.9rem; color: #ccc;">
                <strong style="color: #FFA500;">Test Features:</strong><br>
                ‚Ä¢ üç∫ <strong>Emojis Only:</strong> Beer for happy hour, etc.<br>
                ‚Ä¢ üìù <strong>Initials:</strong> BHH for Bear Happy Hour (from nickname field)<br>
                ‚Ä¢ üé≠ <strong>Mixed:</strong> Emojis for common events, initials for unique ones<br>
                ‚Ä¢ üìç <strong>Overlay Icons:</strong> Icons placed directly over map locations (no pins)<br>
                ‚Ä¢ üî¢ <strong>Numbered + Emoji:</strong> Numbers with emoji badges<br>
                ‚Ä¢ üêª <strong>Original Pin:</strong> Current chunky.dad bear head pin<br>
                ‚Ä¢ üåê <strong>Favicons:</strong> Use website favicons from event data as map icons<br>
                ‚Ä¢ üåà <strong>Gradient Circles:</strong> Colorful gradient circles with emojis<br>
                ‚Ä¢ ‚ö° <strong>Neon Style:</strong> Glowing neon-style markers with animations<br>
                ‚Ä¢ üìÑ <strong>Title Display:</strong> Show full event titles, short versions, or super short<br>
                ‚Ä¢ üè∑Ô∏è <strong>Favicon + Title:</strong> Combine favicons with titles (side-by-side or stacked)<br>
                ‚Ä¢ üé™ <strong>Creative Styles:</strong> Badge markers, speech bubbles, pulsing effects<br>
                ‚Ä¢ üìè <strong>Size Controls:</strong> Small, medium, and large marker sizes<br>
                ‚Ä¢ üìÖ <strong>Real Calendar:</strong> Load actual calendar data using DynamicCalendarLoader (same as calendar tester)<br>
                <strong style="color: #2ecc71;">‚úÖ NEW:</strong> Added title display modes and creative marker styles with size controls!
            </div>
        </div>
        
        <div class="icon-style-controls">
            <div class="control-section">
                <label class="control-label">Icon Style:</label>
                <div class="icon-style-buttons">
                    <button class="style-btn active" data-style="emoji">üç∫ Emojis Only</button>
                    <button class="style-btn" data-style="initials">ABC Initials</button>
                    <button class="style-btn" data-style="mixed">üç∫ Mixed (Emoji + Initials)</button>
                    <button class="style-btn" data-style="overlay">üìç Overlay Icons</button>
                    <button class="style-btn" data-style="numbered">üî¢ Numbered + Emoji</button>
                    <button class="style-btn" data-style="original">üêª Original Pin</button>
                    <button class="style-btn" data-style="favicon">üåê Favicons</button>
                    <button class="style-btn" data-style="gradient">üåà Gradient Circles</button>
                    <button class="style-btn" data-style="neon">‚ö° Neon Style</button>
                </div>
            </div>
            
            <div class="control-section">
                <label class="control-label">Title Display Modes:</label>
                <div class="icon-style-buttons">
                    <button class="style-btn" data-style="title-full">üìÑ Full Title</button>
                    <button class="style-btn" data-style="title-short">üìù Short Title</button>
                    <button class="style-btn" data-style="title-shorter">üè∑Ô∏è Shorter Title</button>
                </div>
            </div>
            
            <div class="control-section">
                <label class="control-label">Favicon + Title Combos:</label>
                <div class="icon-style-buttons">
                    <button class="style-btn" data-style="favicon-title-side">üåêüìù Favicon + Title (Side)</button>
                    <button class="style-btn" data-style="favicon-title-stacked">üåêüìö Favicon + Title (Stacked)</button>
                </div>
            </div>
            
            <div class="control-section">
                <label class="control-label">Creative Styles:</label>
                <div class="icon-style-buttons">
                    <button class="style-btn" data-style="badge">üéñÔ∏è Badge Markers</button>
                    <button class="style-btn" data-style="speech-bubble">üí¨ Speech Bubbles</button>
                    <button class="style-btn" data-style="pulsing">üí´ Pulsing Markers</button>
                </div>
            </div>
            
            <div class="control-section">
                <label class="control-label">Marker Size:</label>
                <div class="icon-style-buttons">
                    <button class="style-btn" data-size="small">üìè Small</button>
                    <button class="style-btn active" data-size="medium">üìê Medium</button>
                    <button class="style-btn" data-size="large">üìè Large</button>
                </div>
            </div>
            
            <div class="control-section">
                <label class="control-label">Map Actions:</label>
                <div class="icon-style-buttons">
                    <button class="style-btn" onclick="refreshMap()">üîÑ Refresh Map</button>
                    <button class="style-btn" onclick="fitAllMarkers()">üéØ Fit All Markers</button>
                    <button class="style-btn" onclick="addRandomEvent()">‚ûï Add Random Event</button>
                    <button class="style-btn" onclick="loadRealCalendar()">üìÖ Load Real Calendar</button>
                    <button class="style-btn" onclick="testFaviconUrls()">üåê Test Favicon URLs</button>
                    <button class="style-btn" onclick="clearMap()">üóëÔ∏è Clear All</button>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="test-map"></div>
        </div>
        
        <div class="calendar-container">
            <h2 class="calendar-header">üìÖ Test Events Calendar</h2>
            <div id="events-grid" class="events-grid"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- Logger -->
    <script src="../js/logger.js"></script>
    <!-- Calendar integration - use same approach as calendar tester -->
    <script src="../js/city-config.js"></script>
    <script src="../js/calendar-core.js"></script>
    <script src="../js/dynamic-calendar-loader.js"></script>
    
    <script>
        // Test data with various event types
        const testEvents = [
            {
                name: "Bear Happy Hour",
                nickname: "BHH",
                bar: "The Bear Den",
                time: "5:00 PM - 8:00 PM",
                day: "Thursday",
                cover: "Free",
                coordinates: { lat: 40.7128, lng: -74.0060 },
                emoji: "üç∫",
                eventType: "Happy Hour",
                website: "https://instagram.com/bearhappyhourny"
            },
            {
                name: "Leather Night",
                nickname: "Leather",
                bar: "Leather & Lace",
                time: "9:00 PM - 2:00 AM",
                day: "Friday",
                cover: "$10",
                coordinates: { lat: 40.7589, lng: -73.9851 },
                emoji: "üñ§",
                eventType: "Themed Night",
                website: "https://eagle-ny.com"
            },
            {
                name: "Sunday Funday Brunch",
                nickname: "SFB",
                bar: "Rainbow Cafe",
                time: "11:00 AM - 4:00 PM",
                day: "Sunday",
                cover: "Free",
                coordinates: { lat: 40.7505, lng: -73.9934 },
                emoji: "ü•û",
                eventType: "Brunch",
                website: "https://animal.nyc"
            },
            {
                name: "Karaoke Night",
                nickname: "Karaoke",
                bar: "Sing Along Bar",
                time: "8:00 PM - 12:00 AM",
                day: "Wednesday",
                cover: "$5",
                coordinates: { lat: 40.7282, lng: -73.9942 },
                emoji: "üé§",
                eventType: "Entertainment",
                website: "https://www.yelp.com"
            },
            {
                name: "Pool Tournament",
                nickname: "Pool",
                bar: "Corner Pocket",
                time: "7:00 PM - 11:00 PM",
                day: "Tuesday",
                cover: "$15",
                coordinates: { lat: 40.7614, lng: -73.9776 },
                emoji: "üé±",
                eventType: "Tournament"
            },
            {
                name: "Drag Bingo",
                nickname: "D-Bingo",
                bar: "Glitter Palace",
                time: "7:30 PM - 10:30 PM",
                day: "Monday",
                cover: "$20",
                coordinates: { lat: 40.7831, lng: -73.9712 },
                emoji: "üíÑ",
                eventType: "Drag Show"
            },
            {
                name: "Bear Weekend Festival",
                nickname: "BWF",
                bar: "Multiple Venues",
                time: "All Day",
                day: "Saturday-Sunday",
                cover: "$50",
                coordinates: { lat: 40.7410, lng: -74.0014 },
                emoji: "üêª",
                eventType: "Festival",
                website: "https://github.com"
            },
            {
                name: "Game Night",
                nickname: "Games",
                bar: "Board & Brew",
                time: "6:00 PM - 10:00 PM",
                day: "Thursday",
                cover: "Free",
                coordinates: { lat: 40.7549, lng: -73.9840 },
                emoji: "üé≤",
                eventType: "Games"
            }
        ];
        
        let map;
        let markers = [];
        let currentStyle = 'emoji';
        let currentSize = 'medium';
        let calendarLoader = null;
        
        // Initialize the test page
        document.addEventListener('DOMContentLoaded', async function() {
            logger.componentInit('MAP', 'Map icon test page initialized');
            
            // Initialize calendar loader for real data
            calendarLoader = new DynamicCalendarLoader();
            
            // Set up the city context manually (since we're not on a real city page)
            calendarLoader.currentCity = 'new-york';
            calendarLoader.currentCityConfig = getCityConfig('new-york');
            
            // Override getCityFromURL to return 'new-york' for testing
            calendarLoader.getCityFromURL = function() {
                return 'new-york';
            };
            
            logger.componentLoad('MAP', 'Calendar loader set up for testing');
            
            initializeMap();
            renderEvents();
            setupEventListeners();
        });
        
        function initializeMap() {
            // Initialize map centered on NYC
            map = L.map('test-map').setView([40.7505, -73.9934], 12);
            
            // Add dark theme tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Add initial markers
            updateMapMarkers();
            
            logger.componentLoad('MAP', 'Test map initialized successfully');
        }
        
        function setupEventListeners() {
            // Style button listeners - only one style can be active at a time
            document.querySelectorAll('.style-btn[data-style]').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active from ALL style buttons first
                    document.querySelectorAll('.style-btn[data-style]').forEach(b => b.classList.remove('active'));
                    // Add active to clicked button
                    this.classList.add('active');
                    
                    // Update current style and refresh markers
                    currentStyle = this.dataset.style;
                    updateMapMarkers();
                    updateEventPreviews();
                    
                    logger.userInteraction('MAP', `Icon style changed to: ${currentStyle}`);
                });
            });
            
            // Size button listeners - only one size can be active at a time
            document.querySelectorAll('.style-btn[data-size]').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active from ALL size buttons first
                    document.querySelectorAll('.style-btn[data-size]').forEach(b => b.classList.remove('active'));
                    // Add active to clicked button
                    this.classList.add('active');
                    
                    // Update current size and refresh markers
                    currentSize = this.dataset.size;
                    updateMapMarkers();
                    updateEventPreviews();
                    
                    logger.userInteraction('MAP', `Marker size changed to: ${currentSize}`);
                });
            });
            
            // Action button listeners
            document.querySelectorAll('.style-btn[onclick]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const onclick = this.getAttribute('onclick');
                    if (onclick) {
                        // Execute the onclick function
                        eval(onclick);
                    }
                });
            });
        }
        
        function updateMapMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            logger.info('MAP', `Updating markers for ${testEvents.length} events with style: ${currentStyle}`);
            
            // Add new markers with current style
            let successCount = 0;
            let failureCount = 0;
            
            testEvents.forEach((event, index) => {
                if (!event.coordinates || !event.coordinates.lat || !event.coordinates.lng) {
                    logger.warn('MAP', `Event ${index + 1} missing coordinates: ${event.name}`, { event });
                    failureCount++;
                    return;
                }
                
                const marker = createMarker(event, index);
                if (marker) {
                    marker.addTo(map);
                    markers.push(marker);
                    successCount++;
                } else {
                    logger.warn('MAP', `Failed to create marker for event: ${event.name}`, { event });
                    failureCount++;
                }
            });
            
            logger.componentLoad('MAP', `Updated ${successCount} markers with style: ${currentStyle}`, {
                totalEvents: testEvents.length,
                successfulMarkers: successCount,
                failedMarkers: failureCount,
                markersOnMap: markers.length
            });
        }
        
        // Title truncation functions - now properly uses shortName and shorterName
        function getTitleForDisplay(event, mode) {
            if (!event) return 'Event';
            
            // Use the event object to access shortName and shorterName
            const eventName = event.name || 'Event';
            const shortName = event.shortName;
            const shorterName = event.shorterName;
            
            switch (mode) {
                case 'title-full':
                    return eventName.length > 25 ? eventName.substring(0, 25) + '...' : eventName;
                case 'title-short':
                    // Use shortName if available, otherwise truncate
                    if (shortName) {
                        return shortName.length > 15 ? shortName.substring(0, 15) + '...' : shortName;
                    }
                    return eventName.length > 15 ? eventName.substring(0, 15) + '...' : eventName;
                case 'title-shorter':
                    // Use shorterName if available, otherwise truncate
                    if (shorterName) {
                        return shorterName.length > 8 ? shorterName.substring(0, 8) + '...' : shorterName;
                    }
                    return eventName.length > 8 ? eventName.substring(0, 8) + '...' : eventName;
                default:
                    return eventName;
            }
        }
        
        function getSmartTitleTruncation(eventName, maxLength) {
            if (!eventName || eventName.length <= maxLength) return eventName;
            
            // Try to break at word boundaries
            const words = eventName.split(' ');
            let result = '';
            
            for (const word of words) {
                if ((result + ' ' + word).length <= maxLength - 3) {
                    result += (result ? ' ' : '') + word;
                } else {
                    break;
                }
            }
            
            return result ? result + '...' : eventName.substring(0, maxLength - 3) + '...';
        }
        
        function applySizeClass(className) {
            return `${className} marker-${currentSize}`;
        }

        function createMarker(event, index) {
            if (!event.coordinates?.lat || !event.coordinates?.lng) {
                return null;
            }
            
            let icon;
            
            switch (currentStyle) {
                case 'emoji':
                    icon = L.divIcon({
                        className: applySizeClass('emoji-marker'),
                        html: event.emoji || 'üìç',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15],
                        popupAnchor: [0, -15]
                    });
                    break;
                    
                case 'initials':
                    const initials = getInitials(event.nickname || event.name);
                    icon = L.divIcon({
                        className: applySizeClass('initials-marker'),
                        html: initials,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16],
                        popupAnchor: [0, -16]
                    });
                    break;
                    
                case 'mixed':
                    const mixedContent = shouldUseEmoji(event) ? event.emoji : getInitials(event.nickname || event.name);
                    icon = L.divIcon({
                        className: applySizeClass('mixed-marker'),
                        html: mixedContent || '?',
                        iconSize: [36, 36],
                        iconAnchor: [18, 18],
                        popupAnchor: [0, -18]
                    });
                    break;
                    
                case 'overlay':
                    const overlayContent = event.emoji || getInitials(event.nickname || event.name);
                    icon = L.divIcon({
                        className: applySizeClass('overlay-marker'),
                        html: overlayContent,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20],
                        popupAnchor: [0, -20]
                    });
                    break;
                    
                case 'numbered':
                    icon = L.divIcon({
                        className: applySizeClass('numbered-marker'),
                        html: `<span>${index + 1}</span>`,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14],
                        popupAnchor: [0, -14]
                    });
                    // Add emoji as pseudo-element via data attribute
                    setTimeout(() => {
                        const markerEl = document.querySelector(`.numbered-marker:nth-last-child(1)`);
                        if (markerEl) {
                            markerEl.setAttribute('data-emoji', event.emoji || 'üìç');
                        }
                    }, 100);
                    break;
                    
                case 'favicon':
                    const faviconUrl = getFaviconUrl(event.website);
                    const markerId = `favicon-marker-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    
                    if (faviconUrl) {
                        icon = L.divIcon({
                            className: applySizeClass('favicon-marker loading'),
                            html: `<div id="${markerId}" class="favicon-content">‚è≥</div>`,
                            iconSize: [36, 36],
                            iconAnchor: [18, 18],
                            popupAnchor: [0, -18]
                        });
                        
                        // Load favicon asynchronously with proper error handling
                        loadFaviconForMarker(markerId, faviconUrl, event.emoji || 'üåê');
                    } else {
                        // No website URL, use fallback immediately
                        icon = L.divIcon({
                            className: applySizeClass('favicon-marker error'),
                            html: `<div class="favicon-content">${event.emoji || 'üåê'}</div>`,
                            iconSize: [36, 36],
                            iconAnchor: [18, 18],
                            popupAnchor: [0, -18]
                        });
                    }
                    break;
                     
                case 'gradient':
                    icon = L.divIcon({
                        className: applySizeClass('gradient-marker'),
                        html: event.emoji || 'üéâ',
                        iconSize: [40, 40],
                        iconAnchor: [20, 20],
                        popupAnchor: [0, -20]
                    });
                    break;
                    
                case 'neon':
                    icon = L.divIcon({
                        className: applySizeClass('neon-marker'),
                        html: event.emoji || '‚ö°',
                        iconSize: [38, 38],
                        iconAnchor: [19, 19],
                        popupAnchor: [0, -19]
                    });
                    break;
                
                // NEW: Title display modes - now properly uses shortName and shorterName
                case 'title-full':
                    const fullTitle = getTitleForDisplay(event, 'title-full');
                    icon = L.divIcon({
                        className: applySizeClass('title-full-marker'),
                        html: fullTitle,
                        iconSize: [Math.min(200, Math.max(60, fullTitle.length * 8)), 24],
                        iconAnchor: [Math.min(100, Math.max(30, fullTitle.length * 4)), 12],
                        popupAnchor: [0, -12]
                    });
                    break;
                    
                case 'title-short':
                    const shortTitle = getTitleForDisplay(event, 'title-short');
                    icon = L.divIcon({
                        className: applySizeClass('title-short-marker'),
                        html: shortTitle,
                        iconSize: [Math.min(120, Math.max(40, shortTitle.length * 7)), 20],
                        iconAnchor: [Math.min(60, Math.max(20, shortTitle.length * 3.5)), 10],
                        popupAnchor: [0, -10]
                    });
                    break;
                    
                case 'title-shorter':
                    const shorterTitle = getTitleForDisplay(event, 'title-shorter');
                    icon = L.divIcon({
                        className: applySizeClass('title-shorter-marker'),
                        html: shorterTitle,
                        iconSize: [Math.min(60, Math.max(24, shorterTitle.length * 6)), 16],
                        iconAnchor: [Math.min(30, Math.max(12, shorterTitle.length * 3)), 8],
                        popupAnchor: [0, -8]
                    });
                    break;
                
                // NEW: Favicon + Title combinations
                case 'favicon-title-side':
                    const faviconUrlSide = getFaviconUrl(event.website);
                    const sideTitle = getSmartTitleTruncation(event.name, 20);
                    const sideMarkerId = `favicon-side-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    
                    const sideHtml = faviconUrlSide ? 
                        `<div id="${sideMarkerId}" class="favicon-content"><img src="${faviconUrlSide}" onerror="this.style.display='none'; this.nextSibling.textContent='${event.emoji || 'üåê'}';" alt="favicon"><span style="display:none;">${event.emoji || 'üåê'}</span></div><div class="title-text">${sideTitle}</div>` :
                        `<div class="favicon-content">${event.emoji || 'üåê'}</div><div class="title-text">${sideTitle}</div>`;
                    
                    icon = L.divIcon({
                        className: applySizeClass('favicon-title-side-marker'),
                        html: sideHtml,
                        iconSize: [Math.min(160, Math.max(80, sideTitle.length * 8 + 20)), 28],
                        iconAnchor: [Math.min(80, Math.max(40, sideTitle.length * 4 + 10)), 14],
                        popupAnchor: [0, -14]
                    });
                    break;
                    
                case 'favicon-title-stacked':
                    const faviconUrlStacked = getFaviconUrl(event.website);
                    const stackedTitle = getSmartTitleTruncation(event.name, 15);
                    const stackedMarkerId = `favicon-stacked-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    
                    const stackedHtml = faviconUrlStacked ? 
                        `<div id="${stackedMarkerId}" class="favicon-content"><img src="${faviconUrlStacked}" onerror="this.style.display='none'; this.nextSibling.textContent='${event.emoji || 'üåê'}';" alt="favicon"><span style="display:none;">${event.emoji || 'üåê'}</span></div><div class="title-text">${stackedTitle}</div>` :
                        `<div class="favicon-content">${event.emoji || 'üåê'}</div><div class="title-text">${stackedTitle}</div>`;
                    
                    icon = L.divIcon({
                        className: applySizeClass('favicon-title-stacked-marker'),
                        html: stackedHtml,
                        iconSize: [Math.min(100, Math.max(50, stackedTitle.length * 6 + 10)), 40],
                        iconAnchor: [Math.min(50, Math.max(25, stackedTitle.length * 3 + 5)), 20],
                        popupAnchor: [0, -20]
                    });
                    break;
                
                // NEW: Creative marker styles
                case 'badge':
                    icon = L.divIcon({
                        className: applySizeClass('badge-marker'),
                        html: event.emoji || 'üéñÔ∏è',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16],
                        popupAnchor: [0, -16]
                    });
                    break;
                    
                case 'speech-bubble':
                    const bubbleText = getSmartTitleTruncation(event.name, 12);
                    icon = L.divIcon({
                        className: applySizeClass('speech-bubble-marker'),
                        html: bubbleText,
                        iconSize: [Math.min(120, Math.max(40, bubbleText.length * 8)), 24],
                        iconAnchor: [Math.min(60, Math.max(20, bubbleText.length * 4)), 20], // Adjust for speech bubble tail
                        popupAnchor: [0, -24]
                    });
                    break;
                    
                case 'pulsing':
                    icon = L.divIcon({
                        className: applySizeClass('pulsing-marker'),
                        html: event.emoji || 'üí´',
                        iconSize: [36, 36],
                        iconAnchor: [18, 18],
                        popupAnchor: [0, -18]
                    });
                    break;
                     
                case 'original':
                default:
                    icon = L.divIcon({
                        className: applySizeClass('custom-marker'),
                        html: `
                            <div class="marker-pin">
                                <div class="marker-icon"><img src="../Rising_Star_Ryan_Head_Compressed.png" alt="chunky.dad" class="map-marker-icon"></div>
                            </div>
                        `,
                        iconSize: [44, 56],
                        iconAnchor: [22, 56],
                        popupAnchor: [0, -56]
                    });
                    break;
            }
            
            const marker = L.marker([event.coordinates.lat, event.coordinates.lng], { icon });
            
            // Add popup with full title tooltip for shortened displays
            const fullTitle = event.name;
            const isShortened = currentStyle.includes('title') && fullTitle.length > 15;
            
            marker.bindPopup(`
                <div class="map-popup">
                    <h4>${fullTitle}</h4>
                    <p><strong>üìç ${event.bar}</strong></p>
                    <p>üìÖ ${event.day} ${event.time}</p>
                    <p>üí∞ ${event.cover}</p>
                    <p>üé≠ ${event.eventType}</p>
                    ${event.nickname ? `<p>üè∑Ô∏è Nickname: ${event.nickname}</p>` : ''}
                    ${event.website ? `<p>üåê <a href="${event.website}" target="_blank">Website</a></p>` : ''}
                    <p>üé® Icon Style: ${currentStyle}</p>
                    <p>üìè Marker Size: ${currentSize}</p>
                    ${isShortened ? `<p>üí° <em>Full title shown above</em></p>` : ''}
                </div>
            `);
            
            // Add hover tooltip for shortened titles
            if (isShortened) {
                marker.bindTooltip(fullTitle, {
                    permanent: false,
                    direction: 'top',
                    opacity: 0.9
                });
            }
            
            return marker;
        }
        
        function getInitials(text) {
            if (!text) return '?';
            
            // Handle hyphenated nicknames (e.g., "D-Bingo" -> "DB")
            if (text.includes('-')) {
                return text.split('-').map(part => part.charAt(0).toUpperCase()).join('');
            }
            
            // Handle space-separated words
            const words = text.split(' ').filter(word => word.length > 0);
            if (words.length >= 2) {
                return words.slice(0, 2).map(word => word.charAt(0).toUpperCase()).join('');
            }
            
            // Single word - take first 2 characters
            return text.substring(0, 2).toUpperCase();
        }
        
        function shouldUseEmoji(event) {
            // Logic to determine when to use emoji vs initials in mixed mode
            // Use emoji for common event types, initials for unique/specific events
            const commonEventTypes = ['Happy Hour', 'Brunch', 'Entertainment', 'Drag Show'];
            return commonEventTypes.includes(event.eventType) || event.name.toLowerCase().includes('happy hour');
        }
        
        function renderEvents() {
            const eventsGrid = document.getElementById('events-grid');
            eventsGrid.innerHTML = '';
            
            testEvents.forEach((event, index) => {
                const eventCard = document.createElement('div');
                eventCard.className = 'event-card';
                
                const iconPreview = getIconPreview(event, index);
                
                                 eventCard.innerHTML = `
                     <div class="event-name">${event.name} ${event.isRealEvent ? 'üî¥ LIVE' : ''}</div>
                     <div class="event-nickname">Nickname: ${event.nickname || 'None'}</div>
                     ${event.shortName ? `<div class="event-shortname">Short: ${event.shortName}</div>` : ''}
                     ${event.shorterName ? `<div class="event-shortername">Shorter: ${event.shorterName}</div>` : ''}
                     <div class="event-details">
                         üìç ${event.bar}<br>
                         üìÖ ${event.day} ${event.time}<br>
                         üí∞ ${event.cover}<br>
                         üé≠ ${event.eventType}
                     </div>
                     <div class="icon-preview">
                         <span class="icon-preview-label">Icon (${currentSize}):</span>
                         <span>${iconPreview}</span>
                     </div>
                 `;
                
                // Add click handler to focus on map marker
                eventCard.addEventListener('click', () => {
                    if (markers[index]) {
                        map.setView([event.coordinates.lat, event.coordinates.lng], 15);
                        markers[index].openPopup();
                        logger.userInteraction('MAP', `Event card clicked: ${event.name}`);
                    }
                });
                
                eventsGrid.appendChild(eventCard);
            });
        }
        
        function getIconPreview(event, index) {
            switch (currentStyle) {
                case 'emoji':
                    return event.emoji || 'üìç';
                case 'initials':
                    return getInitials(event.nickname || event.name);
                case 'mixed':
                    return shouldUseEmoji(event) ? event.emoji : getInitials(event.nickname || event.name);
                case 'overlay':
                    return event.emoji || getInitials(event.nickname || event.name);
                case 'numbered':
                    return `${index + 1} ${event.emoji || 'üìç'}`;
                case 'favicon':
                    return event.website ? 'üåê (Favicon)' : '‚ùå (No Website)';
                case 'gradient':
                    return `üåà ${event.emoji || 'üéâ'}`;
                case 'neon':
                    return `‚ö° ${event.emoji || '‚ö°'}`;
                case 'title-full':
                    return `üìÑ "${getTitleForDisplay(event, 'title-full')}"`;
                case 'title-short':
                    return `üìù "${getTitleForDisplay(event, 'title-short')}"`;
                case 'title-shorter':
                    return `üè∑Ô∏è "${getTitleForDisplay(event, 'title-shorter')}"`;
                case 'favicon-title-side':
                    return `üåêüìù ${event.website ? 'Favicon' : '‚ùå'} + "${getSmartTitleTruncation(event.name, 20)}"`;
                case 'favicon-title-stacked':
                    return `üåêüìö ${event.website ? 'Favicon' : '‚ùå'} / "${getSmartTitleTruncation(event.name, 15)}"`;
                case 'badge':
                    return `üéñÔ∏è ${event.emoji || 'üéñÔ∏è'}`;
                case 'speech-bubble':
                    return `üí¨ "${getSmartTitleTruncation(event.name, 12)}"`;
                case 'pulsing':
                    return `üí´ ${event.emoji || 'üí´'}`;
                case 'original':
                default:
                    return 'üêª (Original Pin)';
            }
        }
        
        // Favicon helper functions
        function getFaviconUrl(websiteUrl) {
            if (!websiteUrl) return null;
            
            try {
                const url = new URL(websiteUrl);
                
                // Use Google's favicon service with fallback options
                // This service is more reliable than trying to fetch favicons directly
                return `https://www.google.com/s2/favicons?domain=${url.hostname}&sz=32`;
                
                // Alternative favicon services could be:
                // return `https://favicons.githubusercontent.com/${url.hostname}`;
                // return `https://icon.horse/icon/${url.hostname}`;
                
            } catch (error) {
                logger.componentError('MAP', 'Invalid website URL for favicon', { url: websiteUrl, error });
                return null;
            }
        }
        
        function loadFaviconForMarker(markerId, faviconUrl, fallbackEmoji) {
            const img = new Image();
            // Remove crossOrigin to avoid CORS issues with Google's favicon service
            // img.crossOrigin = 'anonymous';
            
            // Set a timeout to prevent hanging loads
            const loadTimeout = setTimeout(() => {
                logger.componentError('MAP', 'Favicon load timeout', { url: faviconUrl });
                handleFaviconError(markerId, fallbackEmoji);
            }, 5000);
            
            img.onload = function() {
                clearTimeout(loadTimeout);
                // Find the corresponding marker element and update it
                const iconElement = document.getElementById(markerId);
                if (iconElement) {
                    const parentMarker = iconElement.closest('.favicon-marker');
                    if (parentMarker) {
                        parentMarker.className = 'favicon-marker';
                    }
                    iconElement.innerHTML = `<img src="${faviconUrl}" alt="Favicon" onerror="handleFaviconImageError('${markerId}', '${fallbackEmoji}');">`;
                    logger.componentLoad('MAP', 'Favicon loaded successfully', { url: faviconUrl });
                }
            };
            
            img.onerror = function() {
                clearTimeout(loadTimeout);
                logger.componentError('MAP', 'Favicon failed to load, using fallback', { url: faviconUrl, fallback: fallbackEmoji });
                handleFaviconError(markerId, fallbackEmoji);
            };
            
            img.src = faviconUrl;
        }
        
        function handleFaviconError(markerId, fallbackEmoji) {
            // Fallback to emoji if favicon fails to load
            const iconElement = document.getElementById(markerId);
            if (iconElement) {
                const parentMarker = iconElement.closest('.favicon-marker');
                if (parentMarker) {
                    parentMarker.className = 'favicon-marker error';
                }
                iconElement.innerHTML = fallbackEmoji;
            }
        }
        
        function handleFaviconImageError(markerId, fallbackEmoji) {
            // Handle inline image load errors
            handleFaviconError(markerId, fallbackEmoji);
        }
        
        function updateEventPreviews() {
            renderEvents();
        }
        
        // Utility functions
        function refreshMap() {
            updateMapMarkers();
            logger.userInteraction('MAP', 'Map refreshed');
        }
        
        function fitAllMarkers() {
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds(), { padding: [20, 20] });
                logger.userInteraction('MAP', 'Fitted all markers to view');
            }
        }
        
        function addRandomEvent() {
            const randomEvents = [
                {
                    name: "Trivia Night",
                    nickname: "Trivia",
                    bar: "Quiz Palace",
                    time: "7:00 PM - 10:00 PM",
                    day: "Wednesday",
                    cover: "$5",
                    coordinates: { lat: 40.7400 + Math.random() * 0.05, lng: -73.9900 + Math.random() * 0.05 },
                    emoji: "üß†",
                    eventType: "Quiz"
                },
                {
                    name: "Dance Party",
                    nickname: "Dance",
                    bar: "Groove Central",
                    time: "10:00 PM - 3:00 AM",
                    day: "Saturday",
                    cover: "$15",
                    coordinates: { lat: 40.7500 + Math.random() * 0.05, lng: -73.9800 + Math.random() * 0.05 },
                    emoji: "üíÉ",
                    eventType: "Dancing"
                }
            ];
            
            const randomEvent = randomEvents[Math.floor(Math.random() * randomEvents.length)];
            testEvents.push(randomEvent);
            updateMapMarkers();
            renderEvents();
            
            logger.userInteraction('MAP', `Added random event: ${randomEvent.name}`);
        }
        
        function testFaviconUrls() {
            logger.componentInit('MAP', 'Testing favicon URL extraction and loading');
            
            let successCount = 0;
            let failureCount = 0;
            let noWebsiteCount = 0;
            
            // Test favicon URL generation for current events
            testEvents.forEach((event, index) => {
                if (event.website) {
                    const faviconUrl = getFaviconUrl(event.website);
                    logger.info('MAP', `Event ${index + 1}: ${event.name}`, {
                        website: event.website,
                        faviconUrl: faviconUrl,
                        hasWebsite: !!event.website
                    });
                    
                    // Test if favicon actually loads
                    if (faviconUrl) {
                        const testImg = new Image();
                        testImg.onload = () => {
                            successCount++;
                            logger.componentLoad('MAP', `‚úÖ Favicon loaded: ${event.name}`, { 
                                url: faviconUrl,
                                loadTime: Date.now()
                            });
                        };
                        testImg.onerror = () => {
                            failureCount++;
                            logger.componentError('MAP', `‚ùå Favicon failed: ${event.name}`, { 
                                url: faviconUrl,
                                error: 'Image load error'
                            });
                        };
                        testImg.src = faviconUrl;
                    }
                } else {
                    noWebsiteCount++;
                    logger.warn('MAP', `No website URL for event: ${event.name}`);
                }
            });
            
            // Log summary after a brief delay to allow image loading
            setTimeout(() => {
                logger.info('MAP', 'Favicon test summary', {
                    totalEvents: testEvents.length,
                    withWebsite: testEvents.length - noWebsiteCount,
                    successfulLoads: successCount,
                    failedLoads: failureCount,
                    noWebsite: noWebsiteCount
                });
            }, 2000);
            
            // Switch to favicon mode to see results
            document.querySelector('[data-style="favicon"]').click();
        }
        
        async function loadRealCalendar() {
            try {
                logger.componentInit('CALENDAR', 'Loading real calendar data for icon testing using DynamicCalendarLoader');
                
                if (!calendarLoader) {
                    logger.componentError('CALENDAR', 'Calendar loader not initialized');
                    return;
                }
                
                // Use NYC as default city for testing (same as calendar tester)
                const cityKey = 'new-york';
                
                // Check if getCityConfig function exists
                if (typeof getCityConfig !== 'function') {
                    logger.componentError('CALENDAR', 'getCityConfig function not available - city-config.js may not be loaded');
                    throw new Error('City configuration not available');
                }
                
                const cityConfig = getCityConfig(cityKey);
                
                if (!cityConfig || !cityConfig.calendarId) {
                    logger.componentError('CALENDAR', `No calendar configuration found for city: ${cityKey}`, { cityConfig });
                    throw new Error(`No calendar configuration for ${cityKey}`);
                }
                
                logger.info('CALENDAR', `Loading real calendar data for ${cityConfig.name}`, { cityConfig });
                
                // Load calendar data using the calendar loader's loadCalendarData method
                const events = await calendarLoader.loadCalendarData(cityKey);
                
                if (!events || !Array.isArray(events)) {
                    logger.componentError('CALENDAR', 'No valid events array received from calendar loader', { events });
                    throw new Error('Calendar data loading failed - no events array');
                }
                
                logger.info('CALENDAR', `Loaded ${events.length} real calendar events`, { events });
                
                // Clear existing test events
                testEvents.length = 0;
                
                // Convert calendar events to our test format
                events.forEach((event, index) => {
                    // Generate emoji based on event name/type
                    const emoji = generateEmojiForEvent(event);
                    
                    // Use shortName and shorterName from calendar data if available
                    const nickname = event.shortName || event.shorterName || extractNickname(event) || generateNickname(event.name);
                    
                    // Extract website URL from event description or use URL field
                    const website = extractWebsiteFromDescription(event.description) || event.url || event.website || null;
                    
                    // Parse coordinates from location field if available
                    const coordinates = parseCoordinatesFromLocation(event.location) || 
                                      parseCoordinatesFromLocation(event.barLocation) ||
                                      generateRandomNYCCoordinates();
                    
                    // Extract venue name from bar field or location
                    const venue = event.bar || event.barName || extractVenueFromLocation(event.location) || 'Unknown Location';
                    
                    testEvents.push({
                        name: event.name || 'Unnamed Event',
                        nickname: nickname,
                        shortName: event.shortName || null,
                        shorterName: event.shorterName || null,
                        bar: venue,
                        time: event.time || 'Time TBD',
                        day: event.day || 'Day TBD',
                        cover: event.cover || extractCoverFromDescription(event.description) || 'TBD',
                        coordinates: coordinates,
                        emoji: emoji,
                        eventType: determineEventType(event),
                        website: website,
                        isRealEvent: true,
                        description: event.description,
                        originalEvent: event // Keep reference to original for debugging
                    });
                });
                
                // Update map and events display
                logger.info('CALENDAR', `Converting ${events.length} calendar events to test format, now have ${testEvents.length} total events`);
                updateMapMarkers();
                renderEvents();
                
                // Log success with details about what was displayed
                logger.componentLoad('CALENDAR', `Successfully loaded and displayed ${events.length} real calendar events`, {
                    totalEventsInArray: testEvents.length,
                    markersOnMap: markers.length,
                    eventsWithCoordinates: testEvents.filter(e => e.coordinates).length,
                    eventsWithWebsites: testEvents.filter(e => e.website).length,
                    eventsWithShortNames: testEvents.filter(e => e.shortName).length,
                    eventsWithShorterNames: testEvents.filter(e => e.shorterName).length
                });
                
            } catch (error) {
                logger.componentError('CALENDAR', 'Failed to load real calendar data', error);
                
                // Fallback to mock "real-looking" events
                testEvents.length = 0;
                testEvents.push(
                    {
                        name: "Bears Are Animals",
                        nickname: "BAA",
                        shortName: "BAA",
                        shorterName: "BAA",
                        bar: "Animal NYC",
                        time: "7:00 PM - 10:00 PM",
                        day: "Thursday",
                        cover: "Free",
                        coordinates: { lat: 40.71739735291992, lng: -73.94930680925715 },
                        emoji: "üêª",
                        eventType: "Weekly Social",
                        website: "https://animal.nyc",
                        isRealEvent: true
                    },
                    {
                        name: "Thursday Night Social",
                        nickname: "TNS",
                        shortName: "TNS",
                        shorterName: "TNS",
                        bar: "The Eagle NYC",
                        time: "8:00 PM - 12:00 AM",
                        day: "Thursday",
                        cover: "$5",
                        coordinates: { lat: 40.7589, lng: -73.9851 },
                        emoji: "ü¶Ö",
                        eventType: "Social Hour",
                        website: "https://eagle-ny.com",
                        isRealEvent: true
                    },
                    {
                        name: "Underwear Party",
                        nickname: "UWP",
                        shortName: "UWP",
                        shorterName: "UWP",
                        bar: "NYC Venue",
                        time: "10:00 PM - 2:00 AM",
                        day: "Saturday",
                        cover: "$15",
                        coordinates: { lat: 40.7505, lng: -73.9934 },
                        emoji: "ü©≤",
                        eventType: "Themed Party",
                        website: "https://example.com",
                        isRealEvent: true
                    }
                );
                
                updateMapMarkers();
                renderEvents();
                
                logger.componentLoad('CALENDAR', 'Loaded fallback real-style events');
            }
        }
         
         // Helper functions for parsing calendar data
         function extractWebsiteFromDescription(description) {
             if (!description) return null;
             
             // Look for website links in description with various formats
             const websiteMatch = description.match(/Website:\s*<a[^>]*href="([^"]*)"[^>]*>/i) ||
                                 description.match(/Website:\s*(https?:\/\/[^\s<\n\r]+)/i) ||
                                 description.match(/Link:\s*(https?:\/\/[^\s<\n\r]+)/i) ||
                                 description.match(/URL:\s*(https?:\/\/[^\s<\n\r]+)/i) ||
                                 description.match(/More info:\s*(https?:\/\/[^\s<\n\r]+)/i) ||
                                 description.match(/(https?:\/\/[^\s<\n\r]+)/);
             
             return websiteMatch ? websiteMatch[1] : null;
         }
         
         function parseCoordinatesFromLocation(location) {
             if (!location) return null;
             
             // Look for coordinates in format "lat, lng" 
             const coordMatch = location.match(/(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)/);
             if (coordMatch) {
                 const lat = parseFloat(coordMatch[1]);
                 const lng = parseFloat(coordMatch[2]);
                 if (!isNaN(lat) && !isNaN(lng)) {
                     return { lat, lng };
                 }
             }
             
             return null;
         }
         
         function extractVenueFromLocation(location) {
             if (!location) return null;
             
             // If location contains coordinates, try to extract venue name before coordinates
             const coordMatch = location.match(/^([^0-9-]+)\s*(-?\d+\.?\d*\s*,\s*-?\d+\.?\d*)/);
             if (coordMatch) {
                 return coordMatch[1].trim();
             }
             
             // If no coordinates, return the location as venue name
             return location;
         }
         
         function extractCoverFromDescription(description) {
             if (!description) return null;
             
             // Look for cover charge information
             const coverMatch = description.match(/cover:\s*\$?([^<\n\r]+)/i) ||
                               description.match(/admission:\s*\$?([^<\n\r]+)/i) ||
                               description.match(/price:\s*\$?([^<\n\r]+)/i);
             
             return coverMatch ? coverMatch[1].trim() : null;
         }

         function generateEmojiForEvent(event) {
             const name = (event.name || event.summary || '').toLowerCase();
             const description = (event.description || '').toLowerCase();
             const barName = (event.bar || event.barName || '').toLowerCase();
             
             // Event type based emoji mapping
             if (name.includes('happy hour') || name.includes('social hour')) return 'üç∫';
             if (name.includes('brunch')) return 'ü•û';
             if (name.includes('karaoke')) return 'üé§';
             if (name.includes('drag') || name.includes('bingo')) return 'üíÑ';
             if (name.includes('leather')) return 'üñ§';
             if (name.includes('bear') || name.includes('cub')) return 'üêª';
             if (name.includes('pool') || name.includes('billiards')) return 'üé±';
             if (name.includes('dance') || name.includes('party')) return 'üíÉ';
             if (name.includes('trivia') || name.includes('quiz')) return 'üß†';
             if (name.includes('game')) return 'üé≤';
             if (name.includes('festival') || name.includes('weekend')) return 'üé™';
             if (name.includes('underwear') || name.includes('jock')) return 'ü©≤';
             
             // Bar/venue specific emojis
             if (barName.includes('animal')) return 'ü¶Å';
             if (barName.includes('eagle')) return 'ü¶Ö';
             if (barName.includes('phoenix')) return 'üî•';
             if (barName.includes('stonewall')) return 'üè≥Ô∏è‚Äçüåà';
             
             // Description-based detection
             if (description.includes('bear') || description.includes('cub')) return 'üêª';
             if (description.includes('leather')) return 'üñ§';
             if (description.includes('dance')) return 'üíÉ';
             
             // Default bear emoji for bear community events
             return 'üêª';
         }
         
         function extractNickname(event) {
             const description = event.description || '';
             
             // Look for "Nickname:" in description
             const nicknameMatch = description.match(/nickname:\s*([^\n\r]+)/i);
             if (nicknameMatch) {
                 return nicknameMatch[1].trim();
             }
             
             // Look for "Nick:" in description
             const nickMatch = description.match(/nick:\s*([^\n\r]+)/i);
             if (nickMatch) {
                 return nickMatch[1].trim();
             }
             
             return null;
         }
         
         function generateNickname(eventName) {
             if (!eventName) return 'Event';
             
             // Extract meaningful words and create acronym
             const words = eventName.split(' ')
                 .filter(word => word.length > 2 && !['the', 'and', 'or', 'at', 'in', 'on'].includes(word.toLowerCase()))
                 .slice(0, 3);
             
             if (words.length >= 2) {
                 return words.map(word => word.charAt(0).toUpperCase()).join('');
             }
             
             // Single word - take first 3 characters
             return eventName.substring(0, 3).toUpperCase();
         }
         

         
         function determineEventType(event) {
             const name = (event.name || event.summary || '').toLowerCase();
             const description = (event.description || '').toLowerCase();
             
             if (name.includes('happy hour') || description.includes('happy hour')) return 'Happy Hour';
             if (name.includes('brunch') || description.includes('brunch')) return 'Brunch';
             if (name.includes('drag') || description.includes('drag')) return 'Drag Show';
             if (name.includes('karaoke') || description.includes('karaoke')) return 'Entertainment';
             if (name.includes('social') || description.includes('social')) return 'Social Event';
             if (name.includes('party') || description.includes('party')) return 'Party';
             if (name.includes('festival') || description.includes('festival')) return 'Festival';
             if (name.includes('tournament') || description.includes('tournament')) return 'Tournament';
             if (name.includes('underwear') || description.includes('underwear')) return 'Themed Party';
             if (name.includes('leather') || description.includes('leather')) return 'Themed Night';
             
             return 'Social Event';
         }
         
         function generateRandomNYCCoordinates() {
             // Generate coordinates within NYC area
             const baseLat = 40.7505;
             const baseLng = -73.9934;
             const range = 0.1;
             
             return {
                 lat: baseLat + (Math.random() - 0.5) * range,
                 lng: baseLng + (Math.random() - 0.5) * range
             };
         }
         
         function clearMap() {
             markers.forEach(marker => map.removeLayer(marker));
             markers = [];
             testEvents.length = 0; // Clear the array but keep the reference
             
             // Restore original test events
            testEvents.push(
                {
                    name: "Bear Happy Hour",
                    nickname: "BHH",
                    bar: "The Bear Den",
                    time: "5:00 PM - 8:00 PM",
                    day: "Thursday",
                    cover: "Free",
                    coordinates: { lat: 40.7128, lng: -74.0060 },
                    emoji: "üç∫",
                    eventType: "Happy Hour",
                    website: "https://instagram.com/bearhappyhourny"
                },
                {
                    name: "Leather Night",
                    nickname: "Leather",
                    bar: "Leather & Lace",
                    time: "9:00 PM - 2:00 AM",
                    day: "Friday",
                    cover: "$10",
                    coordinates: { lat: 40.7589, lng: -73.9851 },
                    emoji: "üñ§",
                    eventType: "Themed Night",
                    website: "https://eagle-ny.com"
                },
                {
                    name: "Sunday Funday Brunch",
                    nickname: "SFB",
                    bar: "Rainbow Cafe",
                    time: "11:00 AM - 4:00 PM",
                    day: "Sunday",
                    cover: "Free",
                    coordinates: { lat: 40.7505, lng: -73.9934 },
                    emoji: "ü•û",
                    eventType: "Brunch",
                    website: "https://animal.nyc"
                },
                {
                    name: "Karaoke Night",
                    nickname: "Karaoke",
                    bar: "Sing Along Bar",
                    time: "8:00 PM - 12:00 AM",
                    day: "Wednesday",
                    cover: "$5",
                    coordinates: { lat: 40.7282, lng: -73.9942 },
                    emoji: "üé§",
                    eventType: "Entertainment",
                    website: "https://www.yelp.com"
                },
                {
                    name: "Pool Tournament",
                    nickname: "Pool",
                    bar: "Corner Pocket",
                    time: "7:00 PM - 11:00 PM",
                    day: "Tuesday",
                    cover: "$15",
                    coordinates: { lat: 40.7614, lng: -73.9776 },
                    emoji: "üé±",
                    eventType: "Tournament"
                },
                {
                    name: "Drag Bingo",
                    nickname: "D-Bingo",
                    bar: "Glitter Palace",
                    time: "7:30 PM - 10:30 PM",
                    day: "Monday",
                    cover: "$20",
                    coordinates: { lat: 40.7831, lng: -73.9712 },
                    emoji: "üíÑ",
                    eventType: "Drag Show"
                },
                {
                    name: "Bear Weekend Festival",
                    nickname: "BWF",
                    bar: "Multiple Venues",
                    time: "All Day",
                    day: "Saturday-Sunday",
                    cover: "$50",
                    coordinates: { lat: 40.7410, lng: -74.0014 },
                    emoji: "üêª",
                    eventType: "Festival",
                    website: "https://github.com"
                },
                {
                    name: "Game Night",
                    nickname: "Games",
                    bar: "Board & Brew",
                    time: "6:00 PM - 10:00 PM",
                    day: "Thursday",
                    cover: "Free",
                    coordinates: { lat: 40.7549, lng: -73.9840 },
                    emoji: "üé≤",
                    eventType: "Games"
                }
            );
            
            updateMapMarkers();
            renderEvents();
            
            logger.userInteraction('MAP', 'Map cleared and reset to original events');
        }
    </script>
</body>
</html>