#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

// Resolve project root relative to this script
const ROOT = path.resolve(__dirname, '..');

// Load CITY_CONFIG via Node export
let CITY_CONFIG;
try {
  const cityModule = require(path.join(ROOT, 'js', 'city-config.js'));
  CITY_CONFIG = cityModule.CITY_CONFIG;
} catch (e) {
  console.error('Failed to load CITY_CONFIG from js/city-config.js:', e.message);
  process.exit(1);
}

if (!CITY_CONFIG || typeof CITY_CONFIG !== 'object') {
  console.error('CITY_CONFIG is missing or invalid in js/city-config.js');
  process.exit(1);
}

// Scraper config is stored on CITY_CONFIG[cityKey].scraper
const scraperCities = {};
Object.entries(CITY_CONFIG).forEach(([cityKey, cityConfig]) => {
  if (cityConfig && cityConfig.scraper) {
    scraperCities[cityKey] = cityConfig.scraper;
  }
});

if (Object.keys(scraperCities).length === 0) {
  console.error('No scraper configs found in CITY_CONFIG (missing scraper fields)');
  process.exit(1);
}

const header = [
  '// Bear Event Scraper City Configuration',
  '// This file is generated by tools/generate-scraper-cities.js from js/city-config.js.',
  '// Do not edit this file directly.',
  '//',
  '// USAGE RESTRICTIONS:',
  '// - This is a pure JavaScript configuration file',
  '// - Must export a default cities configuration object',
  '// - Can be imported in both Scriptable and web environments',
  '// - Keep this file environment-agnostic (no Scriptable or DOM APIs)',
  ''
].join('\n');

const exportBlock = [
  '// Export for different environments',
  '// Scriptable environment',
  "if (typeof module !== 'undefined' && module.exports) {",
  '  module.exports = scraperCities;',
  '}',
  '',
  '// ES6 module environment',
  "if (typeof window === 'undefined' && typeof importModule !== 'undefined') {",
  '  // Scriptable environment - make available for importModule',
  '  scraperCities;',
  "} else if (typeof window !== 'undefined') {",
  '  // Browser environment - attach to window',
  '  window.scraperCities = scraperCities;',
  '}',
  '',
  '// Default export for ES6 modules',
  'scraperCities;',
  ''
].join('\n');

const output = `${header}const scraperCities = ${JSON.stringify(scraperCities, null, 2)};\n\n${exportBlock}`;

// Write only if content changes
function writeIfChanged(filePath, content) {
  if (fs.existsSync(filePath)) {
    const existing = fs.readFileSync(filePath, 'utf8');
    if (existing === content) {
      return false;
    }
  }
  fs.writeFileSync(filePath, content);
  return true;
}

const outputPath = path.join(ROOT, 'scripts', 'scraper-cities.js');
const changed = writeIfChanged(outputPath, output);

if (changed) {
  console.log(`✓ Wrote ${path.relative(ROOT, outputPath)}`);
} else {
  console.log(`⏭️  No change for ${path.relative(ROOT, outputPath)}`);
}
